"use strict";let gs_kiri_slice=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.Slice)return;let n=self.kiri,e=n.fill,i=n.fill_fixed,l=self.base,t=l.util,r=l.polygons,o=a.prototype,s=r.fillArea,f=l.newPoint,u=(Math.min,Math.max,l.key.NONE,[15658496,15645440,15632384]),p=[16776960,65535,16711935,16711680,65280,255,16777215,0];function a(n,e){this.z=n,this.index=0,this.lines=null,this.groups=null,this.up=null,this.down=null,this.tops=[],this.view=e,this.bridges=null,this.flats=null,this.solids={poly:null,trimmed:null},this.offsets=null,this.supports=null,this.isSolidFill=!1,this.isSparseFill=!1,this.camMode=null,this.layers=null,this.finger=null,e&&this.addLayers(e)}function h(n){this.poly=n,this.traces=null,this.inner=null,this.fill_lines=null,this.fill_sparse=null,this.solids=null}function c(n,e){if(!(n&&e&&n.length&&e.length))return;let i=e.slice();n:for(let r=0;r<n.length;r+=2){for(let i=0;i<e.length;i+=2)if(t.intersect(n[r],n[r+1],e[i],e[i+1],l.key.SEGINT))continue n;i.push(n[r]),i.push(n[r+1])}for(let n=0;n<i.length;n++)i[n].index=1/0;return i.length>2?i:[]}function d(n,e,i,l,t){if(!n||n.isSolidFill||i<=0)return;let r=e.clone(!0);t&&r.forEach(function(n){n.hintFillAngle()}),n.addSolidFills(r),i>0&&(l?d(n.up,e,i-1,!0,!1):d(n.down,e,i-1,!1,!1))}function g(n,e,i,l,t,r){n.poly(e,i[l%i.length],t,r),t&&e.inner&&e.inner.forEach(function(e){g(n,e,i,l+1,!1,r)})}function y(n,e){return new a(n,e)}n.Top=h,n.newTop=function(n){return new h(n)},n.Slice=a,n.newSlice=y,h.prototype.innerTraces=function(){let n=this.traces,e=[];return n&&n.forEach(function(n){n.inner&&e.appendAll(n.inner)}),e},h.prototype.clone=function(n){return new h(this.poly.clone(n))},h.prototype.gatherOuter=function(n){return this.traces.forEach(function(e){0===e.depth&&n.append(e)}),n},o.clone=function(n){let e=y(this.z,this.view);return this.tops.forEach(function(i){e.addTop(i.poly.clone(n))}),e},o.fingerprint=function(){return this.finger?this.finger:this.finger=r.fingerprint(this.gatherTopPolys([]))},o.fingerprintSame=function(n){return!!n&&r.fingerprintCompare(this.fingerprint(),n.fingerprint())},o.addLayers=function(e){function i(){return n.newLayer(e)}this.layers||(this.layers={outline:i(),trace:i(),bridge:i(),flat:i(),solid:i(),fill:i(),sparse:i(),support:i()})},o.mergeTop=function(n){let e,i,l=this.tops;for(i=0;i<l.length;i++)if(e=n.union(l[i].poly))return l[i].poly=e,l[i];return this.addTop(n)},o.addTop=function(n){let e=new h(n);return this.tops.push(e),e},o.gatherTopPolys=function(n){return this.tops.forEach(function(e){n.push(e.poly)}),n},o.gatherTopPolyInners=function(n){return this.tops.forEach(function(e){e.poly.inner&&n.appendAll(e.poly.inner)}),n},o.gatherTraces=function(n){return this.tops.forEach(function(e){n.appendAll(e.traces)}),n},o.gatherInner=function(n){return this.tops.forEach(function(e){n.appendAll(e.inner)}),n},o.gatherSolids=function(n){return this.tops.forEach(function(e){n.appendAll(e.solids)}),n},o.gatherFillLines=function(n){return this.tops.forEach(function(e){e.fill_lines&&n.appendAll(e.fill_lines)}),n},o.invalidateSolids=function(){let n=this.solids;n.poly=[],n.trimmed=null},o.invalidateSupports=function(){this.supports=null},o.renderOutline=function(e,i){if(!this.view)return;n.driver.CAM.process;let l=this,t=l.layers.outline,r=p,o=l.groups?l.groups.sort(function(n,e){return e.area()-n.area()}):null,s=l.tops,f=0;switch(t.clear(),e%5){case 0:if(!l.lines)return;l.lines.forEach(function(n){let e=[n.p1,n.p2];t.lines(e,r[f++%r.length]),t.points(e,0,.1)});break;case 1:if(!o)return;o.forEach(function(n){g(t,n,r,f++,!1,!0)});break;case 2:if(!o)return;o.forEach(function(n){g(t,n,r,f++,!1,!1)});break;case 3:s.forEach(function(n){g(t,n.poly,r,0,!0,!1)});break;case 4:s.forEach(function(n){t.poly(n.poly,u[i],!0,!1),n.inner&&t.poly(n.inner,14540253,!0)})}t.render()},o.doShells=function(n,e,i,l,t){let o=this,f=t||{};o.tops.forEach(function(t){let u=[t.poly];o.index,f.vase&&(t.poly=t.poly.clone(!1)),t.traces=[],t.inner=[];let p=[],a=t.poly.getZ();if(f.thin&&(t.thin_fill=[]),n)if(0===e&&1===n)p=u.clone(!0),t.traces=p;else if(f.thin){let l=2*e,o=2*i;r.expand2(u,-e,-i,t.traces,n,function(e,i){p=e,e.forEach(function(e){e.depth=n-i,e.inner&&e.inner.forEach(function(e){e.depth=-(n-i)})})},function(n,e,f,u){if(e){let l=r.nest(r.flatten([].appendAll(n).appendAll(e)).clone()),f=r.expand(l,-u,a,null,1),p=s(f,45,i,[],u/2,o),h=s(f,135,i,[],u/2,o);t.thin_fill.appendAll(c(p,h))}else{let o=r.nest(r.flatten([].appendAll(n).appendAll(e)).clone()),f=r.expand(o,-u,a,null,1),p=s(f,45,i,[],0,l),h=s(f,135,i,[],0,l);t.thin_fill.appendAll(c(p,h))}},a)}else r.expand(u,-e,a,t.traces,n,-i,function(e,i){p=e,e.forEach(function(e){e.depth=n-i,e.inner&&e.inner.forEach(function(e){e.depth=-(n-i)})})});else p=[t.poly];l&&p.length>0&&p.forEach(function(n){r.trace2count(n,t.inner,l,1,0)})})},o.renderShells=function(e){let i=this.layers.trace;n.driver.CAM.process;i.clear(),this.tops.forEach(function(n){n.traces&&i.poly(n.traces,0,!0,null),n.polish&&(i.poly(n.polish.x,8912896,!0,null),i.poly(n.polish.y,8912896,!0,null))}),i.render()},o.invalidateFill=function(){this.tops.forEach(function(n){n.fill_lines=null,n.fill_sparse=null})},o.doThinWallDetection=function(n){this.tops.forEach(function(n){n.inner&&n.inner.length})},o.doSolidLayerFill=function(n,e){this.isSolidFill=!1,0!==this.tops.length&&"number"==typeof e&&(this.tops.forEach(function(i){i.inner&&i.inner.length>0?i.fill_lines=s(i.inner,e,n,null):i.fill_lines=null}),this.isSolidFill=!0)},o.renderSolidFill=function(){let n=this.layers.fill;n.clear(),this.tops.forEach(function(e){e.fill_lines&&n.lines(e.fill_lines,3355443)}),n.render()},o.doSparseLayerFill=function(n){let l=n.process,t=n.spacing,o=n.density,s=n.bounds,u=n.height,p=n.type||"hex";if(this.isSparseFill=!1,0===this.tops.length||0===o||this.isSolidFill)return;let a,h=this,c=h.tops,d=h.down,g=self.ClipperLib,y=g.ClipType,E=g.PolyType,_=g.PolyFillType,S=new g.Clipper,T=new g.PolyTree,b=[],m=[],w=[],A=[],F={slice:function(){return h},options:function(){return n},lineWidth:function(){return n.lineWidth},bounds:function(){return s},zIndex:function(){return h.index},zValue:function(){return h.z},zHeight:function(){return u},offset:function(){return t},density:function(){return o},emit:function(n,e){isNaN(n)?A.push(n):(w.push(f(n,e,h.z)),h.isSparseFill=!0)},newline:function(){w.length>0&&(m.push(w),w=[])}};p&&e[p]&&e[p](F),F.newline(),c.forEach(function(n){n.fill_sparse=[],b.appendAll(n.inner),b.appendAll(n.solids)}),h._fill_finger=r.fingerprint(b);let z=!1;if(!!i[p]&&h.fingerprintSame(d)&&d._fill_finger&&r.fingerprintCompare(h._fill_finger,d._fill_finger)){for(let n=0;n<c.length;n++)d.tops[n].fill_sparse?c[n].fill_sparse=d.tops[n].fill_sparse.map(n=>n.clone().setZ(h.z)):z=!0;if(!z)return}let P=h.isSparseFill;A.length&&c.forEach(e=>{if(!e.inner)return;let i=e.inner.slice();e.solids&&(i=r.subtract(i,e.solids,[],null,h.z));let t=l.sliceFillAngle*(h.index%2+1);A.forEach(l=>{let o=[],s=[];if(i.forEach(n=>{let e=l.mask(n);e&&e.length&&o.appendAll(e)}),o.length&&r.expand(o,-n.lineWidth/2,h.z,s),o.length&&(h.isSparseFill=!0,e.fill_lines||(e.fill_lines=[]),o.forEach(n=>{n.forEachSegment((n,i)=>{e.fill_lines.push(n,i)})})),s.length){let i=r.fillArea(s,t,n.lineWidth);e.fill_lines.appendAll(i)}})}),P&&(S.AddPaths(m,E.ptSubject,!1),S.AddPaths(r.toClipper(b),E.ptClip,!0),S.Execute(y.ctIntersection,T,_.pftNonZero,_.pftEvenOdd)&&T.m_AllPolys.forEach(function(n){a=r.fromClipperNode(n,h.z),c.forEach(function(n){a.isInside(n.poly)&&n.fill_sparse.push(a)})}))},o.renderSparseFill=function(){let n=this.layers.sparse;n.clear(),this.tops.forEach(function(e){e.fill_sparse&&e.fill_sparse.forEach(function(e){e.length>1&&e.render(n,3355494,!1,!0)})}),n.render()},o.doDiff=function(n,e,i){let l=this.down;if(!l){if(!i)return;l=y(-1)}let t=this,o=l;t.bridges=null,o.flats=null;let s=e?t.gatherTopPolys([]):t.gatherInner([]),f=e?o.gatherTopPolys([]):o.gatherInner([]),u=[],p=[];if(this.fingerprintSame(o))return t.bridges=u,void(o.flats=p);r.subtract(s,f,u,p,this.z,n),e?(t.bridges=[],o.flats=[],r.expand(u,e,t.z,t.bridges,1,null,null,1e-4),r.expand(p,e,t.z,o.flats,1,null,null,1e-4)):(t.bridges=u,o.flats=p)},o.renderDiff=function(){let n=this,e=n.layers,i=e.bridge,l=e.flat,t=n.bridges,r=n.flats;i.clear(),l.clear(),t&&t.forEach(function(e){e.setZ(n.z),e.render(i,39406,!0),e.renderSolid(i,43775)}),r&&r.forEach(function(e){e.setZ(n.z),e.render(l,15597721,!0),e.renderSolid(l,16711850)}),i.renderSolid(),i.render(),l.renderSolid(),l.render()},o.addSolidFills=function(n){this.solids.poly&&this.solids.poly.appendAll(n)},o.projectFlats=function(n){!this.isSolidFill&&this.down&&this.flats&&d(this,this.flats,n,!1,!0)},o.projectBridges=function(n){!this.isSolidFill&&this.up&&this.bridges&&d(this,this.bridges,n,!0,!0)},o.doSolidsFill=function(n,e,i){let l=i||1,t=this,o=t.tops,f=t.solids,u=r.union(f.poly),p=void 0===n&&void 0===e;if(0===f.length)return!1;if(0===u.length)return!1;let a,h=[],c=p?t.gatherTopPolys([]):t.gatherInner([]);return u.forEach(function(n){n.setZ(t.z),c.forEach(function(e){n.del||(a=n.mask(e))&&a.length>0&&(n.del=!0,h.appendAll(a))})}),f.unioned=u,f.trimmed=h,o.forEach(function(n){n.solids=[]}),h.forEach(function(n){o.forEach(function(e){if(e.poly.overlaps(n)&&(!n.parent||n.parent.area()>e.poly.area())){if(n.areaDeep()<l)return;n.parent=e.poly,e.solids.push(n)}})}),!!p||(o.forEach(function(i){i.fill_lines=i.thin_fill||[];let l=[],t=[];h.forEach(function(n){n.parent===i.poly&&(n.fillang?t.push(n):l.push(n))}),l.length>0&&(s(l,e,n,i.fill_lines),i.fill_lines_norm={angle:e,spacing:n}),t.length>0&&(i.fill_lines_ang={spacing:n,list:[],poly:[]},t.forEach(function(e){s([e],e.fillang.angle+45,n,i.fill_lines),i.fill_lines_ang.list.push(e.fillang.angle+45),i.fill_lines_ang.poly.push(e.clone())}))}),!0)},o.doThinFill=function(n,e){return this.tops.forEach(function(n){n.thin_fill&&n.thin_fill.length>0&&(n.fill_lines?n.fill_lines.appendAll(n.thin_fill):n.fill_lines=n.thin_fill)}),!0},o.renderSolidOutlines=function(){let n=this.layers.solid,e=this.solids.trimmed;n.clear(),e&&e.forEach(function(e){e.render(n,52224,!0),e.renderSolid(n,56576,!0)}),n.renderSolid(),n.render()},o.doSupport=function(n,e,i,t,o,s,f){let u=t||.1,p=o||2,a=this,h=a.gatherTopPolys([]),c=h;if(i&&r.expand(h,i,a.z,c=[]),r.expand(h,s,a.z,a.offsets=[]),!a.down)return;let d=r.flatten(a.gatherTraces([])),g=a.gatherFillLines([]),y=[],E=a.down,_=E.gatherTopPolys([]),S=r.flatten(E.gatherTraces([]));function T(e){for(let n=0;n<y.length;n++)if(e.distTo2D(y[n])<p/4)return;let i=e.isInPolygonOnly(_);i||S.forEach(function(l){return l.forEachSegment(function(l,t){if(e.distToLine(l,t)<=n)return i=!0}),i}),i||y.push(e)}function b(n,i,l){let t,r=1;if((t=n.distTo2D(i))>=e){let l=n.slopeTo(i).factor(1/t),o=Math.floor(t/e)+1,s=t/o;for(;r<o;)T(n.projectOnSlope(l,r++*s))}l&&T(i)}d.forEach(function(n){n.forEachSegment(function(n,e){b(n,e,!0)})});let m=[];if(g.forEachPair(function(n,e){b(n,e,!1)}),!y.length&&!m.length)return;let w=[];y.forEach(function(n){w.push(l.newPolygon().centerRectangle(n,p/2,p/2))}),w=r.union(w).forEach(function(n){m.push(l.newPolygon().createConvexHull(n.points))}),m=r.union(m),m=r.trimTo(m,c);let A=0;for(;E&&m.length>0;){E.supports=E.supports||[];let n=[],e=[];if(r.subtract(m,E.gatherTopPolys([]),n,null,a.z,u),n.forEach(function(n){n.area()<.1||e.push(n.setZ(E.z))}),0===e.length)break;A>=f&&E.supports.appendAll(e),m=e,E=E.down,A++}},o.doSupportFill=function(n,e,i){let l=this,t=l.supports,o=[],f=[],u=i||.1;t&&(t=r.union(t),r.subtract(t,l.offsets,o,null,l.z,u),t=o,l.down&&(r.subtract(o,l.down.offsets,f,null,l.z,u),t=f),t&&t.forEach(function(i){let l=i.bounds.width()/i.bounds.height()>1?90:0,t=n*(1/e),o=[];return r.trace2count(i,o,n/4,1,0),o.length>0&&s(o,l,t,i.fills=[]),!0}),l.supports=t)},o.renderSupport=function(){let n=this.layers.support,e=this.supports;n.clear(),e&&e.forEach(function(e){n.poly(e,16711680,!0),n.lines(e.fills,16711680)}),n.render()},o.findClosestPointTo=function(n){let e,i;return this.tops.length?this.tops.forEach(function(l){i=l.poly.findClosestPointTo(n),(!e||i.distance<e.distance)&&(e=i)}):this.supports&&this.supports.forEach(function(l){i=l.findClosestPointTo(n),(!e||i.distance<e.distance)&&(e=i)}),e}}();