"use strict";let gs_kiri_sla=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),self.kiri.driver.SLA)return;let e,t,l,s,i=self.kiri,n=self.base,r=(n.debug,n.util,n.config,n.polygons),a=(i.driver.SLA={slice:function(i,h,c,d){let g,w,y=i.process;i.device;if(f&&!self.OffscreenCanvas)return d("browser lacks support for OffscreenCanvas",!0);function m(e,t){c(.25+(g-w)/g*.75,t),w-=e}function b(e,t,l,s){e.forEach(function(i,n){l(i,n),m(t/e.length,s)})}let U=atob(currentSnap),x=Uint8Array.from(U,e=>e.charCodeAt(0)),v=(new png.PNG).parse(x,(s,i)=>{e=v,t=S(v,200,125),l=S(v,400,300)}),D=y.slaSlice||.05;a.sliceWidget(h,{height:D,add:!y.slaOpenTop},function(e){let t=e[e.length-1];if(e=h.slices=e.filter(e=>e.tops.length),y.slaOpenTop||e.push(t),y.slaSupportEnable&&y.slaSupportLayers){let t,l=y.slaSupportLayers,s=D/2,i=[],n=[],a=y.slaSupportGap,f=D,u=1-l*f,c=(e.forEach(e=>{n.appendAll(e.tops.map(e=>e.poly.clone()))}),r.union(n).map(e=>e.clone())),d=r.expand(c,u,s,[],1);for(let e=0;e<l+a;e++){let n=p(s);n.height=D,n.index=i.length,e<l&&(n.synth=!0,d.forEach(e=>{n.tops.push(o(e.clone(!0).setZ(s)))}),d=r.expand(d,f,s,[],1),t=n),i.push(n),s+=D}s-=D/2,e=h.slices=i.concat(e.map(e=>(e.tops.forEach(t=>t.poly.setZ(e.z+s)),e.index+=i.length,e.z+=s,e))),h.union=c,h.lastraft=t}for(let t=1;t<e.length;t++)e[t-1].up=e[t],e[t].down=e[t-1];e.forEach(function(e){e.invalidateFill(),e.invalidateSolids(),e.invalidateSupports(),e.isSolidFill=!1});let l=Math.round(y.slaShell/y.slaSlice);g=[5,10,l?10:0,l?10:0,l?0:10,y.slaFillDensity&&y.slaShell?60:0,y.slaSupportEnable&&y.slaSupportLayers&&y.slaSupportDensity?100:0].reduce((e,t)=>e+t),w=g,b(e,5,(e,t)=>{y.slaShell?e.doShells(2,0,y.slaShell):e.doShells(1,0)},"slice"),b(e,10,e=>{e.synth||e.doDiff(1e-6,.005,!y.slaOpenBase)},"delta"),l?(b(e,10,e=>{e.synth||(e.projectFlats(l),e.projectBridges(l))},"project"),b(e,10,e=>{if(e.synth)return;e.doSolidsFill(void 0,void 0,.001);let t=r.nest(r.flatten(e.gatherTraces([]))),l=e.solids.trimmed||[];t.appendAll(l);let s=r.union(t);e.solids.unioned=s},"solid")):b(e,10,e=>{e.synth||(e.solids.unioned=e.gatherTopPolys([]))},"solid"),y.slaFillDensity&&y.slaShell&&(s=[],b(e,60,e=>{e.synth||function(e,t){let l=t.process,i=(t.device,e.solids.unioned,t.bounds),a=i.max.x-i.min.x,o=i.max.y-i.min.y,p=(Math.max(a,o),Math.round(l.slaFillLine/l.slaSlice)),h=l.slaFillLine,f=a/h*l.slaFillDensity,u=o/h*l.slaFillDensity,c=a/f,d=o/u,g=-a/2,w=-o/2,y=a/2,m=o/2,b=[],U=Math.floor(e.index/p)%4,S=s[U];if(!S&&1!==U)for(let t=g;t<y;t+=c)b.push(n.newPolygon().centerRectangle({x:t+c/2,y:0,z:e.z},h,o));if(!S&&3!==U)for(let t=w;t<m;t+=d)b.push(n.newPolygon().centerRectangle({x:0,y:t+d/2,z:e.z},a,h));S?b=S.slice().map(t=>t.clone(!0).setZ(e.z)):(b=r.union(b),s[U]=b);b=r.trimTo(b,e.tops.map(e=>e.poly)),b=r.union(e.solids.unioned.appendAll(b)),e.solids.unioned=b}(e,i)},"infill")),y.slaSupportEnable&&y.slaSupportLayers&&y.slaSupportDensity&&function(e,t,l){e.union.reduce((e,t)=>e+t.areaDeep(),0),e.union.reduce((e,t)=>e+t.perimeter(),0);let s=e.slices,i=(s.length,0),n=0,a=s.filter(e=>!e.synth);a.forEach(e=>{e.mass=e.solids.unioned.reduce((e,t)=>e+t.areaDeep(),0),e.up&&e.up.bridges?(e.bear=e.up.bridges.reduce((e,t)=>e+t.areaDeep(),0),e.bear_up=e.up.bridges,n+=e.bear):e.bear=0,i+=e.mass});let o,p=i/n*(1/t.slaSupportDensity);a.slice().map((e,t)=>(!o&&e.bear&&(e.ord_first=o=!0),e.ord_weight=Math.pow(30,(a.length-t)/a.length),e)).sort((e,t)=>e.ord_first?-1:t.ord_first?1:t.bear*t.ord_weight-e.bear*e.ord_weight).forEach((e,t)=>{e.ord_bear=t});let h=i,f=n;a.forEach(e=>{e.rem_mass=h,e.rem_bear=f,e.can_bear=e.bear*p,h-=e.mass,f-=e.bear});let c=a.sort((e,t)=>e.ord_bear-t.ord_bear);h=i,f=n;for(let e=0;e<c.length;e++){let t=c[e],l=Math.min(t.can_bear,t.rem_mass);for(let e=t.index-1;e>a[0].index;e--)s[e].rem_mass-=l;if(h-=l,t.can_emit=!0,h<=0)break}let d=0,g=0,w=10*(1-t.slaSupportDensity),y=Math.bound(t.slaSupportSize/2,.25,1);s.forEach((e,i)=>{e.can_emit&&(0===d||e.index-g>5?(e.bear_up.map(t=>t.clone(!0).setZ(e.z)).forEach(l=>{!function(e,t,l,s,i){let n=l.circularityDeep()>.1,r=[l];for(;r.length;){l=r.shift();let a=[],o=[],p=(l.perimeter(),0),h=l.clone(!0).flattenTo([]);for(h.forEach(e=>e.forEachSegment((e,l)=>{let s={dist:e.distTo2D(l),p1:e,p2:l};(s.dist>=i||t.ord_first)&&p++,o.push(s)})),o.sort((e,t)=>t.dist-e.dist);o.length&&(p>0||a.length<3);){let{dist:e,p1:t,p2:l}=o.shift();if(e>=i){let s=Math.ceil(e/i)+1,n=e/s,r=t;for(;s-- >=0;)a.push(r),r=r.offsetPointTo(l,n);p--}else a.push(t.offsetPointTo(l,e/2))}if(!t.ord_first)e:for(let e=0;e<a.length;e++){for(let t=e+1;t<a.length;t++)if(a[e].distTo2D(a[t])<=s){a[e]=null;continue e}t.pillars&&t.pillars.forEach(t=>{a[e]&&a[e].distTo2D(t.point)<=s&&(a[e]=null)})}a.filter(e=>null!==e).forEach(l=>{let i=u(e,t,l,s,[]);i.length&&!(i.max||i.synth||i.merged)&&i.forEach(e=>{let t=e.slice.supports,l=t.indexOf(e.pillar);l>=0&&t.splice(l,1)})}),n&&l.offset(Math.max(.2,1-e.slaSupportDensity),r)}}(t,e,l,y,w)}),d++):d>5?d=0:d++,g=e.index),l(1/s.length)}),s.forEach(e=>{e.supports&&(e.supports=r.union(e.supports,0))})}(h,y,e=>{m(100*e,"support")}),d()},function(e){return c(0+.25*e)})},sliceRender:function(e){e.slices.forEach(e=>{let t=e.layers,l=t.outline,s=t.support;e.solids.unioned?e.solids.unioned.forEach(e=>{e=e.clone(!0),l.poly(e,65793,!0),l.solid(e,39372)}):e.tops&&e.tops.forEach(e=>{let t=e.poly;l.poly(t,65793,!0,!1),l.solid(t,16562691)}),e.supports&&e.supports.forEach(e=>{s.poly(e,65793,!0,!1),s.solid(e,16562691)}),e.renderDiff(),e.renderSolidOutlines(),l.renderAll(),s.renderAll()})},printSetup:function(e,t){t(1)},printExport:function(e,s,i){let n=e.widgets,r=e.settings,a=r.device,o=r.process,p=(e.output,0),h=2560/a.bedWidth,u=1440/a.bedDepth,c=Date.now(),w=o.slaAntiAlias||1,y=[],m=[],b=[],U=f||w>1,S=U?.25:.85,x=U?.75:.15,v=8/w;for(let e=0;e<w;e++)y.push((1<<8-e*v)-1);n.forEach(e=>{p=Math.max(e.slices.length)});let D,F=U?renderLayer:renderLayerWasm;for(let e=0;e<p;e++){let t={index:e,width:2560,height:1440,widgets:n,scaleX:h,scaleY:u,masks:y},{image:l,layers:i,end:r}=F(t);if(m.push(l),b.push(i),s({progress:e/p*S,message:"image_gen",data:l}),r)break}switch(a.deviceName){case"Anycubic.Photon":D=d;break;case"Anycubic.Photon.S":D=g}let L=D(e,{width:2560,height:1440,small:t.data,large:l.data,lines:m,slices:b},(e,t)=>{s({progress:e*x+S,message:t})});i({width:2560,height:1440,file:L},[L]),console.log("print.export",Date.now()-c)},printDownload:function(e){let{API:t,lines:l,done:s}=e.sla,i=`print-${(new Date).getTime().toString(36)}`;t.ajax("/kiri/output-sla.html",n=>{t.ui.print.innerHTML=n;let r=e.settings,a=r.process,o=r.device,p=a.slaBaseLayers*a.slaBaseOn+(l.length-a.slaBaseLayers)*a.slaLayerOn;for(let e=0;e<l.length;e++){let t=a.slaPeelDist,l=a.slaPeelLiftRate,s=a.slaPeelDropRate,i=a.slaLayerOff;e<a.slaBaseLayers&&(t=a.slaBasePeelDist,l=a.slaBasePeelLiftRate,i=a.slaBaseOff),p+=t*l/60,p+=t*s/60,p+=i}let h=Math.floor(p/60),f=Math.floor(h/60),u=$("print-photon");switch(p-=60*h,h-=60*f,p=Math.round(p).toString().padStart(2,"0"),h=h.toString().padStart(2,"0"),f=f.toString().padStart(2,"0"),$("print-filename").value=i,$("print-layers").value=l.length,$("print-time").value=`${f}:${h}:${p}`,$("print-close").onclick=t.modal.hide,o.deviceName){case"Anycubic.Photon":u.innerText+=" .photon",u.onclick=(()=>{c(t,s.file,".photon")});break;case"Anycubic.Photon.S":u.innerText+=" .photons",u.onclick=(()=>{c(t,s.file,".photons")})}let d=$("print-canvas"),g=d.getContext("2d"),w=g.createImageData(s.height,s.width),y=new DataView(w.data.buffer),m=$("print-range");m.value=0,m.min=0,m.max=l.length-1,m.oninput=function(){let e=new DataView(l[m.value].buffer);for(let t=0;t<e.byteLength;t++)y.setUint32(4*t,e.getUint8(t));g.putImageData(w,0,0),$("print-layer").innerText=m.value.padStart(4,"0")},m.oninput(),t.modal.show("print")})},printRender:function(e){let t=e.widgets,l=e.settings;l.device,l.process;for(let l=0;;l++){let s=i.newLayer(e.group),n=0;if(t.forEach(e=>{let t=e.slices[l];if(!t)return;n++;let i=t.solids.unioned;i||(i=t.tops.map(e=>e.poly)),t.supports&&i.appendAll(t.supports),i.forEach(t=>{t=t.clone(!0).move(e.track.pos),s.poly(t,65793,!0),s.solid(t,39372)})}),s.renderSolid(),s.render(),0===n)return;e.printView.push(s)}}},i.slicer),o=i.newTop,p=i.newSlice,h=(n.newPoint,n.newPolygon),f=!1;function u(e,t,l,s,i){t.supports||(t.supports=[]),t.pillars||(t.pillars=[]);let n=e.slaSupportPoints,r=h().centerCircle(l,s/2,n,!0).setZ(t.z),a=e.slaSupportSize,o=e.slaSlice/2,p=!1,f=[],c=[],d=t.index<e.slaSupportGap+e.slaSupportLayers;if(i.min=i.min?Math.min(i.min,s):s,i.max=!!i.max||s>=a,i.synth=i.synth||t.synth,t.tops.forEach(e=>{i.length>3&&l.isInPolygon(e.poly)&&(p=!0),r.points.forEach(t=>{t.isInPolygon(e.poly)?f.push(t):c.push(t)})}),p){if(!t.synth&&i.max){let e=i.min;for(;i.length;){let t=i.pop(),l=h().centerCircle(t.point,e/2,n,!0).setZ(t.slice.z),s=t.slice.supports.indexOf(t.pillar);if(s>=0&&(t.slice.supports[s]=l,e+=o),e>t.size)break}}return i}let g=l;if(f.length){if(c.length){let e=0,s=0;c.forEach(t=>{e+=t.x,s+=t.y}),e/=c.length,s/=c.length,g=l.offsetPointTo({x:e,y:s,z:t.z},o)}i.max&&(s-=o)}else i.max&&!d||(s+=o,d&&(a+=e.slaSupportGap*e.slaSlice*2));return s<i.min?i:(t.supports.push(r),t.pillars.push({point:l,pillar:r,size:s}),i.push({slice:t,point:l,pillar:r,size:s}),t.down&&u(e,t.down,g,Math.min(s,a),i),i)}function c(e,t,l){saveAs(new Blob([t],{type:"application/octet-stream"}),$("print-filename").value+l),e.modal.hide()}function d(e,t,l){let s,i=e.settings,n=i.process,r=(i.device,t.width,t.height,t.lines.length),a=t.small,o=t.large,p=t.slices,h=n.slaAntiAlias||1,u=[];if(f||h>1){let e=8/h;for(let t=0;t<h;t++)u.push((1<<8-t*e)-1);let i=0,n=t.lines.length*h;s=w(t.lines.map((e,t)=>{let s=e.length,r=new DataView(e.buffer),a=new Uint8Array(e.length),o=new DataView(a.buffer),p=[{data:a,view:o}];for(let e=1;e<h;e++)a=a.slice(),o=new DataView(a.buffer),p.push({data:a,view:o});for(let e=0;e<h;e++){let t=p[e].view,a=u[e];for(let e=0;e<s;e++){let l=r.getUint8(e);t.setUint8(e,l/h&a?1:0)}l(i++/n*.4,"layer_convert")}return{subs:p}}),"photon",e=>{l(.4*e+.4,"layer_encode")})}else{let e=p.reduce((e,t)=>e+t.reduce((e,t)=>e+t.length,0),0);s={layers:p.map(e=>({sublayers:e})),length:e}}let c=3e3+s.length+r*h*28+a.byteLength+o.byteLength,d=new ArrayBuffer(c),g=new DataWriter(new DataView(d)),y=n.slaBaseLayers*n.slaBaseOn+(s.layers.length-n.slaBaseLayers)*n.slaLayerOn;g.writeU32(419495186),g.writeU32(2,!0),g.writeF32(68.04,!0),g.writeF32(120.96,!0),g.writeF32(150,!0),g.skip(12),g.writeF32(n.slaSlice,!0),g.writeF32(n.slaLayerOn,!0),g.writeF32(n.slaBaseOn,!0),g.writeF32(n.slaLayerOff,!0),g.writeU32(n.slaBaseLayers,!0),g.writeU32(1440,!0),g.writeU32(2560,!0);let m=g.skip(4),b=g.skip(4);g.writeU32(r,!0);let U=g.skip(4);g.writeU32(y,!0),g.writeU32(1,!0);let S=g.skip(4),v=g.skip(4);g.writeU32(h,!0),g.writeU16(255,!0),g.writeU16(255,!0);let D=g.pos;g.view.setUint32(S,g.pos,!0),g.writeF32(n.slaBasePeelDist,!0),g.writeF32(60*n.slaBasePeelLiftRate,!0),g.writeF32(n.slaPeelDist,!0),g.writeF32(60*n.slaPeelLiftRate,!0),g.writeF32(60*n.slaPeelDropRate,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeU32(n.slaBaseLayers,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.writeF32(0,!0),g.view.setUint32(v,g.pos-D,!0),g.view.setUint32(b,g.pos,!0);let F=s.layers,L=[];for(let e=0;e<h;e++)for(let t=0;t<F.length;t++){let l=F[t].sublayers[e];g.writeF32(n.slaFirstOffset+n.slaSlice*t,!0),g.writeF32(t<n.slaBaseLayers?n.slaBaseOn:n.slaLayerOn,!0),g.writeF32(t<n.slaBaseLayers?n.slaBaseOff:n.slaLayerOff,!0),L.push(l.repos=g.skip(4)),g.writeU32(l.length,!0),g.skip(16)}let E=0,k=F.length*h;for(let e=0;e<h;e++)for(let t=0;t<F.length;t++){let s=F[t].sublayers[e];g.view.setUint32(s.repos,g.pos,!0);for(let e=0;e<s.length;e++)g.writeU8(s[e],!1);l(E++/k*.1+.9,"layer_write")}return g.view.setUint32(m,g.pos,!0),x({width:400,height:300,data:t.large},g),g.view.setUint32(U,g.pos,!0),x({width:200,height:125,data:t.small},g),d}function g(e,t,l){let s,i=e.settings,n=i.process,r=(i.device,t.width),a=t.height,o=t.slices,p=t.lines.length;if(f){s=w(t.lines.map((e,s)=>{let i=e.length/4,r=new Uint8Array(e.length/4),a=new DataView(r.buffer),o=new DataView(e.buffer);for(let e=0;e<i;e++)a.setUint8(e,o.getUint8(4*e)>0?1:0);return l(s/t.lines.length),{subs:[{exposureTime:n.slaLayerOn,data:r}]}}),"photons")}else{let e=o.reduce((e,t)=>e+t.reduce((e,t)=>e+t.length,0),0);s={layers:o.map(e=>({sublayers:e})),length:e}}let h=new ArrayBuffer(75366+s.length+28*p),u=new DataView(h),c=0;u.setUint32(0,2,!1),u.setUint32(4,3227560,!1),u.setUint32(8,824633720,!1),u.setUint16(12,10,!1),u.setFloat64(14,n.slaSlice,!1),u.setFloat64(22,n.slaLayerOn,!1),u.setFloat64(30,n.slaLayerOff,!1),u.setFloat64(38,n.slaBaseOn,!1),u.setUint32(46,n.slaBaseLayers,!1),u.setFloat64(50,n.slaPeelDist,!1),u.setFloat64(58,n.slaPeelLift,!1),u.setFloat64(66,n.slaPeelDrop,!1),u.setFloat64(74,69420,!1),u.setUint32(82,224,!1),u.setUint32(86,42,!1),u.setUint32(90,168,!1),u.setUint32(94,10,!1),u.setUint32(75362,p,!1),c=75366;for(let e=0;e<p;e++){let t=s.layers[e].sublayers[0],i=t.length;u.setUint32(c+0,69420,!1),u.setFloat64(c+4,0),u.setUint32(c+12,a,!1),u.setUint32(c+16,r,!1),u.setUint32(c+20,8*i+32,!1),u.setUint32(c+24,2684702720,!1),c+=28;for(let e=0;e<i;e++)u.setUint8(c+e,t[e],!1);c+=i,l(e/p/2+.5)}return h}function w(e,t,l){let s=[],i=0,n=0,r=0;e.forEach(e=>{e.subs.forEach(e=>n++)});for(let a=0;a<e.length;a++){let o=e[a].subs,p=[],h=0;for(let e=0;e<o.length;e++){let s=y(o[e].data,t);if(h+=s.length,p.push(s),l&&l(r++/n),"photons"==t)break}i+=h,s.push({sublength:h,sublayers:p})}return{length:i,layers:s}}function y(e,t){let l="photons"===t?128:125,s=e[0],i=1,n=[];for(let r=1;r<e.length;r++){let a=e[r];a!==s?(n.push(m(s,i,t)),s=a,i=1):i===l?(n.push(m(s,i,t)),i=1):i++}return i>0&&n.push(m(s,i,t)),n}function m(e,t,l){switch(l){case"photon":return 127&t|e<<7&128;case"photons":return(1&--t?128:0)|(2&t?64:0)|(4&t?32:0)|(8&t?16:0)|(16&t?8:0)|(32&t?4:0)|(64&t?2:0)|e}}function b(e,t,l){let s=4*(t+e.width*l),i=e.data;return[i[s++],i[s++],i[s++],i[s++]]}function U(e,t,l,s,i){let n,r,a,o,p=[0,0,0,0],h=0;for(n=t;n<s;n++)for(r=l;r<i;r++){for(o=b(e,n,r),a=0;a<4;a++)p[a]+=o[a];h++}for(a=0;a<4;a++)p[a]=Math.abs(p[a]/h);return p}function S(e,t,l){let s,i,n,r,a,o,p,h,f,u=t,c=l,d=e.width/e.height,g=new Uint8Array(u*c*4);d>4/3?(s=e.height/c,i=Math.round((e.width-u*s)/2),n=0):(s=e.width/u,i=0,n=Math.round((e.height-c*s)/2));for(let t=0;t<c;t++)if(!((o=Math.round(t*s+n))<0||o>e.height)){p=Math.round((t+1)*s+n);for(let l=0;l<u;l++)(r=Math.round(l*s+i))<0||r>e.width||(h=4*(t*u+l),f=U(e,r,o,a=Math.round((l+1)*s+i),p),g[h+0]=f[0],g[h+1]=f[1],g[h+2]=f[2],g[h+3]=f[3])}return{width:t,height:l,data:g,png:e}}function x(e,t){let l=new Uint8Array(e.data),s=l.byteLength;t.writeU32(e.width,!0),t.writeU32(e.height,!0);let i=t.skip(4);t.writeU32(s/2,!0),t.view.setUint32(i,t.pos,!0);let n=0;for(;n<s;){let e=l[n++],s=l[n++],i=l[n++],r=(l[n++],(e/4&31)<<11|(s/4&31)<<6|(i/4&31)<<0);t.writeU16(r,!0)}}if(f&&console.log("SLA Driver in Legacy Mode"),!self.window){function v(e,t,l){let{scaleX:s,scaleY:i,width:n,height:r,width2:a,height2:o}=l;e.forEachPoint((e,l)=>{0===l?t.moveTo(r-(e.y*i+o),e.x*s+a):t.lineTo(r-(e.y*i+o),e.x*s+a)},!0),t.closePath()}fetch("/wasm/kiri-sla.wasm").then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,{env:{reportf:(e,t)=>{console.log("[f]",e,t)},reporti:(e,t)=>{console.log("[i]",e,t)}}})).then(e=>{let{module:t,instance:l}=e,{exports:s}=l,i=new Uint8Array(s.memory.buffer);self.wasm={heap:i,memory:s.memory,render:s.render,rle_encode:s.rle_encode}}),self.renderLayerWasm=function(e){let{width:t,height:l,index:s,widgets:i,scaleX:r,scaleY:a,masks:o}=e,p=t/2,h=l/2,f=[],u=0,c=self.wasm;function d(e){let t=e.points,s=e.bounds=n.newBounds();for(let e=0,i=t.length;e<i;e++){let i=t[e];i.y=l-(i.y*a+h),i.x=i.x*r+p,s.update(i)}if(e.inner)for(let t=0,l=e.inner,s=e.inner.length;t<s;t++)d(l[t])}function g(e,t){let l=e.skip(2),s=t.inner;e.writeU16(s?s.length:0,!0);let i=t.points,n=t.bounds;e.writeU16(i.length,!0),e.writeU16(n.minx,!0),e.writeU16(n.maxx,!0),e.writeU16(n.miny,!0),e.writeU16(n.maxy,!0);for(let t=0,l=i.length;t<l;t++){let l=i[t];e.writeF32(l.x,!0),e.writeF32(l.y,!0)}if(s&&s.length)for(let t=0,l=s.length;t<l;t++)g(e,s[t]);e.view.setUint16(l,e.pos-l,!0)}i.forEach(e=>{let t=e.slices[s];if(t){t.synth&&u++;let l=t.solids.unioned;l||(l=t.tops.map(e=>e.poly)),t.supports&&l.appendAll(t.supports),f.appendAll(l.map(t=>t.clone(!0).move(e.track.pos))),u+=l.length}});let w=t*l,y=new DataWriter(new DataView(c.memory.buffer),w);y.writeU16(t,!0),y.writeU16(l,!0),y.writeU16(f.length,!0);for(let e=0,t=f.length;e<t;e++){let t=f[e];d(t),g(y,t)}c.render(0,w,0);let m=c.heap.slice(0,w),b=[];for(let e=0;e<o.length;e++){let t=c.rle_encode(0,0,w,o[e],w,0);b.push(c.heap.slice(w,w+t))}return{image:m,layers:b,end:0===u}},self.renderLayer=function(e){let{width:t,height:l,index:s,widgets:i,scaleX:n,scaleY:r}=e,a=new OffscreenCanvas(l,t),o={scaleX:n,scaleY:r,width:t,height:l,width2:t/2,height2:l/2},p=a.getContext("2d");p.fillStyle="rgb(200, 0, 0)";let h=0;i.forEach(e=>{let t=e.slices[s];if(t){t.synth&&h++;let l=t.solids.unioned;l||(l=t.tops.map(e=>e.poly)),t.supports&&l.appendAll(t.supports),l.forEach(t=>{t.move(e.track.pos),p.beginPath(),v(t.setClockwise(),p,o),t.inner&&t.inner.forEach(e=>{v(e.setCounterClockwise(),p,o)}),p.fill(),h++})}});let f=p.getImageData(0,0,l,t).data,u=new Uint8ClampedArray(f.length/4);for(let e=0;e<u.length;e++)u[e]=f[4*e];return{image:u,end:0===h}}}}();