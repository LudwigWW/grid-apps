"use strict";self.kiri=self.kiri||{},self.kiri.version=exports.VERSION,self.kiri.license=exports.LICENSE,self.kiri.copyright=exports.COPYRIGHT,function(){/(iPad|iPhone|iPod)/g.test(navigator.userAgent);let e=moto,t=self.kiri,i=self.base,n=i.util,o=i.debug,r=t.lang.current,l=self.window,a=self.document,s=self.location,c=(s.host.split(":"),function(e){let t,i,n={};return e.replace(/&/g,",").split(",").forEach(function(e){2===(t=decodeURIComponent(e).split(":")).length&&(i=n[t[0]]=n[t[0]]||[]).push(decodeURIComponent(t[1]))}),n}(s.search.substring(1))),d=(s.protocol.toLowerCase().indexOf("https"),self.debug&&!c.remote),u=e.KV,f=t.odb=new e.Storage(c.d?c.d[0]:"kiri"),p=t.space=e.Space,m=t.widgets=[],h=t.catalog=t.openCatalog(f,!0),g=new Y(u),y=t.conf,v=y.MODES,x=y.VIEWS,w=Object.clone,k=w(y.template),b=(w(k),kiri.Widget),_=kiri.newWidget,A={},E=e.ui.prefix("kiri").inputAction(Ae).hideAction(Ie),M=v.FDM,C={},S=null,O=[],R="kiri-gcode-filters",z=te(u.getItem(R))||[],L=4,T=x.ARRANGE,I=!0,N=(c.local,null),P=0,D=0,F="true"===u.getItem("dev-favorites"),V=[],j=!1;c.rm&&(L=parseInt(c.rm[0])),o.enable(),h.show=function(){Re("catalog")};const G={opacity:ve,move:function(e,t,i,n){le(function(o){o.move(e,t,i,n)}),H.update_stock(),p.update()},scale:function(){let e=arguments;if(le(function(t){t.scale(...e)}),!1===[...arguments].pop())return;ye(),H.compute_max_z(),H.update_stock(!0),p.update()},rotate:function(e,t,i){le(function(n){n.rotate(e,t,i)}),ye(),H.compute_max_z(),H.update_stock(!0),p.update()},meshes:function(){return O.slice()},widgets:function(){return O.slice().map(e=>e.widget)},for_groups:le,for_meshes:se,for_widgets:ae},H={add:function(e,t,i){k.widget[e.id]||(k.widget[e.id]={extruder:0});if(m.push(e),p.platform.add(e.mesh),H.select(e,t),H.compute_max_z(),Z.event.emit("widget.add",e),i)return;j?I&&H.layout():we()},delete:function(e){if(!e)return;if(Array.isArray(e)){let t,i=e.slice();for(t=0;t<i.length;t++)H.delete(i[t].widget);return}t.work.clear(e),delete k.widget[e.id],m.remove(e),b.Groups.remove(e),p.platform.remove(e.mesh),O.remove(e.mesh),ce(),H.compute_max_z(),M!==v.FDM&&H.layout();p.update(),xe(),I&&H.layout();Z.event.emit("widget.delete",e)},layout:function(i,n){let o=A.autoLayout.checked,r=k.process,l=T,a=T===x.ARRANGE&&o;M===v.CAM&&r.camZTopOffset;switch(M){case v.SLA:n=n||(r.slaSupportLayers&&r.slaSupportDensity?2:1);break;case v.CAM:case v.LASER:n=n||r.outputTileSpacing||1;break;case v.FDM:n=n||2*(r.sliceSupportExtra||0)+1}if(Pe(x.ARRANGE),de(),l!==x.ARRANGE)return p.update();if(!o||!n&&!a)return p.update();let s=n;if(M===v.CAM&&m.length>1){let e=n||1,i=t.driver.CAM;r.roughingOn&&(e=Math.max(e,i.getToolDiameter(k,r.roughingTool))),(r.finishingOn||r.finishingXOn||r.finishingYOn)&&(e=Math.max(e,i.getToolDiameter(k,r.finishingTool))),s=1.5*e}let c,d,u=p.platform.size(),f=[u.x,u.y],h=[f[0]/2,f[1]/2],g=f[0]>f[1]?[f[0]/f[1]*10,10]:[10,f[1]/f[1]*10],y=b.Groups.blocks().sort(function(e,t){return t.w*t.h-e.w*e.h}),w=new e.Pack(h[0],h[1],s).fit(y);for(;!w.packed;)h[0]+=g[0],h[1]+=g[1],w=new e.Pack(h[0],h[1],s).fit(y);for(c=0;c<y.length;c++)(d=y[c]).fit.x+=d.w/2+w.pad,d.fit.y+=d.h/2+w.pad,d.move(w.max.w/2-d.fit.x,w.max.h/2-d.fit.y,0,!0);M===v.CAM&&H.update_stock(!0);H.update_origin(),p.update()},load:function(e,t){e.toLowerCase().indexOf(".stl")>0?H.load_stl(e,t):Q(e,function(e){e=te(e).toFloat32(),H.add(_().loadVertices(e)),t&&t(e)})},load_stl:function(t,i){(new e.STL).load(t,function(e){H.add(_().loadVertices(e)),i&&i(e)})},deselect:function(e){if(T!==x.ARRANGE)return;if(!e)return void re(function(e){H.deselect(e)});let t=e.mesh,i=O.indexOf(t);i>=0&&(O.splice(i,1),Z.event.emit("widget.deselect",e));e.setColor(B.deselected,k),xe(),p.update(),ye()},select:function(e,t){if(T!==x.ARRANGE)return;let i=e.mesh;if(O.indexOf(i)>=0)t?H.deselect(e):O.length>1&&(H.deselect(),H.select(e,!1));else{if(!i.material.visible)return;t||H.deselect(),O.push(i),Z.event.emit("widget.select",e),e.setColor(B.selected,k),ye()}xe(),p.update()},select_all:function(){re(function(e){H.select(e,!0)})},selected_count:function(){return T===x.ARRANGE?O.length:0},compute_max_z:function(){D=0,re(function(e){D=Math.max(D,e.mesh.getBoundingBox().max.z)}),p.platform.setMaxZ(D)},update_origin:function(){H.update_bounds();let e=k.device,t=k.process,i=0,n=0,o=0;M===v.CAM&&t.camOriginTop&&(o=P+.01,N||(o+=t.camZTopOffset));if(t.outputOriginCenter)N&&(i=N.position.x,n=-N.position.y);else if(N)i=-N.scale.x/2+N.position.x,n=N.scale.y/2-N.position.y;else if(M===v.LASER&&t.outputOriginBounds){let e=k.bounds;i=e.min.x,n=-e.min.y}else i=-e.bedWidth/2,n=e.bedDepth/2;k.origin={x:i,y:n,z:o},k.controller.showOrigin&&M!==v.SLA?p.platform.setOrigin(i,n,o):p.platform.setOrigin()},update_bounds:function(){let e=new THREE.Box3;return re(function(t){let i=t.track.pos,n=t.mesh.getBoundingBox().clone();n.min.x+=i.x,n.max.x+=i.x,n.min.y+=i.y,n.max.y+=i.y,e.union(n)}),k.bounds=e},update_stock:function(e){let t=k.process,i=A.camStockOffset.checked,n=i||t.camStockX&&t.camStockY&&t.camStockZ>0,o=J();if(k.stock={},P=D,M===v.CAM&&n&&m.length){A.stock.style.display=i?"inline-block":"none";let n=t.camStockX*o,r=t.camStockY*o,l=t.camStockZ*o,a=0,s=0;if(i){let t={x:1/0,y:1/0,z:0},i={x:-1/0,y:-1/0,z:-1/0};re(function(n){let o=n.getBoundingBox(e),r=n.track.pos;t={x:Math.min(t.x,r.x+o.min.x),y:Math.min(t.y,r.y+o.min.y),z:0},i={x:Math.max(i.x,r.x+o.max.x),y:Math.max(i.y,r.y+o.max.y),z:Math.max(i.z,o.max.z)}}),n+=i.x-t.x,r+=i.y-t.y,l+=i.z-t.z,a=t.x+(i.x-t.x)/2,s=t.y+(i.y-t.y)/2,$("stock-width").innerText=(n/o).toFixed(2),$("stock-depth").innerText=(r/o).toFixed(2),$("stock-height").innerText=(l/o).toFixed(2)}if(!N){let e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial({color:7829367,opacity:.2,transparent:!0,side:THREE.DoubleSide}),i=new THREE.Mesh(e,t);p.platform.add(i),N=i}k.stock={x:n,y:r,z:l},N.scale.x=n,N.scale.y=r,N.scale.z=l,N.position.x=a,N.position.y=s,N.position.z=l/2,N.material.visible="CAM"===k.mode,P=l}else N&&(A.stock.style.display="none",p.platform.remove(N),N=null,P=D);H.update_top_z(),H.update_origin(),p.update()},update_size:function(){let e,t,i=p.scene.freeze(!0),n=k.device,o=Math.round(Math.max(n.bedHeight,n.bedWidth/100,n.bedDepth/100));p.platform.setRound(n.bedRound),p.platform.setSize(e=parseInt(n.bedWidth),t=parseInt(n.bedDepth),o=parseFloat(n.bedHeight)),p.platform.setGZOff(o/2-.1),H.update_origin(),p.scene.freeze(i)},update_top_z:function(){let e=m.length>1&&k.controller.alignTop,t=M===v.CAM&&(k.stock.z||e)?P-k.process.camZTopOffset:0;re(function(e){e.setTopZ(t)})},update_selected:xe,load_files:Me,group:function(){j=!0},group_done:we},B={wireframe:4473924,wireframe_opacity:.25,selected:[12320512,12316160,12311808],deselected:[16776960,16768256,16759552],slicing:16755370,preview_opacity:0,model_opacity:1,slicing_opacity:.5,sliced_opacity:0,cam_preview:21947,cam_preview_opacity:.25,cam_sliced_opacity:.25},W={infill:[{name:"vase"},{name:"hex"},{name:"grid"},{name:"gyroid"},{name:"triangle"},{name:"linear"},{name:"bubbles"}],units:[{name:"mm"},{name:"in"}],antialias:[{name:"1",id:1},{name:"2",id:2},{name:"4",id:4},{name:"8",id:8}]},Z=t.api={ui:A,uc:E,sdb:u,o2js:ee,js2o:te,ajax:Q,clone:w,focus:function(e){e=[e||A.load,A.import,A.ctrlLeft,A.container,A.assets,A.control,A.modeFDM,A.reverseZoom,A.modelOpacity,a.body];for(let t,i=0;i<e.length&&((t=e[i]).focus(),a.activeElement!==t);i++);},stats:g,catalog:h,conf:{get:function(){return k},put:function(e){k=y.normalize(e),Z.conf.save(),Z.space.restore(null,!0)},load:function(e,t){let i=Ve(),n=e?e.target.getAttribute("load"):t||k.cproc[i],o=k.sproc[i][n];if(!o)return;k.process=w(o),k.process.processName=n,k.cproc[i]=n,k.devproc[Ge()]=n,$("selected-mode").innerHTML=Z.mode.get(),$("selected-device").innerHTML=Z.device.get(),$("selected-process").innerHTML=n,"FDM"==i&&(k.process.outputOriginCenter=k.device.originCenter||!1);t||Oe();_e(),Z.conf.update(),e&&q()},save:function(){let e=p.view.save();(e.left||e.up)&&(k.controller.view=e);u.setItem("ws-settings",JSON.stringify(k))},show:function(){Te(),Re("settings")},update:Ae,restore:Ce,export:function(){return btoa(JSON.stringify({settings:k,version:t.version,moto:e.id,init:u.getItem("kiri-init"),time:Date.now()}))},import:Ee},color:B,const:{SEED:"kiri-seed",LANG:r,LOCAL:d,MODES:v,VIEWS:x,SETUP:c},var:{layer_at:1/0,layer_max:0,layer_range:0},device:{get:Ge,set:void 0},dialog:{show:Re,hide:Oe,update:Ie},help:{show:function(){$e(`/kiri/lang/${t.lang.get()}-help.html`)},file:$e},event:{on:function(e,t){e&&"string"==typeof e&&"function"==typeof t&&(C[e]=C[e]||[],C[e].push(t))},emit:function(e,t){e&&C[e]&&C[e].forEach(function(e){e(t)})},import:function(){$("load-file").onchange=function(e){o.log(e),Me(e.target.files)},$("load-file").click()},alerts:U,settings:q},feature:{seed:!0,controls:!0},function:{slice:ge,print:function e(t){if(T===x.PREVIEW)return;for(let i=0;i<m.length;i++)if(!m[i].slices||m[i].isModified())return void ge(function(){!m[i].slices||m[i].isModified()?K("nothing to print"):e(t)});Pe(x.PREVIEW);he();Z.conf.save();M===v.CAM?(ve(B.cam_preview_opacity),re(function(e){e.setColor(B.cam_preview)})):ve(B.preview_opacity);S=kiri.newPrint(k,m);S.setup(!0,function(e,t){ne(e,t)},function(){if(!S)return Pe(x.ARRANGE);ne(0),ve(0),S.render(),Z.event.emit("print",Ve()),p.platform.add(S.group),p.update(),A.layerPrint.checked=!0,ce(!0),fe(),"function"==typeof t&&t()})},export:function(){t.export()},clear:me},hide:{import:function(){A.import.style.display="none"}},language:t.lang,lists:W,modal:{show:Se,hide:Ne,visible:function(){return"none"!==$("modal").style.display||E.isPopped()}},mode:{get_lower:function(){return Ve().toLowerCase()},get_id:function(){return M},get:Ve,set:je,switch:function(e){je(e,H.update_size)},set_expert:function(e){E.setExpert(A.expert.checked=control.expert=e)}},print:{get:function(){return S},clear:he},probe:{grid:function(){return!1},local:function(){return!1}},platform:H,selection:G,show:{alert:K,devices:void 0,progress:ne,controls:function(e){A.ctrlLeft.style.display=e?"block":"none",A.ctrlRight.style.display=e?"block":"none"},favorites:function(e){if(void 0!==e)return u.setItem("dev-favorites",e),F=e,e;return F},slices:fe,layer:function(e){fe(Z.var.layer_at=oe(e,0,Z.var.layer_max))},local:function(){$("local-close").onclick=Ne,Se("local"),fetch("/api/grid_local").then(e=>e.json()).then(e=>{let t=[],i=["<table>"];i.push("<thead><tr><th>device</th><th>type</th><th>status</th><th></th></tr></thead>"),i.push("<tbody>");for(let n in e){let o=e[n].stat;t.push({uuid:o.device.uuid,host:o.device.addr[0],post:o.device.port}),i.push("<tr>"),i.push(`<td>${o.device.name}</td>`),i.push(`<td>${o.device.mode}</td>`),i.push(`<td>${o.state}</td>`),i.push(`<td><button id="${o.device.uuid}">admin</button></td>`),i.push("</tr>")}i.push("</tbody>"),i.push("</table>"),$("local-dev").innerHTML=i.join(""),t.forEach(e=>{$(e.uuid).onclick=(()=>{window.open(`http://${e.host}:${e.port||4080}/`)})})})},import:function(){A.import.style.display=""}},space:{reload:function(){Z.event.emit("reload"),setTimeout(()=>{s.reload()},50)},restore:function(e,t){let i=Ce(!0).controller.view,n=ie("ws-widgets",[]),o=0;_e(),H.update_size(),H.update_stock();let r=p.scene.freeze(!0);p.view.reset(),i?p.view.load(i):p.view.home();if(p.scene.freeze(r),t)return;return re(function(e){H.delete(e)}),n.forEach(function(t){b.loadFromState(t,function(t){t&&H.add(t,0,!0),++o===n.length&&(H.deselect(),e&&(e(),setTimeout(()=>{H.update_top_z(),p.update()},1)))},!0)}),n.length>0},clear:function(){t.work.clear(),H.select_all(),H.delete(O)},save:function(){Z.conf.save();let e=[],t=te(u.getItem("ws-widgets"),[]);re(function(i){e.push(i.id),t.remove(i.id),i.saveState()}),u.setItem("ws-widgets",ee(e)),t.forEach(function(e){b.deleteFromState(e)}),K("workspace saved",1)}},view:{get:function(){return T},set:Pe,update_fields:_e,wireframe:function(e,t){re(function(i){i.toggleWireframe(e,t)}),p.update()},snapshot:null},widgets:{new:_,all:function(){return m.slice()},for:re,load:b.loadFromCatalog,meshes:function(){let e=[];return re(function(t){e.push(t.mesh)}),e},opacity:ve},work:t.work};function Y(e){this.db=e,this.obj=te(this.db.stats||"{}");let t,i=this.obj;for(t in i)i.hasOwnProperty(t)&&("dn"===t||t.indexOf("-")>0||t.indexOf("_")>0)&&delete i[t]}Y.prototype.save=function(e){return this.db.stats=ee(this.obj),e||Z.event.emit("stats",this.obj),this},Y.prototype.get=function(e){return this.obj[e]},Y.prototype.set=function(e,t,i){return this.obj[e]=t,this.save(i),this},Y.prototype.add=function(e,t,i){return this.obj[e]=(this.obj[e]||0)+(t||1),this.save(i),this},Y.prototype.del=function(e,t){return delete this.obj[e],this.save(t),this};let X=parseInt(u.getItem("kiri-init")||g.get("init")||0)+1;function J(){return M===v.CAM&&"in"===k.controller.units?25.4:1}function K(e,t){if(void 0===e)return U(!0);V.push([e,Date.now(),t]),U()}function U(e){e&&(V=[]);let t=Date.now();for(V=V.filter(e=>t-e[1]<1e3*(e[2]||5));V.length>5;)V.shift();A.alert&&(V.length>0?(A.alert.text.innerHTML=V.map(e=>["<p>",e[0],"</p>"].join("")).join(""),A.alert.dialog.style.display="flex"):A.alert.dialog.style.display="none")}function q(){Z.event.emit("settings",k)}function Q(t,i,n,o,r){return new e.Ajax(i,n).request(t,o,r)}function ee(e,t){return e?JSON.stringify(e):t||null}function te(e,t){try{return e?JSON.parse(e):t||null}catch(i){return console.log({malformed_json:e}),t||null}}function ie(e,t){return te(u.getItem(e),t)}function ne(e,t){e?(e=n.round(100*e,4),A.loading.display="block",A.progress.width=e+"%",t&&(A.prostatus.innerHTML=t)):A.loading.display="none"}function oe(e,t,i){return Math.max(t,Math.min(i,e))}function re(e){m.slice().forEach(function(t){e(t)})}function le(e){let t=O;0===t.length&&1===m.length&&(t=[m[0].mesh]);let i=[];t.slice().forEach(function(t){i.indexOf(t.widget.group)<0&&e(t.widget),i.push(t.widget.group)})}function ae(e){let t=O;0===t.length&&1===m.length&&(t=[m[0].mesh]),t.slice().forEach(function(t){e(t.widget)})}function se(e){O.slice().forEach(function(t){e(t)})}function ce(e){let t=0;T===x.PREVIEW&&S?t=S.getLayerCount():re(function(e){e.slices&&(t=Math.max(t,e.slices.length))}),t=Math.max(0,t-1),Z.var.layer_max=t,(A.layerID.convert()>t||Z.var.layer_at>t)&&(Z.var.layer_at=t,A.layerID.value=t,A.layerSlider.value=Z.var.layer_max),A.layerSlider.max=t,e&&(Z.var.layer_at=Z.var.layer_max,A.layerSlider.value=Z.var.layer_max)}function de(){let e=!1;return ve(B.model_opacity),re(function(t){t.setWireframe(!1),e=t.hideSlices()||e}),he(),e}function ue(e,t,i){return t?e<=i&&e>i-t:e<=i}function fe(e){e=oe(e="string"==typeof e||"number"==typeof e?parseInt(e):Z.var.layer_at,0,Z.var.layer_max),A.layerID.value=e,A.layerSlider.value=e;let t,i,n,o,r=A.layerRange.checked?A.layerSpan.convert()||1:0,l=A.layerPrint.checked,a=A.layerMoves.checked;if(M===v.CAM&&Z.var.layer_range!==r&&r&&e===Z.var.layer_max&&(e=0),Z.var.layer_range=r,Z.var.layer_at=e,re(function(a){if(l)return a.hideSlices();if(n=a.slices)for(t=0;t<n.length;t++)(i=n[t]).view.visible=ue(t,r,e),(o=i.layers).outline.setVisible(M===v.CAM?A.layerOutline.checked&&d:A.layerOutline.checked),o.trace.setVisible(M===v.CAM?A.layerRough.checked:A.layerTrace.checked),o.bridge.setVisible(M===v.CAM?A.layerFinishX.checked:A.layerDelta.checked),o.flat.setVisible(M===v.CAM?A.layerFinishY.checked:A.layerDelta.checked),o.solid.setVisible(M===v.CAM?A.layerFinish.checked:A.layerSolid.checked),o.fill.setVisible(M===v.CAM?A.layerFacing.checked:A.layerFill.checked),o.sparse.setVisible(A.layerSparse.checked),o.support.setVisible(A.layerSupport.checked)}),S){let i=S.getLayerCount();for(t=0;t<i;t++)S.showLayer(t,l&&ue(t,r,e),a)}A.layerPrint.parentNode.style.display=S?"":"none",A.layerMoves.parentNode.style.display=S?"":"none",p.update()}function pe(e,t){Pe(x.PREVIEW),he(),ve(0),S=kiri.newPrint(k,[]);k.process.outputOriginCenter;let i=k.origin,n={x:i.x,y:-i.y,z:i.z};switch(t){case"svg":S.parseSVG(e,n);break;default:S.parseGCode(e,n)}S.render(),p.platform.add(S.group),p.update(),A.layerPrint.checked=!0,ce(!0),fe()}function me(){de(),re(function(e){e.slices=null}),he()}function he(){S&&(p.platform.remove(S.group),S=null),A.layerPrint.checked=!1}function ge(e){if(T==x.ARRANGE){let e=p.screenshot();Z.view.snapshot=e.substring(e.indexOf(",")+1),t.work.snap(Z.view.snapshot)}he(),H.deselect(),Pe(x.SLICE),Z.conf.save();let i,r=!0,l=m.length,a=Z.var.layer_max,s=Z.var.layer_at,c={},d=n.time();k.synth.sendTopo=!1,ve(B.slicing_opacity),re(function(t){let u,f,p={},h=0,g=!1;t.stats.progress=0,t.setColor(B.slicing),t.slice(k,function(i,c){let m=n.time();t.render(L,M===v.CAM),t.setWireframe(!1,B.wireframe,B.wireframe_opacity),t.setOpacity("CAM"===k.mode?B.cam_sliced_opacity:B.sliced_opacity),t.setColor(B.deselected),i&&(f&&(p[h+"_"+f]=m-u),p.total=n.time()-d,o.log(p),Z.event.emit("slice",Ve()),ce(!0),a!=Z.var.layer_max&&(s=Z.var.layer_max),r=!1),(0==--l||c||g)&&(ne(0),fe(s),ve("CAM"===k.mode?B.cam_sliced_opacity:B.sliced_opacity),e&&"function"==typeof e&&e()),Z.dialog.update(),c&&!g&&(g=!0,Pe(x.ARRANGE),ve(B.model_opacity),H.deselect(),K(c))},function(e,o){if(o!==f){let e=n.time();f&&(p[h+"_"+f]=e-u),f=o,u=e,h++}c[t.id]=e,i=0,re(function(e){i+=c[e.id]||0}),ne(i/m.length,o)},!0)})}function ye(){let e,t=new THREE.Box3;if(se(i=>{t=t.union(i.getBoundingBox()),e=i.widget.track}),t.min.x===1/0)return void(0===O.length&&(A.sizeX.value=0,A.sizeY.value=0,A.sizeZ.value=0,A.scaleX.value=1,A.scaleY.value=1,A.scaleZ.value=1));let i=t.max.x-t.min.x,o=t.max.y-t.min.y,r=t.max.z-t.min.z,l=J();A.sizeX.value=A.sizeX.was=n.round(i/l,2),A.sizeY.value=A.sizeY.was=n.round(o/l,2),A.sizeZ.value=A.sizeZ.was=n.round(r/l,2),A.scaleX.value=A.scaleX.was=e.scale.x,A.scaleY.value=A.scaleY.was=e.scale.y,A.scaleZ.value=A.scaleZ.was=e.scale.z}function ve(e){re(function(t){t.setOpacity(e)}),A.modelOpacity.value=100*e,p.update()}function xe(){A.selection.style.display=H.selected_count()?"inline":"none",$("ext-sel").style.display=M===v.FDM?"inline-block":"none";let e=k.device.extruders;if(e){for(let t=0;t<e.length;t++){let e=$(`sel-ext-${t}`);e&&e.classList.remove("buton")}ae(e=>{let t=k.widget[e.id].extruder||0,i=$(`sel-ext-${t}`);i&&i.classList.add("buton")})}}function we(e){j=!1,b.Groups.loadDone(),I&&!e&&H.layout()}function ke(e){if(!e)return console.trace("missing scope");for(let t in e){if(!e.hasOwnProperty(t))continue;let i=e[t];if(A.hasOwnProperty(t)){let e=A[t],n=e?e.type:null;if("text"===n)e.value=i;else if("checkbox"===n)e.checked=i;else if("select-one"===n){e.innerHTML="";let t=e.parentNode.getAttribute("source"),n=k[t]||W[t],o=null;n&&n.forEach(function(t,n){let r=t.id||t.name;i==r&&(o=n);let l=a.createElement("option");l.appendChild(a.createTextNode(t.name)),l.setAttribute("value",r),e.appendChild(l)}),o&&(e.selectedIndex=o)}else"textarea"===n&&(Array.isArray(i)?e.value=i.join("\n"):e.value="")}}}function be(e){if(!e)return console.trace("missing scope");let t;for(t in e)if(e.hasOwnProperty(t)&&A.hasOwnProperty(t)){let i=null,n=A[t];if(!n||""===n)continue;if("text"===n.type)i=A[t].convert();else if("checkbox"===n.type)i=A[t].checked;else if("select-one"===n.type)if(n.selectedIndex>=0){i=n.options[n.selectedIndex].value,"tools"===n.parentNode.getAttribute("source")&&(i=parseInt(i))}else i=e[t];else{if("textarea"!==n.type)continue;i=n.value.trim().split("\n").filter(e=>""!==e)}e[t]!=i&&(e[t]=i)}return k}function _e(){ke(k.device),ke(k.process),ke(k.layers),ke(k.controller),function e(t){t.extruders&&t.extruders[t.internal]&&(ke(t.extruders[t.internal]),A.extruder.firstChild.innerText=`${r.dv_gr_ext} [${t.internal+1}/${t.extruders.length}]`,A.extPrev.disabled=0===t.internal,A.extPrev.onclick=function(){t.internal--,e(t)},A.extNext.disabled=t.internal===t.extruders.length-1,A.extNext.onclick=function(){t.internal++,e(t)},A.extDel.disabled=t.extruders.length<2,A.extDel.onclick=function(){t.extruders.splice(t.internal,1),t.internal=Math.min(t.internal,t.extruders.length-1),e(t)},A.extAdd.onclick=function(){let i=w(t.extruders[t.internal]);i.extSelect=[`T${t.extruders.length}`],t.extruders.push(i),t.internal=t.extruders.length-1,e(t)})}(k.device)}function Ae(){be(k.controller),be(k.device),be(k.process),be(k.layers);let e=k.device;e.extruders&&e.extruders[e.internal]&&be(e.extruders[e.internal]),Z.conf.save(),H.update_stock()}function Ee(e,t){if("string"==typeof e)try{e=JSON.parse(atob(e))}catch(t){return alert("invalid settings format"),void console.log("data",e)}if(!(e.settings&&e.version&&e.time))return alert("invalid settings format"),void console.log("data",e);t&&!confirm(`Import settings made on ${new Date(e.time)} from Kiri:Moto version ${e.version}?`)||(k=y.normalize(e.settings),Z.conf.save(),Z.space.reload())}function Me(t,i){let n=t.length;H.group();for(let o=0;o<t.length;o++){let r=new FileReader,l=t[o].name.toLowerCase(),a=l.indexOf(".raw")>0||l.indexOf(".")<0,s=l.indexOf(".stl")>0,c=l.indexOf(".svg")>0,d=l.indexOf(".gcode")>0||l.indexOf(".nc")>0,u=l.indexOf(".b64")>0;r.file=t[o],r.onloadend=function(t){a&&H.add(_(void 0,i).loadVertices(JSON.parse(t.target.result).toFloat32())),s&&(Z.feature.on_add_stl?Z.feature.on_add_stl(t.target.result):H.add(_(void 0,i).loadVertices((new e.STL).parse(t.target.result)).saveToCatalog(t.target.file.name))),d&&pe(t.target.result,"gcode"),c&&pe(t.target.result,"svg"),u&&Ee(t.target.result,!0),0==--n&&H.group_done(d)},r.readAsBinaryString(r.file)}}function Ce(e){let t=ie("ws-settings")||k;return(k=y.normalize(t)).controller.view&&u.removeItem("ws-camera"),z.forEach(function(e){let t="gcode-filter-"+e,i=ie(t);i&&(k.devices[e]=i),u.removeItem(t)}),u.removeItem(R),e&&Z.conf.save(),t}function Se(e){A.modal.style.display="block",["print","help","local"].forEach(function(t){A[t].style.display=t===e?"block":"none"}),e&&Z.event.emit("modal.show",e)}function Oe(){Re(null)}function Re(e,t){E.isPopped()?E.hidePop():(["catalog","devices","tools","settings"].forEach(function(i){let n=A[i].style;n.display=i!==e||!t&&"flex"===n.display?"none":"flex"}),e&&Z.event.emit("dialog.show",e))}function ze(e){let t=Ve(),i=e.target.getAttribute("name"),n=k.sproc[t][i],o=prompt(`settings for "${i}"`,JSON.stringify(n));if(o)try{k.sproc[t][i]=JSON.parse(o),i===k.process.processName&&Z.conf.load(null,i),Z.conf.save()}catch(e){alert("malformed settings object")}}function Le(e){let t=e.target.getAttribute("del");delete k.sproc[Ve()][t],Te(),Z.conf.save(),q()}function Te(){let e=[],t=k.sproc[Ve()]||{},i=A.settingsList;i.innerHTML="";for(let i in t)t.hasOwnProperty(i)&&e.push(i);e.sort().forEach(function(e){let t=a.createElement("div"),n=a.createElement("button"),o=a.createElement("button"),r=a.createElement("button");n.setAttribute("load",e),n.onclick=Z.conf.load,n.appendChild(a.createTextNode(e)),e==k.process.processName&&n.setAttribute("class","selected"),r.setAttribute("del",e),r.setAttribute("title","remove '"+e+"'"),r.onclick=Le,r.appendChild(a.createTextNode("x")),o.innerHTML="&uarr;",o.setAttribute("name",e),o.setAttribute("title","edit"),o.onclick=ze,t.setAttribute("class","flow-row"),t.appendChild(o),t.appendChild(n),t.appendChild(r),i.appendChild(t)}),Z.dialog.update()}function Ie(){let e=A.ctrlLeft.getBoundingClientRect(),t=A.ctrlRight.getBoundingClientRect();A.catalog.style.left=e.width+5+"px",A.devices.style.left=e.width+5+"px",A.tools.style.left=e.width+5+"px",A.settings.style.right=t.width+5+"px"}function Ne(){A.modal.style.display="none"}function $e(e){Oe(),e?(Q(e,function(e){A.help.innerHTML=e,$("help-close").onclick=Ne,$("kiri-version").innerHTML=`<i>${r.version} ${t.version}</i>`,Se("help")}),Z.event.emit("help.show",e)):l.open("//wiki.grid.space/wiki/Kiri:Moto","_help")}function Pe(e){switch(T=e,H.deselect(),ye(),e){case x.ARRANGE:t.work.clear(),me(),Fe(!1),ce(),De(A.modeArrange);break;case x.SLICE:Fe(!0),ce(),De(A.modeSlice);break;case x.PREVIEW:Fe(!0),De(A.modePreview);break;default:return void o.log("invalid view mode: "+e)}a.activeElement.blur()}function De(e){[A.modeArrange,A.modeSlice,A.modePreview,A.modeExport].forEach(function(t){t===e?t.classList.add("buton"):t.classList.remove("buton")})}function Fe(e){A.layerView.style.display=e?"flex":"none"}function Ve(){return k.mode}function je(e,t,i){Ne(),Oe(),v[e]||(o.log("invalid mode: "+e),e="FDM"),k.mode=e,k.cdev[e]&&(k.device=w(k.cdev[e]),Z.event.emit("device.set",Ge())),M===v.CAM?p.platform.setColor(15658734):p.platform.setColor(13421772),M=v[e],Pe(x.ARRANGE),E.setMode(M),Z.conf.load(),Z.conf.save(),me(),p.update(),A.modeFDM.setAttribute("class",M===v.FDM?"buton":""),A.modeSLA.setAttribute("class",M===v.SLA?"buton":""),A.modeCAM.setAttribute("class",M===v.CAM?"buton":""),A.modeLASER.setAttribute("class",M===v.LASER?"buton":""),A.mode.style.display=t?"none":"",A.modeTable.style.display=t?"none":"",A.modelOpacity.style.display=M===v.SLA?"none":"",A.modePreview.style.display=M===v.SLA?"none":"",N&&(N.material.visible="CAM"===k.mode),Z.space.restore(null,!0),i&&i(),q(),xe(),_e(),k.device.new&&Z.show.devices(),Z.event.emit("mode.set",e)}function Ge(){return k.filter[Ve()]}u.setItem("kiri-init",X),g.set("init",X),g.set("kiri",kiri.version),a.onkeydown=function(e){27==e.keyCode&&e.preventDefault()},Array.isArray(self.kirimod)&&kirimod.forEach(function(e){e(kiri.api)})}();