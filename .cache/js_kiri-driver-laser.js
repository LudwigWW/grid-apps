"use strict";let gs_kiri_laser=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),self.kiri.driver.LASER)return;let t=self.kiri,e=self.base,n=e.util,i=(e.polygons,e.debug,t.driver.LASER={slice:function(t,e,n,o){let r=t.process;if(r.laserSliceHeight<0)return o("invalid slice height");i.sliceWidget(e,{height:r.laserSliceHeight,single:r.laserSliceSingle},function(t){e.slices=t,t.forEach(function(e,i){e.doShells(1,-r.laserOffset),n(.8+i/t.length*.2)}),o()},function(t){n(0+.8*t)})},printSetup:function(t,e){let n=t.widgets,i=t.settings,r=i.device,c=i.process,u=t.output,h=0,s=0;n.forEach(function(t){h+=t.slices.length}),n.forEach(function(n){if(c.outputLaserMerged){let i=[];n.slices.forEach(function(t){let n=[];t.gatherTopPolys([]).forEach(t=>t.flattenTo(n)),n.forEach(t=>{let e=!1;for(let n=0;n<i.length;n++){let o=i[n];t.isEquivalent(o)&&(e=!0,o.depth++)}e||(t.depth=1,i.push(t))}),e(s++/h)});let r=o(0,0,0),c=[];i.forEach(e=>{t.polyPrintPath(e,r,c,{extrude:e.depth,rate:10*e.depth})}),u.push(c)}else n.slices.forEach(function(n){!function(t,e,n){let i=o(0,0,0),r=t.settings.process.outputLaserGroup,c=[];function u(e,n){e&&(Array.isArray(e)?e.forEach(function(t){u(t,n)}):t.polyPrintPath(e,i,n,{extrude:1}))}e.tops.forEach(function(t){u(t.traces,c),u(t.innerTraces(),c),r||(n.push(c),c=[])}),r&&n.push(c)}(t,n,u),e(s++/h)})}),u.forEach(function(t){let e,n={w:1/0,h:1/0},i={w:-1/0,h:-1/0};t.forEach(function(t){e=t.point,t.point=e.clone(),n.w=Math.min(n.w,e.x),i.w=Math.max(i.w,e.x),n.h=Math.min(n.h,e.y),i.h=Math.max(i.h,e.y)}),t.w=i.w-n.w,t.h=i.h-n.h,t.forEach(function(t){(e=t.point).x-=n.w,e.y-=n.h})});let f,l,a,p=self.moto,x=[r.bedWidth,r.bedDepth],d=[x[0]/2,x[1]/2],g=x[0]>x[1]?[x[0]/x[1]*10,10]:[10,x[1]/x[1]*10],y=u.sort(function(t,e){return e.w*e.h-t.w*t.h}),E=new p.Pack(d[0],d[1],c.outputTileSpacing).fit(y);for(;!E.packed;)d[0]+=g[0],d[1]+=g[1],E=new p.Pack(d[0],d[1],c.outputTileSpacing).fit(y);for(f=0;f<y.length;f++)(l=y[f]).fit.x+=l.w+E.pad,l.fit.y+=l.h+E.pad,l.forEach(function(t,e){(a=t.point).x+=E.max.w/2-l.fit.x,a.y+=E.max.h/2-l.fit.y,a.z=0})},exportGCode:function(t){let e,n=[],i=0,o=0,c=t.settings.device,u=c.gcodeSpace?" ":"",h=c.gcodeLaserOn||[],s=c.gcodeLaserOff||[];return r(t,function(t,r,h,s){r.x,t.x,r.y,t.y,i=t.x,o=t.y,e=`${u}F${s}`,h=(h/100*256).toFixed(3),(c.gcodePre||[]).forEach(t=>{n.push(t)})},function(t,i){t.forEach(function(t,i){0===i?n.push(`G0${u}${t}`):1===i?(h.forEach(t=>{n.push(t.replace("{power}",255))}),n.push(`G1${u}${t}${e}`)):n.push(`G1${u}${t}`)}),s.forEach(t=>{n.push(t)})},function(){(c.gcodePost||[]).forEach(t=>{n.push(t)})},function(t){return`X${(t.x-i).toFixed(3)}${u}Y${(t.y-o).toFixed(3)}`}),n.join("\n")},exportSVG:function(t,e){let i,o=[],c=0,u=0,h=["black","purple","blue","red","orange","yellow","green","brown","gray"];return r(t,function(t,e){let n=e.x-t.x,r=e.y-t.y;c=t.x,u=t.y,i=e.y,o.push('<?xml version="1.0" standalone="no"?>'),o.push('<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'),o.push(`<svg width="${n}mm" height="${r}mm" viewBox="0 0 ${n} ${r}" xmlns="http://www.w3.org/2000/svg" version="1.1">`)},function(t,e){let n=h[(e-1)%h.length];o.push(`<polyline points="${t.join(" ")}" fill="none" stroke="${n}" stroke-width="0.1mm" />`)},function(){o.push("</svg>")},function(t){return n.round(t.x-c,3)+","+n.round(i-t.y-u,3)}),o.join("\n")},exportDXF:function(t){let e=[];return r(t,function(t,n){e.appendAll(["  0","SECTION","  2","HEADER","  9","$ACADVER","1","AC1014","  0","ENDSEC","  0","SECTION","  2","ENTITIES"])},function(t){e.appendAll(["  0","LWPOLYLINE","100","AcDbPolyline"," 90",t.length," 70","0"," 43","0.0"]),t.forEach(function(t){e.appendAll([" 10",t.x," 20",t.y])}),e.appendAll(["  0","SEQEND"])},function(){e.appendAll(["  0","ENDSEC","  0","EOF"])},function(t){return{x:t.x,y:t.y}}),e.join("\n")}},t.slicer),o=e.newPoint;function r(t,e,n,i,o){let r,c,u=t.settings.process,h=t.output,s=[],f={x:0,y:0},l={x:0,y:0};if(h.forEach(function(t){t.forEach(function(t){c=t.point,u.outputInvertX&&(c.x=-c.x),u.outputInvertY&&(c.y=-c.y),c.x*=u.outputTileScaling,c.y*=u.outputTileScaling,f.x=Math.min(f.x,c.x),l.x=Math.max(l.x,c.x),f.y=Math.min(f.y,c.y),l.y=Math.max(l.y,c.y)})}),u.outputOriginCenter){let e=t.settings.device.bedWidth,n=t.settings.device.bedDepth;h.forEach(function(t){t.forEach(function(t){(c=t.point).x+=e/2,c.y+=n/2})}),l.x=e,l.y=n,f.x=0,f.y=0}else h.forEach(function(t){t.forEach(function(t){(c=t.point).x-=f.x,c.y-=f.y})}),l.x=l.x-f.x,l.y=l.y-f.y,f.x=0,f.y=0;e(f,l,u.outputLaserPower,u.outputLaserSpeed),h.forEach(function(t){let e=0;t.forEach(function(t){c=t.point,t.emit?(e=t.emit,r&&0===s.length&&s.push(o(r)),s.push(o(c))):s.length>0&&(n(s,e),s=[]),r=c}),s.length>0&&(n(s,e),s=[])}),i()}}();