"use strict";var gs_kiri_db=exports;!function(){function e(e,i){this.db=e,this.files={},this.listeners=[],this.autodec=i,this.deferredHandler=null,this.refresh()}self.kiri||(self.kiri={});var i=self.kiri,t=e.prototype;function n(e){e.db.put("files",e.files),r(e)}function r(e){for(var i=0;i<e.listeners.length;i++)e.listeners[i](e.files)}i.openCatalog=function(i,t){return new e(i,t)},t.refresh=function(){var e=this;e.db.get("files",function(i){i&&(e.files=i,r(e))})},t.wipe=function(){var e,i=this.files;for(e in i)i.hasOwnProperty(e)&&this.deleteFile(e)},t.fileList=function(){return this.files},t.addFileListener=function(e){this.listeners.contains(e)||(this.listeners.push(e),e(this.files))},t.removeFileListener=function(e){this.listeners.remove(e)},t.decimate=function(e,t){if(e.length<5e5)return t(e);i.work.decimate(e,function(e){t(e)})},t.setDeferredHandler=function(e){this.deferredHandler=e},t.putDeferred=function(e,i){this.files[e]={deferred:i},n(this)},t.putFile=function(e,i,t){var r=this;r.db.put("file-"+e,i,function(f){f?(r.files[e]={vertices:i.length/3,updated:(new Date).getTime()},n(r),r.autodec?r.decimate(i,function(i){r.db.put("fdec-"+e,i),t&&t(i)}):t&&t(f)):t&&t(f)})},t.getFile=function(e,i){var t=this,n=t.files[e];if(n&&n.deferred)return t.deferredHandler?t.deferredHandler(n.deferred,e,i):i();this.autodec?this.db.get("fdec-"+e,function(n){n?i(n):t.db.get("file-"+e,function(n){if(!n)return i();t.decimate(n,function(r){t.db.put("fdec-"+e,r),i(n)})})}):t.db.get("file-"+e,i)},t.deleteFile=function(e,i){var t=this;if(t.files[e])return delete t.files[e],t.db.remove("fdec-"+e),void t.db.remove("file-"+e,function(e){n(t),i&&i(e)});i&&i(!1)}}();