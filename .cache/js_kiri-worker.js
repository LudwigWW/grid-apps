"use strict";importScripts(`/code/work.js${location.search}`);let currentPrint,currentSnap,ver=exports.VERSION,base=self.base,moto=self.moto,util=base.util,time=util.time,kiri=self.kiri,Widget=kiri.Widget,cache={};console.log(`kiri | init work | ${ver}`),base.debug.disable(),self.alert=function(t){console.log(t)};let dispatch={decimate:function(t,e){t=new Float32Array(t),t=Widget.pointsToVertices(Widget.verticesToPoints(t,!0)),e.done(t)},snap:function(t,e){currentSnap=t,e.done()},slice:function(t,e){let i=t.settings,n=new Float32Array(t.vertices),o=t.position,a=t.tracking,s=Widget.verticesToPoints(n),r=t.state||{},c=r.rotation;r.centerz,r.movez;c&&(r.rotate=(new THREE.Matrix4).makeRotationY(-c)),e.data({update:.05,updateStatus:"slicing"});let d,u=kiri.newWidget(t.id).setPoints(s),l=util.time();cache[t.id]=u,u.track=a,u.mesh={widget:u,position:o};try{u.slice(i,function(n){if(n)delete cache[t.id],e.data({error:n});else{let t=u.slices||[];e.data({send_start:time()}),e.data({topo:i.synth.sendTopo?u.topo:null,stats:u.stats,slices:t.length}),t.forEach(function(t,i){e.data({index:i,slice:t.encode(r)})}),self.debug&&u.polish&&e.data({polish:kiri.codec.encode(u.polish)}),e.data({send_end:time()})}e.done({done:!0})},function(t,i){(d=util.time())-l<10&&t<.99||(e.data({update:.05+.95*t,updateStatus:i}),l=d)})}catch(t){e.data({error:t.toString()}),console.log(t)}},printSetup:function(t,e){let i,n=[];for(i in cache)cache.hasOwnProperty(i)&&n.push(cache[i]);e.data({update:.05,updateStatus:"preview"}),(currentPrint=kiri.newPrint(t.settings,n,t.id)).setup(!1,function(t,i){e.data({update:t,updateStatus:i})},function(){e.done({done:!0,output:currentPrint.encodeOutput()})})},printExport:function(t,e){currentPrint.export(!1,function(t,i){e.data({line:t},i)},function(t,i){e.done({done:t},i)})},printGCode:function(t,e){currentPrint.exportGCode(!1,function(t){e.done({gcode:t,lines:currentPrint.lines,bytes:currentPrint.bytes,bounds:currentPrint.bounds,distance:currentPrint.distance,time:currentPrint.time})},function(t){e.data({line:t})})},clear:function(t,e){if(currentSnap=null,currentPrint=null,!t.id)return cache={},void e.done({clear:!0});let i=void 0!==cache[t.id];delete cache[t.id],e.done({id:t.id,had:i,has:void 0!==cache[t.id]})}};self.onmessage=function(t){let e=util.time(),i=t.data,n=dispatch[i.task],o={data:function(t,e){self.postMessage({seq:i.seq,task:i.task,done:!1,data:t},e)},done:function(t,e){self.postMessage({seq:i.seq,task:i.task,done:!0,data:t},e)}};if(n){let t=e-i.time,a=n(i.data,o),s=util.time()-e;a&&self.postMessage({seq:i.seq,task:i.task,time_send:t,time_proc:s,time_recv:util.time(),data:a})}else console.log({kiri_msg:t})};