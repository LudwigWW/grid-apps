"use strict";let gs_kiri_fdm=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),self.kiri.driver.FDM)return;let e=self.kiri,t=self.base,i=t.debug,n=t.util,l=t.config,r=t.polygons,o=(e.driver.FDM={slice:function(e,t,r,s){p(e);let a=e.process,u=e.device,c=(Date.now(),a.sliceSolidMinArea),d=a.sliceSolidLayers,f="vase"===a.sliceFillType,h=d&&!f,x=(e.widget[t.id]||{}).extruder||0,g=a.sliceHeight,m=u.extruders[x].extNozzle,y=m/2,z=m,S=1-(v=a.sliceFillOverlap,w=0,T=.8,Math.max(w,Math.min(T,v))),b=m,F=m*S,E=a.sliceFillAngle,M=t.mesh&&t.mesh.newGroup?t.mesh.newGroup():null;var v,w,T;if(!(g>0&&g<100))return s("invalid slice height");if(!(m>=.01&&m<100))return s("invalid nozzle size");0===a.firstSliceHeight&&(a.firstSliceHeight=g);a.firstSliceHeight<g&&(i.log("invalid first layer height < slice height"),i.log("reverting to slice height"),a.firstSliceHeight=g);o.sliceWidget(t,{height:g,minHeight:g>a.sliceMinHeight?a.sliceMinHeight:0,firstHeight:a.firstSliceHeight,view:M},function(i){if(i=i.filter(e=>e.tops.length),t.slices=i,!i)return;function o(e,t,n,l){i.forEach(function(o){n(o),function(e,t,n,l){r(.5+.5*(t+e/i.length*(n-t)),l)}(o.index,e,t,l)})}l.hint_len_max=n.sqr(a.sliceBridgeMax),i.forEach(function(e){e.extruder=x,e.invalidateFill(),e.invalidateSolids(),e.invalidateSupports()});let p=a.sliceSupportEnable&&a.sliceSupportDensity>0,S=a.sliceSupportArea;o(0,.2,function(e){let t=(e.index<a.sliceBottomLayers||e.index>i.length-a.sliceTopLayers-1||a.sliceFillSparse>.95)&&!f;e.doShells(a.sliceShells,y,z,F,{vase:f,thin:!1}),t&&e.doSolidLayerFill(b,E),E+=90},"offsets"),h&&(o(.2,.34,function(e){e.doDiff(c)},"diff"),o(.34,.35,function(e){e.projectFlats(d),e.projectBridges(d)},"solids"),o(.35,.5,function(e){e.doSolidsFill(b,E,c),e.doThinFill(b,E),E+=90},"solids"));p&&(o(.5,.7,function(e){e.doSupport(a.sliceSupportOffset,a.sliceSupportSpan,a.sliceSupportExtra,S,a.sliceSupportSize,a.sliceSupportOffset,a.sliceSupportGap)},"support"),o(.7,.8,function(e){e.doSupportFill(m,a.sliceSupportDensity,S)},"support"));!f&&a.sliceFillSparse>0&&o(.8,1,function(i){i.doSparseLayerFill({settings:e,process:a,device:u,lineWidth:m,spacing:F,density:a.sliceFillSparse,bounds:t.getBoundingBox(),height:g,type:a.sliceFillType})},"infill");s()},function(e){return r(0+.5*e)})},printSetup:function(i,n){let l,o,a,u,c,d,f,h=i.widgets.slice(),x=p(i.settings),g=x.device,m=g.extruders[0].extNozzle,y=x.process,z=(x.mode,i.output),S=x.bounds,b=s(0,0,0),F=y.firstSliceHeight||y.sliceHeight,E=0,M=0,v=0,w=[],T=[];if(y.outputBrimCount||y.outputRaft){let e=[],n=y.outputBrimOffset||(y.outputRaft?4:0);if(h.forEach(function(t){let i=[];t.slices[0].tops.forEach(function(e){i.push(e.poly.clone())}),t.slices[0].supports&&t.slices[0].supports.forEach(function(e){i.push(e.clone())}),r.nest(i).forEach(function(i){i.offset(m/2-n).forEach(function(i){i.move(t.mesh.position),e.push(i)})})}),e=r.union(e),n&&e.length){let t=y.sliceSupportExtra+2,i=e[0].getZ();e=r.expand(e,t,i,null,1),e=r.expand(e,-t,i,null,1)}if(y.outputRaft){let t=s(0,0,0);b=null;let n=function(n,l,o,s,p){let a=kiri.newSlice(v+n/2);e.forEach(function(e){null===b&&(b=e.first());let t=a.addTop(e);t.traces=[e],t.inner=r.expand(t.traces,.5*-m,0,null,1),t.inner[0].bounds.minx-=m/2,t.inner[0].bounds.maxx+=m/2,t.fill_lines=r.fillArea(t.inner,l,o,[])}),t.z=a.z,b=i.slicePrintPath(a,b,t,w,{speed:s,mult:p}),w.height=n,z.append(w),w=[],v+=n};n(m/1,y.sliceFillAngle+0,6*m,y.firstLayerRate/3,4),n(m/1,y.sliceFillAngle+0,6*m,y.firstLayerRate/2,4),n(m/2,y.sliceFillAngle+90,3*m,y.outputFeedrate,2.5),n(m/2,y.sliceFillAngle+0,1*m,y.outputFeedrate,1.5),n(m/2,y.sliceFillAngle+0,1*m,y.outputFeedrate,1),F+=y.outputRaftSpacing||0,z.last().last().retract=!0}else if(y.outputBrimCount){let t=[],n=[];e.forEach(function(e){r.trace2count(e,t,-m,y.outputBrimCount,0)}),b=i.poly2polyEmit(t,b,function(e,t,l,r){return i.polyPrintPath(e,r,n,{rate:y.firstLayerRate,onfirst:function(e){n.length&&e.distTo2D(r)>2&&(n.last().retract=!0)}})}),i.addPrintPoints(n,w,null),n.length&&(n.last().retract=!0)}let l=t.newBounds();e.forEach(e=>{l.merge(e.bounds)}),S.min.x=Math.min(S.min.x,l.minx),S.min.y=Math.min(S.min.y,l.miny),S.max.x=Math.max(S.max.x,l.maxx),S.max.y=Math.max(S.max.y,l.maxy)}if(y.sliceSupportEnable){let t=e.newWidget(),i=t.slices=[];h.forEach(function(t){let n=t.slices;for(;i.length<n.length;){let t=e.newSlice(n[i.length].z);t.extruder=y.sliceSupportNozzle,i.push(t)}n.forEach((e,n)=>{e.supports&&(i[n].supports||(i[n].supports=[]),i[n].supports.appendAll(e.supports.map(e=>(e.fills&&e.fills.forEach(e=>e.move(t.track.pos)),e.move(t.track.pos)))))})}),t.support=!0,t.mesh={widget:t},x.widget[t.id]={extruder:y.sliceSupportNozzle},h.push(t)}let P,O,k,_=[],H=0;if(h.forEach(function(e){E=Math.max(E,e.slices.length);let t=x.widget[e.id].extruder;_[t]||(_[t]={},H++)}),S.min.x<S.min.y){let e=(S.max.x-S.min.x-10*H)/2+5;P={x:S.min.x+e,y:S.max.y+5},O={x:10,y:0},k={x:9,y:4}}else{let e=(S.max.y-S.min.y-10*H)/2+5;P={x:S.max.x+5,y:S.min.y+e},O={x:0,y:10},k={x:4,y:9}}function B(e,t,n,l,r,o){if(H<2)return l;let s=t[e];return s?(t[e]=null,n.last()&&(n.last().retract=!0),l=i.polyPrintPath(s.poly.clone().setZ(r),l,n,{tool:o||e,open:!0,simple:!0}),n.last().retract=!0,l):(console.log({already_purged:e,from:t,layer:n}),l)}for(_=_.map((e,i)=>{if(!e)return e;let n=g.extruders[i].extNozzle,l={x:P.x,y:P.y,z:0},r={extruder:i,poly:t.newPolygon().centerSpiral(l,k.x,k.y,2*n,3)};return P.x+=O.x,P.y+=O.y,r});;){for(l=0;l<h.length;l++){let e=h[l].mesh;if(!e.widget)continue;let t=e.widget.slices;t&&t[M]&&T.push({slice:t[M],offset:e.position||{x:0,y:0,z:0},widget:e.widget})}if(0===T.length)break;let e,t,r=_.slice();for(;;){a=null,u=1/0;let n=[];for(l=0;l<T.length;l++)if((f=T[l])&&(d=f.slice.findClosestPointTo(b.sub(f.offset)))){let t=f.slice.extruder,i=e?e.extruder:t,r=Math.abs(d.distance);t!==i&&(r*=1e4),n.push({dst:r,sliceEntry:f,meshIndex:l})}if(n.sort((e,t)=>e.dst-t.dst),n.length){let e=n.shift();a=e.sliceEntry,c=e.meshIndex}if(!a){f&&(e=f.slice);break}w.length&&c!==o&&(w.last().retract=!0),w.height=w.height||a.slice.height,T[c]=null,a.offset.z=v,e&&e.extruder===a.slice.extruder||(b=B(a.slice.extruder,r,w,b,a.slice.z)),b=i.slicePrintPath(a.slice,b.sub(a.offset),a.offset,w,{first:0===a.slice.index,support:a.widget.support}),e=a.slice,t=e.ext,o=c}r.forEach(i=>{i&&(b=B(i.extruder,r,w,b,e.z,t))}),w.length&&z.append(w),w.layer=M++,n(M/E),M===E&&w.length&&(w.last().retract=!0),T=[],w=[],e=void 0}},printExport:function(e,t){let i,l,r,o,s,a,u,c,d,f,h=e.output,x=p(e.settings),g=x.device,m=g.extruders,y=x.process,z=g.gcodeFan,S=g.gcodeLayer,b=g.gcodeTrack,F=0,E=m[F],M=E.extOffsetX,v=E.extOffsetY,w=g.extrudeAbs,T=0,P=0,O=[],k=g.gcodePause,_=[],H=0,B=0,D=5,L=0,A=0,R=0,$=0,G={x:0,y:0,z:0,f:0},N=null,W=0,j=y.zHopDistance||0,I=60*y.outputSeekrate,C=y.outputRetractDist,X=60*y.outputRetractSpeed,Y=y.outputRetractDwell||0,Z=Y/1e3,q=y.outputOriginCenter?null:{x:g.bedWidth/2,y:g.bedDepth/2},K={retract_speed:X,retract_distance:C,temp:y.firstLayerNozzleTemp||y.outputTemp,temp_bed:y.firstLayerBedTemp||y.outputBedTemp,bed_temp:y.firstLayerBedTemp||y.outputBedTemp,fan_speed:y.outputFanMax,speed:y.outputFanMax,top:q?g.bedDepth:g.bedDepth/2,left:q?0:-g.bedWidth/2,right:q?g.bedWidth:g.bedWidth/2,bottom:q?0:-g.bedDepth/2,z_max:g.maxHeight,layers:h.length,nozzle:0,tool:0},V=0,J=0;(y.gcodePauseLayers||"").split(",").forEach(function(e){let t=parseInt(e);t>=0&&O.push(t)}),f=t?function(e){e&&(V++,J+=e.length,_.append(e)),(!e||_.length>1e3)&&(t(_.join("\n")),_=[])}:function(e){e&&(_.append(e),V++,J+=e.length)};function Q(t){f(e.constReplace(t,K))}function U(e){e.forEach(function(e){Q(e)})}f(`; Generated by Kiri:Moto ${exports.VERSION}`),f(`; ${(new Date).toString()}`),Q("; Bed left:{left} right:{right} top:{top} bottom:{bottom}"),f(`; Target: ${x.filter[x.mode]}`),f("; --- process ---");for(let e in y)f("; "+e+" = "+y[e]);f("; --- startup ---");let ee=!1,te=!1;for(let e=0;e<g.gcodePre.length;e++){let t=g.gcodePre[e];t.indexOf("T0")>=0?ee=!0:t.indexOf("T1")>=0?te=!0:t.indexOf("M82")>=0?w=!0:t.indexOf("M83")>=0?w=!1:t.indexOf("G90")>=0?w=!0:t.indexOf("G91")>=0?w=!1:0===t.indexOf("G92")&&t.split(";")[0].split(" ").forEach(function(e){let t=parseFloat(e.substring(1)||0)||0;switch(e[0]){case"X":G.x=t;break;case"Y":G.y=t;break;case"Z":G.z=t;break;case"E":H=t}}),w&&t.indexOf("E")>0&&t.split(";")[0].split(" ").forEach(function(e){"E"==e[0]&&(H=Math.max(H,parseFloat(e.substring(1))||0))}),Q(t)}function ie(e){f(`G4 P${e}`),T+=Z}function ne(e){le({e:-($=C)},X,`e-retract ${C}`),e&&le({z:W+e},I,"z-hop start"),T+=C/X*60*2}function le(e,t,i){i&&f(";; "+i);let n=[t||e.e?"G1":"G0"];"number"==typeof e.x&&(G.x=e.x,n.append(" X").append(G.x.toFixed(D))),"number"==typeof e.y&&(G.y=e.y,n.append(" Y").append(G.y.toFixed(D))),"number"==typeof e.z&&(G.z=e.z,n.append(" Z").append(G.z.toFixed(D))),"number"==typeof e.e&&(H+=e.e,w?n.append(" E").append(H.toFixed(D)):n.append(" E").append(e.e.toFixed(D))),t&&t!=G.f&&(n.append(" F").append(Math.round(t)),G.f=t);let l=n.join("");N!=l&&(N=l,f(l))}let re=[],oe=0;h.forEach(function(e){re.appendAll(e)}),re.forEachPair(function(e,t){oe+=e.point.distTo2D(t.point)},1),ne();for(;P<h.length;){for(l=h[P],a=e.extrudePerMM(E.extNozzle,E.extFilament,0===l.layer?y.firstSliceHeight||y.sliceHeight:l.height),K.z=(W+l.height).toFixed(3),K.Z=K.z,K.layer=P,K.height=l.height.toFixed(3),k&&O.indexOf(P)>=0&&U(k),S&&S.length?U(S):f(`;; --- layer ${P} (${K.height} @ ${K.z}) ---`),P>0&&y.layerRetract&&ne(),z&&P===y.outputFanLayer&&Q(z),1===P&&(y.firstLayerNozzleTemp&&(K.temp=y.outputTemp,ee&&Q("M104 S{temp} T0"),te&&Q("M104 S{temp} T1"),ee||te||Q("M104 S{temp} T{tool}")),y.firstLayerBedTemp&&(K.bed_temp=K.temp_bed=y.outputBedTemp,Q("M140 S{temp_bed} T0"))),le({z:W+=l.height},I),i=0;i<l.length;i++){if(r=l[i],o=60*(r.speed||y.outputFeedrate),void 0!==r.tool&&r.tool!==F&&(F=r.tool,K.nozzle=K.tool=F,E=m[F],M=E.extOffsetX,v=E.extOffsetY,a=e.extrudePerMM(E.extNozzle,E.extFilament,0===l.layer?y.firstSliceHeight||y.sliceHeight:l.height),U(E.extSelect)),!r.point){ie(r.speed);continue}let t=r.point.x+M,n=r.point.y+v;r.point.z;y.outputInvertX&&(t=-t),y.outputInvertY&&(n=-n),q&&(t+=q.x,n+=q.y),d=u?u.distTo2D(r.point):0,r.emit&&$&&(j&&G.z!=W&&le({z:W},I,"z-hop end"),le({e:$},X,`e-engage ${$}`),$=0,Y&&ie(Y),T+=C/X*60*2),u&&r.emit?(s=a*r.emit*d,le({x:t,y:n,e:s},o),R+=s):le({x:t,y:n},I),!$&&r.retract&&ne(j),T+=d/o*60*1.5,A+=d,K.progress=L=Math.round(A/oe*100),b&&L!=B&&(Q(b),B=L),u=r.point,c=r.emit}P++}return K.time=n.round(T,2),K.material=n.round(R,2),f("; --- shutdown ---"),U(g.gcodePost),f(`; --- filament used: ${K.material} mm ---`),f(`; --- print time: ${T.toFixed(0)}s ---`),f(),e.distance=R,e.lines=V,e.bytes=J+V-1,e.time=T,t?null:_.join("\n")}},e.slicer),s=t.newPoint;function p(e){return Object.entries(e.widget).forEach(t=>{let[i,n]=t;e.device.extruders[n.extruder]||(e.widget[i].extruder=0)}),e}self.kiri_fdm_xyz_mini_w=function(e,t){return btoa("; filename = kirimoto.gcode\n; machine = dv1MW0A000\n"+e)}}();