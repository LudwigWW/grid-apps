"use strict";var gs_kiri_cam=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.driver||(self.kiri.driver={}),self.kiri.driver.CAM)return;let n=self.kiri,e=self.base,t=e.util,o=e.polygons,i=(n.driver.CAM={slice:function(n,t,l,a){let c,E,b,T=n,k=T.process,I=t.slices=[],w=n.controller.units,O="in"===w?25.4:1,D=m(T,k.roughingTool),P=m(T,k.finishingTool),F=m(T,k.drillTool),C=k.roughingOn&&k.roughingDown&&D,_=k.finishingOn&&k.finishingDown&&P,v=k.finishingXOn&&k.finishingPlunge&&P,H=k.finishingYOn&&k.finishingPlunge&&P,Z=_||v||H,N=k.roughingOn&&k.camZTopOffset,A=k.drillingOn&&k.drillDown&&k.drillDownSpeed,G=s(.1,r(k.roughingDown,k.finishingDown)/3)*O,X=k.camPocketOnlyRough,B=k.camPocketOnlyFinish,R=C&&k.camTabsOn&&!X,Y=_&&k.camTabsOn&&!B,L=k.camTabsWidth*O,W=k.camTabsHeight*O,j=t.mesh,U=t.getBoundingBox(),$=s(U.min.z,k.camZBottom)*O;if(n.stock.x+1e-5<U.max.x-U.min.x)return a("stock X too small for part. disable or use offset stock");if(n.stock.y+1e-5<U.max.y-U.min.y)return a("stock Y too small for part. disable or use offset stock");if(n.stock.z+1e-5<U.max.z-U.min.z)return a("stock Z too small for part. disable or use offset stock");if(G<=.05)return a(`invalid slice depth (${G.toFixed(2)} ${w})`);if(!(C||Z||N||A))return a("no processes selected");const q=function(n,t){if(n.z>$+W)return;if(0===n.tops.length)return;let o,i,l,r=0;n.tops[0].traces.forEach(function(n,e){(l=n.area())>r&&(r=l,i=e,o=n)}),o.setClockwise();let s=k.camTabsCount,a=k.camTabsAngle,c=360/s,f=e.newPoint(0,0,n.z),u=(L+t)/2,h=[],p=[];for(;s-- >0;){let n=e.newSlopeFromAngle(a),t=e.newSlopeFromAngle(a+90),i=f.projectOnSlope(t,u),l=f.projectOnSlope(t,-u),r=i.projectOnSlope(n,1e4),s=l.projectOnSlope(n,1e4),p=o.intersections(i,r).pop(),d=o.intersections(l,s).pop();p&&d&&(h.push(p),h.push(d)),a-=c}if(h.length){h.push(h.shift());for(let n=0;n<h.length;n+=2)p.push(o.emitSegment(h[n],h[n+1]));n.tops[0].traces.splice(i,1,...p)}else console.log(`unable to compute tabs for slice @ ${n.z}`)};M(t,{height:G,cam:!0,zmin:k.camZBottom,noEmpty:!0},function(n){const e=function(n,e){let t,i,l;return n.forEach(function(r,s){i=r.gatherTopPolys([]).clone(!0),t?(i.appendAll(t),t=o.union(i),r.tops=[],t.forEach(function(n){r.addTop(n),n.setZ(r.z)})):t=i,l=r,e&&e(s/n.length)}),l.clone(!1)}(n,function(n){l(.25+.15*n,"shelling")}),t=c=b=e.gatherTopPolys([]);if(c=b=C&&!X?o.expand(c,D/2+k.roughingStock,0):o.expand(c,.01,0),Z&&X&&!B&&(b=o.expand(c,D/2+k.roughingStock,0)),Z&&B&&(E=o.expand(t,-P/2,0)),N){let n=U.max.z,e=n+k.camZTopOffset*O,t=k.roughingDown*O;for(;e>=n;){e-=r(t,e-n);const o=u(e,j.newGroup?j.newGroup():null);if(o.camMode=i.FACING,I.append(o),c.clone().forEach(function(n){o.addTop(n)}),Math.abs(e-n)<.001)break}}if(C){let e=[];S(n,k.roughingDown*O,i.ROUGH,e),I.appendAll(e)}if(_){let e=[];S(n,k.finishingDown*O,i.FINISH,e),I.appendAll(e)}if(A){let e=[],t=.1*F,o=F/2*(F/2)*Math.PI,l=.05*o;n.forEach(function(n){let i=n.gatherTopPolyInners([]);i.forEach(function(n){if(n.circularity()>=.985&&Math.abs(n.area()-o)<=l){let o,i=n.circleCenter(),l=!1,r=1/0;e.forEach(function(n){l||((o=n.last().distTo2D(i))<=t&&(l=!0,n.push(i)),r=Math.min(r,o))}),l||e.push(p().append(i))}})}),e.forEach(function(n){let e=n.center(!0),t=u(0,null);n.points.forEach(function(n){n.x=e.x,n.y=e.y}),t.camMode=i.DRILL,t.addTop(null).traces=[n],I.append(t)})}},function(n){l(0+.25*n,"slicing")}),(C||Z)&&function(n,e,t,o){let l,r,a,c,x,E,S,b,T,k=n.mesh,I=e.process,w=e.process,O="in"===e.controller.units?25.4:1,D=w.camTolerance*O,P=m(e,I.finishingTool),F=(g(e,I.finishingTool),P*I.finishingOver),C=I.camPocketOnlyFinish,_=n.getBoundingBox().clone(),v=_.min.x,H=_.max.x,Z=_.min.y,N=_.max.y,A=H-v,G=N-Z,X=I.finishingAngle,B=I.finishCurvesOnly,R=180/Math.PI,Y=Math.ceil(A/D),L=Math.ceil(G/D),W=new Float32Array(Y*L),j=n.topo={data:W,stepsx:Y,stepsy:L,bounds:_,diameter:P,resolution:D},U=y(e,I.finishingTool,j),$=[],q=d();function K(n,e){return z(j,U,n,e)}function V(n,e,t){let o=h(n,e,t);E&&E.z===t?B?J():x=o:(x&&(a.push(x),x=null),a.push(o)),E=o}function J(){x&&a.push(x),a.length>0&&(a.length>1&&c.push(a),a=p().setOpen()),x=void 0,E=void 0}M(n,{height:D,swapX:!0,topo:!0},function(n){let e,g,m,y,x,z,M,E=0,O=s(_.min.z,w.camZBottom)+1e-4;for(let t=0,i=n.length;t<i;t++){let i=n[t],l=i.lines;for(e=0,x=Z;x<=N;x+=D){m=W[g=E*L+e]||0;for(let n=0,e=l.length;n<e;n++){let e=l[n],t=e.p1,o=e.p2;if((t.z>O||o.z>O)&&(t.z>m||o.z>m)&&(t.y<=x&&o.y>=x||o.y<=x&&t.y>=x)){let n=t.y-o.y,e=t.z-o.z,i=(t.y-x)/n,l=t.z-e*i;l>m&&(m=W[g]=Math.max(l,O))}}e++}o(.2+ ++E/Y*.5,"topo tracing")}if(I.finishingXOn)for(q=d(),y=v;y<=H;y+=F){for(E=Math.round((y-v)/A*Y),T=e=0,(S=u(E,k.newGroup?k.newGroup():null)).camMode=i.FINISH_X,S.lines=l=[],r=S.addTop(p().setOpen()).poly,a=p().setOpen(),c=S.tops[0].traces=[],x=Z;x<N;x+=D)if(C&&0===(W[E*L+e]||0))J(),e++,T=0;else if(0!==(z=K(E,e))){if(T){k&&l.push(f(h(y,T,M),h(y,x,z)));let n=Math.abs(Math.atan2(M-z,D)*R%90);n>X&&(M>z?V(y,x,M):V(y,T,z))}V(y,x,z),T=x,M=z,e++}else J(),e++,T=0;J(),c.length>0&&$.push(S),o(.7+E/Y*.15,"linear x")}if(I.finishingYOn)for(q=d(),x=Z;x<=N;x+=F){for(e=Math.round((x-Z)/G*L),b=E=0,(S=u(e,k.newGroup?k.newGroup():null)).camMode=i.FINISH_Y,S.lines=l=[],r=S.addTop(p().setOpen()).poly,a=p().setOpen(),c=S.tops[0].traces=[],y=v;y<=H;y+=D)if(C&&0===(W[E*L+e]||0))J(),E++,T=0;else if(0!==(z=K(E,e))){if(b){k&&l.push(f(h(b,x,M),h(y,x,z)));let n=Math.abs(Math.atan2(M-z,D)*R%90);n>X&&(M>z?V(y,x,M):V(b,x,z))}V(y,x,z),b=y,M=z,E++}else J(),E++,b=0;J(),c.length>0&&$.push(S),o(.85+e/L*.15,"linear y")}t($)},function(n){o(0+.2*n,"topo slicing")})}(t,n,function(n){I.appendAll(n)},function(n,e){l(.4+.5*n,e||"create topo")});let K,V;_&&"endmill"!==(K=g(T,k.finishingTool)).type&&(V=y(T,k.finishingTool,t.topo));I.forEach(function(n,e){n.index=e;let r="?mode?";switch(n.camMode){case i.FACING:r="facing",function(n,e,t,i,l){let r=[],s=[];e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(s)}),s=o.nest(s),o.expand(s,-t/2,n.z,r,0,-t*i),l||(s=o.flatten(r.slice(),[]),e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(s)}),r=o.nest(s));n.tops.length||(console.log({no_top:n.z}),n.addTop());n.tops[0].traces=r}(n,b,D,k.roughingOver,X);break;case i.ROUGH:r="roughing",function(n,e,t,i,l,r){let s=n.gatherTopPolys([]).clone(!0),a=[],c=[];e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(c)}),o.flatten(s,c,!0),c.forEach(function(n){n.setClosed()}),c=o.nest(c),o.expand(c,-(t/2+i),n.z,a,0,-t*l),r||(c=o.flatten(a.slice(),[],!0),e.clone(!0).forEach(function(e){e.setZ(n.z).flattenTo(c),e.setClosed()}),a=c);n.tops[0].traces=a}(n,c,D,k.roughingStock*O,k.roughingOver,X),R&&q(n,D);break;case i.FINISH:r="finishing",V&&function(n,e,t,o,i){let l=!i,r=[],s=[];e.gatherTopPolys([]).forEach(n=>n.flattenTo(r)),r.forEach(e=>{let t=e.first().z,i=-1/0,r=p().setOpen();if(e.forEachSegment((e,a)=>{let c=x(n,o,e.x,e.y,a.x,a.y);c>i&&(i=c),c-t<.01?r.length?r.first().isEqual(a)?r.setClosed():r.append(a):r.append(e).append(a):r.length&&(l||s.append(r),r=p().setOpen())}),r.length){r.length===e.length&&r.setClosed();let n=e.parent;r.isClosed()&&n&&(n.inner&&(n.inner=n.inner.filter(n=>n!==e)),l&&s.append(r)),l||s.append(r)}}),s.length&&(e.tops[0].inner=s)}(t,n,0,V),function(n,e,t,i){if(0===n.tops.length)return e;let l=n.gatherTopPolys([]).clone(!0),r=o.expand(l,t/2,n.z);i&&(r=o.filter(o.diff(e,r,n.z),[],function(n){if(n.area()<1)return null;for(let t=0;t<e.length;t++)if(n.isEquivalent(e[t]))return n.inner?n.inner:null;return n}));const s=o.flatten(r,[],!0);n.tops[0].traces=s,n.tops[0].inner}(n,E,P,B),Y&&q(n,P)}l(.9+e/I.length*.1,r)},"cam post"),a()},sliceRender:function(n){let e=n.slices;if(!e)return;e.forEach(function(n){let e,t=n.tops,o=n.layers,l=o.outline,r=n.camMode===i.FINISH_X||n.camMode===i.FINISH_Y;o.outline.clear(),o.trace.clear(),o.solid.clear(),o.bridge.clear(),o.flat.clear(),o.fill.clear(),t.forEach(function(n){l.poly(n.poly,10066176,!0,r),n.inner&&l.poly(n.inner,14540253,!0)}),n.tops.forEach(function(t){switch(n.camMode){case i.FINISH:e=o.solid;break;case i.FINISH_X:e=o.bridge;break;case i.FINISH_Y:e=o.flat;break;default:e=o.trace}t.traces&&e.poly(t.traces,0,!0,null)}),e=n.layers.fill,n.tops.forEach(function(n){n.fill_lines&&e.lines(n.fill_lines,fill_color)}),l.render(),o.trace.render(),o.solid.render(),o.bridge.render(),o.flat.render(),o.fill.render()})},printSetup:function n(e,t,l,a){let c=l||0,f=e.widgets,u=f.length,p=f[c];if(c>=u||!p)return;let d,z,M,E,S,b,T,k,I,w,O,D=e.settings,P=D.device,F=D.process,C=D.stock,_=D.bounds,v=_.max.z,H=p.slices,Z=p.getCamBounds(D),N=Z.max.z,A="in"===D.controller.units?25.4:1,G=F.camStockZ&&F.camStockX&&F.camStockY,X=F.outputOriginCenter,B=D.controller.alignTop,R=(F.camZClearance||1)*A,Y=G?C.z+R:v+R,L=G?C.z-N:B?v-N:0,W=v+R,j=X?0:G?-C.x/2:Z.min.x,U=X?0:G?-C.y/2:Z.min.y,$=h(j,U,W),q=(e.output,i),K=F.camDepthFirst,V=F.camEaseDown,J=F.camTolerance*A,Q=F.drillDown*A,nn=F.drillLift*A,en=F.drillDwell,tn=0===c?[]:e.output,on=[],ln=!0,rn=0,sn=P.spindleMax,an=e.addOutput,cn=e.tip2tipEmit,fn=e.poly2polyEmit,un=e.poly2polyDepthFirstEmit;function hn(){on.length<2||(tn.push(on),on=[])}function pn(n,e,t,o){on.mode=w,an(on,n,e,t,o)}function dn(n,e,t){n!==I&&(M=g(D,n),E=m(D,n),S=E,p.topo&&(b=y(D,n,p.topo)),I=n),T=e,k=t}function gn(n,e,t,o){let i=n.first().z-n.last().z,l=[],r=n.first();for(;;){if(!(i>2*e)){if(i<e){l.push(r.clone()),r.z-=i,l.push(r.clone());break}l.push(r.clone()),r.z-=i/2,l.push(r.clone()),r.z-=i/2,l.push(r.clone());break}l.push(r.clone()),r.z-=e,i-=e}l.forEach(function(n,e){mn(n,1),e<l.length-1&&(o&&pn(null,0,o,M.number),t&&mn(n.clone().setZ(n.z+t),0))}),mn(r.clone().setZ(W)),hn()}function mn(n,e){let t=p.mesh.position.x,o=p.mesh.position.y;(n=n.clone()).x+=t,n.y+=o,n.z+=L,ln&&(e=0,ln=!1);let i=T;if(O||(O=h($.x,$.y,n.z)),O){let l=O.distTo2D(n),a=n.z-O.z,c=Math.abs(a),f=!e;if(l<.001&&n.z===O.z)return void console.trace(["drop dup",O,n]);if(f&&l<=S&&(c<=J?(e=1,f=!1):a<=-J&&(pn(n.clone().setZ(O.z),0,0,M.number),l=0)),(l>E||a>E&&l>J)&&(f||c>=J)){let e=b?s(x(p,b,O.x-t,O.y-o,n.x-t,n.y-o)+L,n.z,O.z):W,i=s(e-n.z,e-O.z)>=J,r=e;i&&(r=e+R,pn(O.clone().setZ(r),0,0,M.number)),(i||n.z<e)&&(pn(n.clone().setZ(r),0,0,M.number),l=0)}if(a<=-J){let n=r(l/2,c),e=n/c;i=n&&e&&l>J?Math.round(k+(T-k)*e):k}}else pn(n.clone().setZ(W),0,0,M.number);pn(n,e?1:0,i,M.number),O=n,on.spindle=rn}O=a;d=a||$;let yn={rough:[],finish:[],roughDiam:0,finishDiam:0,linearx:[],lineary:[],layer:0,drill:[]};H.forEach(function(n,e){switch(yn.layer++,z=n.camMode!=w,w=n.camMode,ln=!0,z&&(yn.layer=0),n.camMode){case q.FACING:dn(F.roughingTool,F.roughingSpeed,0),rn=Math.min(sn,F.roughingSpindle),n.tops.forEach(function(n){if(!n.traces)return;let e=[];n.traces.forEach(function(n){e.push(n),n.inner&&n.inner.forEach(function(n){e.push(n)})}),o.setWinding(e,F.outputClockwise,!1),d=fn(e,d,function(n,e,t){n.forEachPoint(function(n,e,t,o){mn(n.clone(),0!==o)},!0,e)}),hn()});break;case q.ROUGH:case q.FINISH:let e=F.outputClockwise;n.camMode===q.ROUGH?(dn(F.roughingTool,F.roughingSpeed,F.roughingPlunge),rn=Math.min(sn,F.roughingSpindle),yn.roughDiam=E):(dn(F.finishingTool,F.finishingSpeed,F.finishingPlunge),rn=Math.min(sn,F.finishingSpindle),yn.finishDiam=E,F.camPocketOnlyFinish||(e=!e)),n.tops.forEach(function(t){if(!t.poly)return;if(!t.traces)return;let i=[],l=[],r=[];o.flatten(t.traces,t.inner||[]).forEach(function(n){let e=n.parent;K&&(n=n.clone(!0)),e?r.push(n):l.push(n),n.layer=yn.layer,i.push(n)}),o.setWinding(l,e),o.setWinding(r,!e),K?(n.camMode===q.ROUGH?yn.rough:yn.finish).append(i):(d=fn(i,d,function(n,e,t){n.forEachPoint(function(n,e,t,o){mn(n.clone(),0!==o)},n.isClosed(),e)}),hn())});break;case q.FINISH_X:case q.FINISH_Y:!z&&d||(d=h(Z.min.x,Z.min.y,W)),dn(F.finishingTool,F.finishingSpeed,F.finishingPlunge),rn=Math.min(sn,F.finishingSpindle),yn.finishDiam=E,n.tops.forEach(function(e){if(!e.traces)return;let t,o=[];e.traces.forEach(function(n){K&&(n=n.clone(!0)),o.push({first:n.first(),last:n.last(),poly:n})}),K?(n.camMode===q.FINISH_X?yn.linearx:yn.lineary).appendAll(o):(d=cn(o,d,function(n,e,o){return(t=n.poly).last()===e&&t.reverse(),t.forEachPoint(function(n,e){mn(n.clone(),e>0)},!1),O}),hn())});break;case q.DRILL:dn(F.drillTool,F.drillDownSpeed,F.drillDownSpeed),n.tops.forEach(function(n){n.traces&&yn.drill.appendAll(n.traces)})}t(e/H.length)});if(K)if(yn.rough.length>0&&(dn(F.roughingTool,F.roughingSpeed,F.roughingPlunge),rn=Math.min(sn,F.roughingSpindle),d=un(yn.rough,d,function(n,e,t,o){let i=null;return V&&n.isClosed()?i=n.forEachPointEaseDown(function(n,e){mn(n.clone(),e>0)},o):n.forEachPoint(function(n,e,t,o){mn(n.clone(),0!==o)},n.isClosed(),e),hn(),i},yn.roughDiam*F.roughingOver*1.01)),yn.finish.length>0&&(dn(F.finishingTool,F.finishingSpeed,F.finishingPlunge),rn=Math.min(sn,F.finishingSpindle),d=un(yn.finish,d,function(n,e,t,o){let i=null;return V&&n.isClosed()?i=n.forEachPointEaseDown(function(n,e){mn(n.clone(),e>0)},o):n.forEachPoint(function(n,e,t,o){mn(n.clone(),0!==o),i=n},n.isClosed(),e),hn(),i},.01*yn.finishDiam)),F.finishCurvesOnly){dn(F.finishingTool,F.finishingSpeed,F.finishingPlunge),rn=Math.min(sn,F.finishingSpindle);let n=[].appendAll(yn.linearx).appendAll(yn.lineary);d=cn(n,d,function(n,e,t){let o=n.poly;return o.last()===e&&o.reverse(),o.forEachPoint(function(n,e){mn(n.clone(),e>0)},!1),hn(),O})}else dn(F.finishingTool,F.finishingSpeed,F.finishingPlunge),rn=Math.min(sn,F.finishingSpindle),yn.linearx.length>0&&(d=cn(yn.linearx,d,function(n,e,t){let o=n.poly;return o.last()===e&&o.reverse(),o.forEachPoint(function(n,e){mn(n.clone(),e>0)},!1),hn(),O})),yn.lineary.length>0&&(d=cn(yn.lineary,d,function(n,e,t){let o=n.poly;return o.last()===e&&o.reverse(),o.forEachPoint(function(n,e){mn(n.clone(),e>0)},!1),hn(),O}));yn.drill.length>0&&(dn(F.drillTool,F.drillDownSpeed,F.drillDownSpeed),function(n){for(n=n.slice();;){let e,t,o=1/0,i=null;for(let l=0;l<n.length;l++)n[l]&&(t=n[l].first().distTo2D(d))<o&&(o=t,i=n[l],e=l);if(!i)return;n[e]=null,d=i.first(),gn(i,Q,nn,en)}}(yn.drill));O&&an(tn[tn.length-1],d=O.clone().setZ(Y),0,0,M.number);e.output=tn;c+1<u&&n(e,t,c+1,d)},printExport:function(n,e){let o=n.widgets[0];if(!o)return;let i,r,s,a,c,f=0,u=0,h=0,p=[],d=0,g=n.settings,m=(g.device,g.device||{}),y=m.gcodeSpace?" ":"",x=m.gcodeStrip||!1,z=m.gcodeChange||["M6 T{tool}"],M=m.gcodeSpindle||["M3 S{speed}"],E=m.gcodeDwell||["G4 P{time}"],S=o.getCamBounds(g),b=1,T=g.process,k=g.device,I=4,w={x:null,y:null,z:null,f:null,t:null},O=0,D=0,P=T.camStockZ&&T.camStockX&&T.camStockY?g.stock.z:S.max.z,F={max:{x:-1/0,y:-1/0,z:-1/0},min:{x:1/0,y:1/0,z:1/0}},C={x:-g.origin.x,y:g.origin.y},_={tool:0,tool_name:"unknown",top:(C?k.bedDepth:k.bedDepth/2)*b,left:(C?0:-k.bedWidth/2)*b,right:(C?k.bedWidth:k.bedWidth/2)*b,bottom:(C?0:-k.bedDepth/2)*b,time_sec:0,time_ms:0,time:0};c=e?function(n){n&&(u++,h+=n.length,p.append(n)),(!n||p.length>1e3)&&(e(p.join("\n")),p=[])}:function(n){n&&(p.append(n),u++,h+=n.length)};function v(e,t){if(e)for(i=0;i<e.length;i++)r=n.constReplace(e[i],t),x&&(s=r.indexOf(";"))>=0&&0===(r=r.substring(0,s).trim()).length||c(r)}function H(n){let e=n.toString(),t=e.indexOf(".");return t<0?e+".0":e}if(!x){c(`; Generated by Kiri:Moto ${exports.VERSION}`),c(`; ${(new Date).toString()}`),v(["; Bed left:{left} right:{right} top:{top} bottom:{bottom}"],_),c(`; Target: ${g.filter[g.mode]}`),c("; --- process ---");for(let n in T)c("; "+n+" = "+T[n])}v(m.gcodePre,_),n.output.forEach(function(n){n.forEach(function(n){(a=n.point)&&!a.mod&&(a.mod=1,C&&(a.x+=C.x,a.y+=C.y),T.outputInvertX&&(a.x=-a.x),T.outputInvertY&&(a.y=-a.y),T.camOriginTop&&(a.z=a.z-P))})}),n.output.forEach(function(n){O!==n.mode&&(O&&!x&&c("; ending "+l[O]+" after "+Math.round(f/60)+" seconds"),O=n.mode,x||c("; starting "+l[O])),n.spindle&&n.spindle!==d&&((d=n.spindle)>0?v(M,{speed:Math.abs(d)}):c("M4")),n.forEach(function(n){!function(n){let e=n.point;if(0===D&&(w.x=e.x,w.y=e.y),!e)return f+=n.speed/60,_.time_sec=n.speed/1e3,_.time_ms=n.speed,_.time=_.time_sec,void v(E,_);e.x=t.round(e.x,I),e.y=t.round(e.y,I),e.z=t.round(e.z,I),n.tool!=w.t&&(w.t=n.tool,_.tool=w.t,_.tool_name=function(n,e){for(let t=0;t<e.length;t++)if(e[t].number===n)return e[t].name;return"unknown"}(n.tool,g.tools),v(z,_));let o=n.speed,i=o||T.camFastFeed,l=[o?"G1":"G0"],r=e.x-w.x,s=e.y-w.y,a=e.z-w.z,u=Math.sqrt(r*r+s*s+a*a);(r||s||a)&&(e.x!==w.x&&(w.x=e.x,F.min.x=Math.min(F.min.x,w.x),F.max.x=Math.max(F.max.x,w.x),l.append(y).append("X").append(H(w.x*b))),e.y!==w.y&&(w.y=e.y,F.min.y=Math.min(F.min.y,w.y),F.max.y=Math.max(F.max.y,w.y),l.append(y).append("Y").append(H(w.y*b))),e.z!==w.z&&(w.z=e.z,F.min.z=Math.min(F.min.z,w.z),F.max.z=Math.max(F.max.z,w.z),l.append(y).append("Z").append(H(w.z*b))),i&&i!==w.f&&(w.f=i,l.append(y).append("F").append(i*b)),f+=u/(w.f||1e3)*60,c(l.join("")),D++)}(n)})}),O&&!x&&c("; ending "+l[O]+" after "+Math.round(f/60)+" seconds");return v(m.gcodePost,_),c(),n.time=f,n.lines=u,n.bytes=h+u-1,n.bounds=F,e?null:p.join("\n")},getToolById:g,getToolDiameter:m}).process={ROUGH:1,FINISH:2,FINISH_X:3,FINISH_Y:4,FACING:5,DRILL:6},l=["unset","roughing","finishing","linear-x","linear-y","facing","drilling"],r=Math.min,s=Math.max,a=Math.PI/2,c=n.slicer,f=e.newLine,u=n.newSlice,h=e.newPoint,p=e.newPolygon,d=t.time;function g(n,e){for(let t=0,o=n.tools;t<o.length;t++)if(o[t].id===e)return o[t];return null}function m(n,e){let t=g(n,e);return t?(t.metric?1:25.4)*t.flute_diam:0}function y(n,e,t){let o=g(n,e),i="ballmill"===o.type,l="tapermill"===o.type,r=function(n,e){let t=g(n,e);return t?(t.metric?1:25.4)*t.shaft_diam:0}(n,e),s=r/t.resolution,c=Math.round(s),f=s/2,u=function(n,e){let t=g(n,e);return t?(t.metric?1:25.4)*t.flute_len:0}(n,e),h=m(n,e),p=h/2,d=h/t.resolution/2,y=function(n,e){let t=g(n,e);return t?(t.metric?1:25.4)*t.taper_tip:0}(n,e)/t.resolution/2,x=d-y,z=c+(1-c%2),M=(c-c%2)/2,E=[],S=r-h>.001;for(let n=0;n<z;n++)for(let e=0;e<z;e++){let t=n-M,o=e-M,r=Math.sqrt(t*t+o*o);if(r<=d){let n=0;i?n=(1-Math.cos(r/d*a))*-p:l&&r>=y&&(n=(r-y)/x*-u),E.push(t,o,n)}else u&&S&&r<=f&&E.push(t,o,-u)}return E}function x(n,e,t,o,i,l){let r=n.topo,s=r.resolution,a=n.getBoundingBox(),c=i-t,f=l-o,u=Math.max(Math.abs(c),Math.abs(f))/s,h=c/u,p=f/u,d=0;for(;u-- >0;){let n=Math.round((t-a.min.x)/s),i=Math.round((o-a.min.y)/s);d=Math.max(d,z(r,e,n,i,!0)),t+=h,o+=p}return d}function z(n,e,t,o,i){let l,r=0,s=-1;const a=n.stepsx,c=n.stepsy;for(;r<e.length;){let f=e[r++]+t,u=e[r++]+o,h=e[r++];l=f<0||f>=a||u<0||u>=c?0:n.data[f*c+u]||0,i&&0===l&&(l=n.bounds.max.z),s=Math.max(h+l,s)}return Math.max(s,0)}function M(n,e,t,o){c.sliceWidget(n,e,t,o)}function E(n,e){let t,o=null,i=1/0;return n.forEach(function(n){(t=Math.abs(n.z-e))<i&&(o=n,i=t)}),o}function S(n,e,t,o){let i,l,r=[];let s=[n[0]];n.forEach(function(n){n.hasFlats&&s.push(n)});let a=[];s.forEachPair(function(t,o){if(o.z>t.z)return;let i=Math.abs(o.z-t.z),l=i/e,r=e,s=l-Math.floor(l),c=.02*e;if(!(Math.abs(i-e)<c)){s>c&&(r=i/Math.ceil(l));for(let e=t.z-r;e>=o.z+r/2;e-=r)a.push(E(n,e))}},1),s.appendAll(a),s.sort(function(n,e){return e.z-n.z}),(s=s.slice(1)).forEach(function(n){!function(n){if(i!==n){if(i=n,n.camMode){let e=u(n.z);n.tops.forEach(function(n){e.addTop(n.poly.clone(!0))}),n=e}n.camMode=t,l=n.z,r.push(n)}}(n)}),r.forEach(function(n){o.push(n)})}}();