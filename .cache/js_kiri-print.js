"use strict";let gs_kiri_print=exports;!function(){self.kiri||(self.kiri={});let t=self.kiri,e=t.driver,n=(e.LASER,e.CAM,e.FDM,self.base),i=n.util,r=(n.debug,n.polygons),o=(Math.sqrt,i.sqr),s=Math.PI,l=f.prototype,u=n.Polygon,p=(n.newPoint,null),a=null;function f(t,e,n){this.id=n||(new Date).getTime().toString(36),this.settings=t,this.widgets=e,this.group=new THREE.Group,this.printView=[],this.movesView=[],this.time=0,this.lines=0,this.bytes=0,this.output=[],this.distance=0,this.bounds=null,this.imported=null}function c(t,e){return void 0!==t?t:e}function h(t){let e=Math.floor(6*t.h),n=t.h-e*(1/6),i=t.v*(1-t.s),r=t.v*(1-t.s*n),o=t.v*(1-t.s*(1-n)),s={};switch(e){case 0:s.r=t.v,s.g=o,s.b=i;break;case 1:s.r=r,s.g=t.v,s.b=i;break;case 2:s.r=i,s.g=t.v,s.b=o;break;case 3:s.r=i,s.g=r,s.b=t.v;break;case 4:s.r=o,s.g=i,s.b=t.v;break;case 5:s.r=t.v,s.g=i,s.b=r}return s}function d(t,e,n,i,r){p&&e&&e.x==p.x&&e.y==p.y&&e.z==p.z&&a==n||(p=e,a=n,t.push(new function(t,e,n,i){this.point=t,this.emit=e,this.speed=n,this.tool=i}(e,n,i,r)))}function m(t,e,n,i){n&&t.length>0&&d(e,n,0,void 0,i),e.appendAll(t)}function x(t,e,n){let i,r,o,s=0;for(;o=null,i=1/0,t.forEach(function(t){t.delete||((r=e.distTo3D(t.first))<i&&(o={el:t,first:t.first,last:t.last},i=r),(r=e.distTo3D(t.last))<i&&(o={el:t,first:t.last,last:t.first},i=r))}),o;)o.el.delete=!0,e=n(o.el,o.first,++s);return e}function g(t,e,n,i){let r,o,s,l=0,u=i||"delete";for(;s=null,r=1/0,t.forEach(function(t){if(t[u])return;if(t.isOpen()){const n=e.distTo2D(t.first()),i=e.distTo2D(t.last());if(n>r&&i>r)return;return void(i<r&&i<n?(t.reverse(),s={poly:t,index:0,point:t.first()}):n<r&&(s={poly:t,index:0,point:t.first()}))}let n=t.area();t.forEachPoint(function(i,l){(o=e.distTo3D(i)*n*n)<r&&(s={poly:t,index:l,point:i},r=o)})}),s;)s.poly[u]=!0,e=n(s.poly,s.index,++l,e)||s.point;return t.forEach(function(t){t[u]=!1}),e}function y(t,e,n,i){let r,o,s;return(r=t.indexOf(n))>0?i(o=e[t.substring(0,r)]||0,s=parseInt(t.substring(r+1))||0):null}t.newPrint=function(t,e,n){return new f(t,e,n)},l.addOutput=d,l.tip2tipEmit=x,l.extrudePerMM=function(t,e,n){return s*o(t/2)/(s*o(e/2))*(n/t)},l.constReplace=function t(e,n,i){let r,o,s,l=e.indexOf("{",i||0),u=e.indexOf("}",l);return l>=0&&u>l?(r=e.substring(l+1,u),o=y(r,n,"-",function(t,e){return t-e})||y(r,n,"+",function(t,e){return t+e})||y(r,n,"/",function(t,e){return t/e})||y(r,n,"*",function(t,e){return t*e})||n[r]||0,s=e.replace("{"+r+"}",o),t(s,n,u+1+(s.length-e.length))):e},l.poly2polyEmit=g,l.addPrintPoints=m,l.poly2polyDepthFirstEmit=function(t,e,n,i){let o,s=[];t.forEach(function(t,e){o=[],s.push(o),function t(e,n){if(!e)return;n||(n=[]);Array.isArray(e)?e.forEach(function(e){t(e,n)}):(n.push(e),t(e.inner,n));return n}(r.nest(t,!0,!0)).sort(function(t,e){return e.area()-t.area()}).forEach(function(t){if(t.isOpen()||!t.parent||t.parent.innerCount()>1||!function(t,e,n){return function(t,e,n){let i=1/0;return t.forEachPoint(function(t){const r=t.distToPolySegments(e,n);if((i=Math.min(i,r))<=n)return!0}),i}(t,e,n)<=n}(t,t.parent,i))o.push(t),t.pool=[],t.poolsDown=[];else{let e=t.parent;for(;e&&!e.pool;)e=e.parent;if(!e)return void console.log({orphan:t});e.pool.push(t)}}),o.sort(function(t,e){return t.area()-e.area()});const n=s[e-1];e>0&&o.forEach(function(t){for(let r=0;r<n.length;r++){const o=n[r];if((!o.isOpen()||!t.isClosed())&&(e=o,i=.1,t.isInside(e,i)))return void o.poolsDown.push(t)}var e,i})});const l=function(t){if(t.mark)return;t.mark=!0;const i=t.pool.slice().append(t);return e=g(i,e,n),e=g(t.poolsDown,e,l,"del_pdown")};return s.forEach(function(t){e=g(t,e,l,"del_ptop")}),e},l.parseSVG=function(t,e){let n=[...(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("polyline")],i=this.output=[],r=this.bounds={max:{x:-1/0,y:-1/0,z:-1/0},min:{x:1/0,y:1/0,z:1/0}};n.forEach(t=>{let n=[];[...t.points].forEach(t=>{e&&(t.x+=e.x,t.y+=e.y),t.x&&(r.min.x=Math.min(r.min.x,t.x)),t.x&&(r.max.x=Math.max(r.max.x,t.x)),t.y&&(r.min.y=Math.min(r.min.y,t.y)),t.y&&(r.max.y=Math.max(r.max.y,t.y)),t.z&&(r.min.z=Math.min(r.min.z,t.z)),t.z&&(r.max.z=Math.max(r.max.z,t.z)),d(n,t,n.length>0)}),i.push(n)}),this.imported=t,this.lines=n.length,this.bytes=t.length},l.parseGCode=function(t,e){let n=t.toUpperCase().replace("X"," X").replace("Y"," Y").replace("Z"," Z").replace("E"," E").replace("F"," F").replace("  "," ").split("\n"),i=this,r=i.output=[],o=i.bounds={max:{x:-1/0,y:-1/0,z:-1/0},min:{x:1/0,y:1/0,z:1/0}},s=[],l=!0,u=!1,p=!1,a=function(){u=!0,s.length>0&&(r.push(s),s=[])},f=0,c={X:0,Y:0,Z:0,F:0,E:0},h=e&&e.x||0,m=e&&e.y||0,x=e&&e.z||0,g={X:0,Y:0,Z:0};n.forEach(function(t){let e=(t=t.split(";")[0].split(" ")).shift();if("T"===e.charAt(0)){let t=i.settings.device.extruders,n=parseInt(e.charAt(1));t&&t[n]&&(g.X=-t[n].extOffsetX,g.Y=-t[n].extOffsetY)}switch(e){case"G90":l=!0;break;case"G91":l=!1;break;case"G0":a();case"G1":t.forEach(function(t){c[t.charAt(0)]=parseFloat(t.substring(1))}),c.X&&(o.min.x=Math.min(o.min.x,c.X)),c.X&&(o.max.x=Math.max(o.max.x,c.X)),c.Y&&(o.min.y=Math.min(o.min.y,c.Y)),c.Y&&(o.max.y=Math.max(o.max.y,c.Y)),c.Z&&(o.min.z=Math.min(o.min.z,c.Z)),c.Z&&(o.max.z=Math.max(o.max.z,c.Z)),c.E&&(p=!0),p&&0===c.E&&(f!=c.Z?a():u=!0),d(s,{x:c.X+h+g.X,y:c.Y+m+g.Y,z:c.Z+x+g.Z},!u,c.F,0)}u=!1,c.E=0,f=c.Z}),a(),i.imported=t,i.lines=n.length,i.bytes=t.length},l.setup=function(e,n,i){let r=this,o=r.settings,s=o.mode;if(p=null,a=null,e)t.work.printSetup(o,function(t){t.done?(r.output=t.output,i()):n(t.update,t.updateStatus)});else{let e=t.driver[s];e?e.printSetup(r,n):console.log({missing_print_driver:s}),i()}},l.export=function(e,n,i){let r=t.driver[this.settings.mode];if(!r||!r.printExport)return console.log({missing_export_driver:mode}),void i(null);e?t.work.printExport(this.settings,n,i):r.printExport(this,n,i)},l.exportGCode=function(e,n,i){let r=this,o=r.settings.mode;if(r.imported)return n(r.imported);if(e)t.work.printGCode(function(t){r.lines=t.lines,r.bytes=t.bytes,r.bounds=t.bounds,r.distance=t.distance,r.time=t.time,n(t.gcode)});else{let e=t.driver[o];e&&e.printExport?n(e.printExport(r,i)):(console.log({missing_export_driver:o}),n(null))}},l.exportLaserGCode=function(){return t.driver.LASER.exportGCode(this)},l.exportSVG=function(e){return t.driver.LASER.exportSVG(this,e)},l.exportDXF=function(){return t.driver.LASER.exportDXF(this)},l.encodeOutput=function(){let t,e=[];return this.output.forEach(function(n){t=[],e.push(t),n.forEach(function(e){e.point&&t.push({emit:e.emit,speed:60*e.speed,retract:e.retract,point:{x:e.point.x,y:e.point.y,z:e.point.z}})})}),e},l.render=function(){let e=this,n=e.settings,i=(n.process,n.origin,n.mode),r=t.driver[i];switch(i){case"SLA":r.printRender(e);break;case"CAM":case"FDM":e.renderMoves(!0,8947848);break;case"LASER":e.renderMoves(!1,34986)}},l.renderMoves=function(e,r,o){let s,l,u=t.api.const.LOCAL,p=this,a=o;p.lines=0,p.output.forEach(function(o){let f,c=[],d={};o.forEach(function(t,r){let o=t.point;if(a){if(i.distSq(a,o)<.001&&o.z===a.z)return;if(t.emit>0){let e=t.speed||4e3,n=d[e]||[];d[e]=n,n.push(a),n.push(o)}else c.push(a),c.push(o);if(u&&e&&a.z==o.z){let t=n.newSlope({x:o.x,y:o.y},{x:a.x,y:a.y}),e=n.newSlopeFromAngle(t.angle+25),i=n.newSlopeFromAngle(t.angle-25),r=n.newPoint(o.x,o.y,o.z);c.push(r),c.push(r.projectOnSlope(e,.5)),c.push(r),c.push(r.projectOnSlope(i,.5))}}else f=o.z;a=o}),s=t.newLayer(p.group),p.printView.push(s),e&&((l=t.newLayer(p.group)).lines(c,r),p.movesView.push(l),l.render());for(let t in d){let e=h({h:Math.min(6e3,parseInt(t))/6e3,s:1,v:.6});s.lines(d[t],255*e.r<<16|255*e.g<<8|255*e.b<<0)}s.render(),p.lines+=d.length})},l.getLayerCount=function(){return this.output.length},l.hide=function(){this.printView.forEach(function(t){t.setVisible(!1)}),this.movesView.forEach(function(t){t.setVisible(!1)})},l.showLayer=function(t,e,n){this.printView[t]&&this.printView[t].setVisible(e),this.movesView[t]&&this.movesView[t].setVisible(e&&n)},l.polyPrintPath=function(t,e,n,i){t.setClockwise();let r=i||{},o=this.settings.process,s=(o.outputShortDistance,c(r.extrude,o.outputShellMult)),l=r.rate||o.outputFeedrate,u=o.outputSeekrate,p=o.outputMinSpeed,a=r.simple?t.first():t.findClosestPointTo(e),f=t.perimeter(),h=!0,m=!r.open,x=e,g=(r.wipe,r.coast||0),y=r.tool;return f<o.outputShortPoly&&(l=p+(l-p)*(f/o.outputShortPoly)),t.forEachPoint(function(t,e,i,o){if(h)r.onfirst&&r.onfirst(t),d(n,t,0,u,y),h=!1;else{let e=x.distTo2D(t);if(g&&s&&f-e<=g){let i=e-(f-g),r=x.offsetPointFrom(t,i);d(n,r,s,l,y),s=0}f-=e,d(n,t,s,l,y)}x=t},m,a.index),n.last().point},l.slicePrintPath=function(t,e,o,s,l){let p,a=l||{},f=[],h=this,g=this.settings,y=g.process,E=t.extruder||0,v=g.device.extruders[E].extNozzle,b=a.first||!1,w=(a.minSeek,v*(a.thinWall||1.75)),S=a.retractOver||2,z=a.mult||y.outputFillMult,M=a.mult||y.outputShellMult||(y.laserSliceHeight>=0?1:0),P=y.outputSparseMult,k=y.outputCoastDist||0,D=a.speed||y.outputFinishrate,A=y.firstLayerRate,T=y.firstLayerFillRate,F=y.firstLayerPrintMult,V=a.speed||(b?A:y.outputFeedrate),C=a.speed||a.fillSpeed||(b?T||A:y.outputFeedrate),L=y.outputSeekrate,O=e.add(o),G=y.zHopDistance||0,X=y.antiBacklash,Z=(a.support,t.z);function Y(){f.length&&(f.last().retract=!0)}function _(e,o){let s=!1;return r.flatten(t.gatherTopPolys([])).forEach(function(t){s||t.forEachSegment(function(t,r){if(i.intersect(e,o,t,r,n.key.SEGINT))return s=!0})}),s}function R(t,n){if(t)if(Array.isArray(t))q(t,function(t){R(t,n)},null);else{let i=0===t.depth&&!b;e=h.polyPrintPath(t,e,f,{tool:E,rate:i?D:V,accel:i,wipe:y.outputWipeDistance||0,coast:b?0:k,extrude:c(n,M),onfirst:function(t){e.distTo2D(t)>S&&Y()}})}}function I(t,n,i){if(!t)return;let r=t.map(function(t){return{poly:t,first:t.first(),last:t.last()}}),o=e;e=x(r,e,function(t,e,r){let s=t.poly;return s.last()===e&&s.reverse(),s.forEachPoint(function(t,e){0===e&&o&&o.distTo2D(t)>S&&_(o,t)&&Y(),d(f,t,0===e?0:n,i||V,E),o=t}),o})}function j(t,n){let i,r,o,s,l,u,a,c,h,m,x=0,g=0,y=!1,v=-1,b=n||{},M=b.fast||!1,P=b.fill>=0?b.fill:z;for(;t&&x<t.length;){for(u=!1,a=null,c=1/0,p=g;p<t.length;p+=2)if(!(i=t[p]).del&&(null===a&&i.index>v&&(a=i.index),null!==a)){if(i.index!==a)break;i.index%2==0?(h=t[p],m=t[p+1]):(m=t[p],h=t[p+1]),(s=Math.min(h.distTo2D(e),m.distTo2D(e)))<c&&(r=h,o=m,c=s),g=p,u=!0}if(u)s=e.distTo2D(r),l=r.distTo2D(o),!M&&!y&&s>S?(y=!0,g=0,v=-1):(y=!1,r.del=!0,o.del=!0,x+=2,v=r.index,s<=w&&l<=w?(o=r.midPointTo(o),d(f,o,P*(s/w),C,E)):(!M&&s>S&&(G||_(e,r))&&Y(),!M&&X&&s>S&&d(f,r.add({x:X,y:-X,z:0}),0,L,E),s<w?d(f,r,P,C,E):d(f,r,0,L,E),d(f,o,P,C,E)),e=o);else{if(0===g&&-1===v){console.log("infinite loop",t,{marked:x,options:n,i:p,group:a,start:g,lastIndex:v,points:t.map(t=>t.index).join(", ")});break}g=0,v=-1}}t&&t.forEach(function(t){t.del=!1})}function q(t,n,i,r){if(1===t.length)return n(t[0]);t=t.slice();let o,s,l,u,a;for(;;){for(u=[],o=null,p=0;p<t.length;p++)(l=t[p])&&(s=(a=i?i(l):l).findClosestPointTo(e),u.push({i:p,n:l,d:s.distance-a.depth*w}));if(!1,0===u.length)return;u.sort(function(t,e){return t.d-e.d}),t[u[0].i]=null,n(u[0].n)}}b&&(z*=F,M*=F,P*=F);let H=[];t.tops&&H.appendAll(t.tops),a.support&&t.supports&&H.appendAll(t.supports);let N=null;if(q(H,function(t){if(t instanceof u)t.setZ(Z),R([t].appendAll(t.inner||[])),t.fills&&(t.fills.forEach(function(t){t.z=Z}),j(t.fills,{fast:!0}));else{r.flatten(t.gatherOuter([]));let e=-1;1===e&&R([].appendAll(t.innerTraces()||[])),(t.traces||[]).sort(function(t,n){return t.perimeter()>n.perimeter()?e:-e}).forEach(function(t,e){R(t)}),-1===e&&R([].appendAll(t.innerTraces()||[])),j(t.fill_lines),I(t.fill_sparse,P),N=t}},function(t){return t instanceof u?t:t.poly}),t.tops.length&&t.tops[0].polish){let{x:e,y:n}=t.tops[0].polish;e&&I(e,0,y.polishSpeed),n&&I(n,0,y.polishSpeed)}for(p=0;p<f.length;p++)f[p].point=f[p].point.add(o);return m(f,s,O,E),e.add(o)}}();