"use strict";let gs_meta=exports,gs_meta_debug=!1;THREE.Material.prototype.motoSetup=function(){this.fog=!1,this.transparent=!!gs_meta_debug;let e=this.clone();return e.visible=!1,e.m_hide=e,e.m_show=this,this.m_hide=e,this.m_show=this,this},THREE.Face3.prototype.mVisible=function(e){this.onface.cube.showFace(this.materialIndex,e)},function(){let e=function(e){return document.getElementById(e)},t=self,n=t.document,o=t.location,i=self.base,s=function(e,t,n){return Math.max(t,Math.min(n,e))},r=Math.round,a=Math.PI/2,l=Math.abs,c=.5,u=function(e,t){return e.hasOwnProperty(t)},f=i.polygons,h=self.kiri.Layer,d=(i.Point,i.Polygon),m=self.moto,p=m.Space,y=m.KV,w=kiri.openCatalog(new m.Storage("meta")),b=kiri.openCatalog(new m.Storage("kiri")),E=Ge.prototype,x=_e.prototype,k={seed:"meta-seed",zoom:"meta-zoom",mmode:"meta-mmode",smode:"meta-smode",snames:"meta-names",spaces:"meta-spaces",wspace:"meta-workspc",workid:"meta-work-id",workvr:"meta-work-vr"},z={spaceNames:"meta-names",spaces:"meta-spaces",workspace:"meta-workspc","workspace-i":"meta-work-id","workspace-v":"meta-work-vr"},g=["bt","tb","lr","rl","fb","bf"],v={rl:{mi:0,x:c,y:0,z:0,rx:0,ry:a,rz:0,ox:1,oy:0,oz:0,tx:a,ty:0,tz:0},lr:{mi:1,x:-c,y:0,z:0,rx:0,ry:a,rz:0,ox:-1,oy:0,oz:0,tx:a,ty:0,tz:0},bf:{mi:2,x:0,y:c,z:0,rx:0,ry:0,rz:0,ox:0,oy:1,oz:0,tx:a,ty:0,tz:0},fb:{mi:3,x:0,y:-c,z:0,rx:0,ry:0,rz:0,ox:0,oy:-1,oz:0,tx:a,ty:0,tz:0},tb:{mi:4,x:0,y:0,z:c,rx:a,ry:0,rz:0,ox:0,oy:0,oz:1,tx:0,ty:0,tz:0},bt:{mi:5,x:0,y:0,z:-c,rx:a,ry:0,rz:0,ox:0,oy:0,oz:-1,tx:0,ty:0,tz:0}},S={"00":{x:0,y:1,z:2},"01":{x:0,y:1,z:3},"02":{x:0,y:1,z:0},"03":{x:0,y:1,z:1},10:{x:3,y:0,z:0},11:{x:3,y:0,z:1},12:{x:3,y:0,z:2},13:{x:3,y:0,z:3},20:{x:0,y:0,z:1},21:{x:0,y:0,z:2},22:{x:0,y:0,z:3},23:{x:0,y:0,z:0},30:{x:0,y:3,z:0},31:{x:0,y:3,z:3},32:{x:0,y:3,z:2},33:{x:0,y:3,z:1},40:{x:1,y:0,z:0},41:{x:1,y:0,z:3},42:{x:1,y:0,z:2},43:{x:1,y:0,z:1},50:{x:2,y:0,z:1},51:{x:2,y:0,z:2},52:{x:2,y:0,z:3},53:{x:2,y:0,z:0}},T={ADD:1,SELECT:2,DELETE:3,CLONE:4,MARK:5},M={PLANE:1,REGION:2,JOINED:3,DRILL:4,CUBE:5},R=[1,4,3,1,5,2],L={NONE:1,EMIT:2,SLIDE:3,CLEAR:5},D=[2,2,3,5,2,2],N={ADD:65280,SELECT:16776960,DELETE:16711680,CLONE:16711935,EMIT:5592405,SLIDE:13421772,CLEAR:16777215,DEFAULT:14540253},A=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:65280,specular:1118481,transparent:!1,shininess:100,opacity:.8}).motoSetup(),C=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:16776960,specular:1118481,transparent:!0,shininess:100,opacity:.6}).motoSetup(),O=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:16777113,specular:1118481,transparent:!0,shininess:100,opacity:.6}).motoSetup(),I=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:16759552,specular:1118481,transparent:!0,shininess:100,opacity:.8}).motoSetup(),B=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:N.SLIDE,specular:1118481,transparent:!0,shininess:100,opacity:.8}).motoSetup(),H=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:N.EMIT,specular:1118481,transparent:!0,shininess:100,opacity:.8}).motoSetup(),F=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:16777215,specular:1118481,transparent:!0,shininess:100,opacity:0}).motoSetup(),_=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,color:8978312,specular:1118481,transparent:!1,shininess:100,opacity:.6}).motoSetup(),j=new THREE.MeshBasicMaterial({color:0,opacity:.75,transparent:!0,side:THREE.DoubleSide}).motoSetup(),G={},P=[],K={},J={},U=null,$="/data/",q=null,V=null,Z=null,X=null,Y=!1,Q=!0,W=!0,ee=!1,te=null,ne=null,oe={},ie={},se={},re=null,ae="untitled",le=null,ce=0,ue=5,fe={},he=[],de=[],me=new _e,pe=0,ye=new THREE.Group,we=!1,be=new h(ye),Ee=gs_meta_debug;function xe(){p.showSkyGrid(!1),p.setSkyColor(16316664),p.init(e("container")),p.selectRecurse(!0),p.useDefaultKeys(!1),p.platform.setSize(300,300,.5),p.platform.setHiding(!0),p.platform.setHidden(!0),p.platform.setZOff(.55),p.platform.setGZOff(.3),p.platform.opacity(.2),ne=new THREE.Mesh(new THREE.PlaneBufferGeometry(.8,.8,1,1),j),p.scene.add(ne),p.platform.onHover(function(e){ne.visible=!0,ne.position.set(r(e.x),-.5,r(e.z)),ne.rotation.set(a,0,0),p.update(25)}),p.platform.onClick(function(e){Z===T.ADD&&new Ge(r(e.x),-r(e.z),0).add()}),p.mouse.downSelect(function(e,t){return ee=e&&t.metaKey,te?te.cube.boxy.children:null}),p.mouse.upSelect(function(e,t){if(!t)return de;if(!(e&&e.faceIndex>=0))return;let n=e.face.onface,o=n.cube;switch(Z){case T.MARK:o.isSynthetic()||function(e){if(X!=L.NONE){let t=X===L.CLEAR?L.NONE:X;if(Z===T.MARK){let n=ot(e,!1,V===M.PLANE?M.PLANE:M.CUBE);for(let o=0;o<n.length;o++)n[o].faces[e.key].mark=t}else e.mark=t;rt()}}(n),st();break;case T.SELECT:let i=t.shiftKey,s=t.metaKey,r=o.isSelected();i?ot(n,!0,s?M.REGION:V):r||(Je(),ot(n,!0,s?M.REGION:V)),o.isSelected()&&(te=n,st());let a=n.set,c={x:a.tx,y:a.ty,z:a.tz};p.alignTracking(e.point,c,{x:-l(a.ox),y:-l(a.oz),z:-l(a.oy)});break;case T.ADD:Je(),o.newAdjacent(n).add();break;case T.CLONE:Je(),o.newAdjacent(n).add().cloneFrom(o);break;case T.DELETE:if(o.isSynthetic())return;Je(),Pe(o)}}),p.mouse.onDrag(function(e,t,n){return t&&function(e){let t,n={x:r(e.x),y:-r(e.z),z:r(e.y)};for(t in n.ox=n.x,n.oy=n.y,n.oz=n.z,he)if(u(he,t)&&!he[t].canMoveTo(n))return;for(t in he)u(he,t)&&he[t].moveTo(n)}(t),n&&function(){rt();let e,t=he.slice();for(e=0;e<t.length;e++)t[e].dropAndUpdate(ee);if(!ee)for(e=0;e<t.length;e++)fe[t[e].key]=he[e];st()}(),te.cube.boxy}),p.mouse.onHover(function(e,t){if(!t)return de;if(e&&e.faceIndex){let t=e.face.onface,n=t.set,o=t.cube.pos;ne.rotation.set(n.rx,n.ry,n.rz),ne.position.set(o.x+1.05*n.x,o.z+1.05*n.z,-o.y-1.05*n.y),p.update(25)}});let t=moto.ui.prefix("meta"),n=e("control-left"),o=e("control-right"),i=e("assets"),s=e("control"),c=t.newButton("cube",function(){Ae(M.CUBE)}),f=t.newButton("region",function(){Ae(M.REGION)}),h=t.newButton("joined",function(){Ae(M.JOINED)}),d=t.newButton("planar",function(){Ae(M.PLANE)}),m=t.newButton("core",function(){Ae(M.DRILL)}),b=t.newButton("add",function(){Ne(T.ADD)}),E=t.newButton("delete",function(){Ne(T.DELETE)}),x=t.newButton("select",function(){Ne(T.SELECT)}),z=t.newButton("clone",function(){Ne(T.CLONE)}),g=t.newButton("mark",function(){Ne(T.MARK)}),v=t.newButton("emit",function(){Ce(L.EMIT)}),S=t.newButton("stop",function(){Ce(L.SLIDE)}),R=t.newButton("clear",function(){Ce(L.CLEAR)}),D=t.newButton("-",function(){zt(ce-1)}),N=t.newButton("+",function(){zt(ce+1)});function A(e){return e.stopImmediatePropagation(),!1}ie[M.CUBE]=c,ie[M.REGION]=f,ie[M.JOINED]=h,ie[M.PLANE]=d,ie[M.DRILL]=m,oe[T.ADD]=b,oe[T.DELETE]=E,oe[T.SELECT]=x,oe[T.CLONE]=z,oe[T.MARK]=g,se[L.EMIT]=v,se[L.SLIDE]=S,se[L.CLEAR]=R,t.newGroup("workspace",i),t.newTableRow([[t.newButton("new",wt),t.newButton("fork",St),t.newButton("save",Et)]]),t.newGroup("mode").setAttribute("title","choose adding, deleting\ncloning or selecting cubes"),t.newTableRow([[b,E],[x,z],[g]]),t.newGroup("action").setAttribute("title","action to perform on current selection"),t.newTableRow([[t.newButton("clone",$e),t.newButton("mirror",Ue)],[t.newButton("solidify",qe),t.newButton("unmesh",Qe)]]),t.newGroup("select").setAttribute("title","criteria for choosing the selection"),t.newTableRow([[c,f],[h,d],[m]]),t.newGroup("mark").setAttribute("title","mark cube faces to control\nselection and region fills"),t.newTableRow([[v,S],[R]]),t.newGroup("mesh rotate"),t.newTableRow([[t.newButton("x-",function(){ve(-1,0,0)}),t.newButton("y-",function(){ve(0,-1,0)}),t.newButton("z-",function(){ve(0,0,-1)})],[t.newButton("x+",function(){ve(1,0,0)}),t.newButton("y+",function(){ve(0,1,0)}),t.newButton("z+",function(){ve(0,0,1)})]]),t.newGroup("mesh anchor"),t.newTableRow([[t.newButton("x-",function(){ge(-1,0,0)}),t.newButton("y-",function(){ge(0,-1,0)}),t.newButton("z-",function(){ge(0,0,-1)})],[t.newButton("x+",function(){ge(1,0,0)}),t.newButton("y+",function(){ge(0,1,0)}),t.newButton("z+",function(){ge(0,0,1)})],[t.newButton("center",function(){!function(e,t,n){if(0===he.length)return;for(let o=0;o<he.length;o++)he[o].setMeshAnchor(e,t,n);p.update()}(0,0,0)})]]),t.newGroup("export").setAttribute("title","send selection to target"),t.newTableRow([[t.newButton("library",et),t.newButton("kiri",We)],[t.newButton("download",tt)]]),t.newGroup("options"),G.invert=t.newBoolean("invert zoom",ke),t.newGroup("space",s),G.name=t.newInput("name",{size:10}),G.units=t.newInput("units"),G.grid=t.newInput("grid"),G.version=t.newInput("version",{disabled:!0}),t.newTableRow([[D,N]]),t.newGroup("selection"),G.sel_x=t.newInput("width",{disabled:!0}),G.sel_y=t.newInput("depth",{disabled:!0}),G.sel_z=t.newInput("height",{disabled:!0}),G.sel_b=t.newInput("blocks",{disabled:!0}),t.newGroup("spaces"),G.models=t.newRow(),t.newGroup("import mesh"),G.libdrop=t.newButton("(drop mesh here)"),G.libdrop.id="dropbutton",t.newRow([G.libdrop]),t.newGroup("library"),G.library=t.newRow(),p.addEventHandlers(window,["keyup",Te,"keydown",Se,"keypress",Le]),p.onEnterKey([G.grid,function(e){pt(parseInt(G.grid.value))},G.name,function(e){dt(G.name.value),xt(),y[k.snames]=JSON.stringify(K),Et()},G.units,function(e){ht(G.units.value)}]),p.addEventHandlers(n,["mousemove",A,"mousedown",A,"mouseup",A]),p.addEventHandlers(o,["mousemove",A,"mousedown",A,"mouseup",A]),p.addEventHandlers(G.libdrop,["dragover",Oe,"dragleave",Ie,"drop",Be]),w.addFileListener(He),pt(ue),ke("true"===y[k.zoom]),Ae(y[k.smode]||M.REGION,!0),Ce(y[k.mmode]||L.EMIT,!0),Ne(T.SELECT),ht("1 cm"),gt(),y[k.seed]||(yt("/obj/meta-corner-1.stl","corner-1"),yt("/obj/meta-corner-2.stl","corner-2"),yt("/obj/meta-corner-3.stl","corner-3"),yt("/obj/meta-corner-4.stl","corner-4"),y[k.seed]=(new Date).getTime()),n.style.display="block",o.style.display="block"}function ke(e){void 0!==e&&(G.invert.checked=e),p.view.setZoom(y[k.zoom]=G.invert.checked)}function ze(){return n.activeElement&&n.activeElement!=n.body}function ge(e,t,n){if(0!==he.length){for(let o=0;o<he.length;o++)he[o].alterMeshAnchor(e,t,n);p.update()}}function ve(e,t,n){if(0!==he.length){for(let o=0;o<he.length;o++)he[o].rotateMesh(e,t,n);p.update()}}function Se(e){switch(e.keyCode){case 8:if(ze())return;event.preventDefault(),Ke();break;case 37:ve(0,0,-1),e.preventDefault();break;case 39:ve(0,0,1),e.preventDefault();break;case 38:e.shiftKey?ve(0,-1,0):ve(1,0,0),e.preventDefault();break;case 40:e.shiftKey?ve(0,1,0):ve(-1,0,0),e.preventDefault();break;case 65:if(ze())return;e.metaKey&&(e.preventDefault(),nt());break;case 83:e.metaKey&&(e.preventDefault(),Et());break;case 76:e.metaKey&&(e.preventDefault(),gt())}}function Te(e){if(ze())return!1;switch(e.keyCode){case 27:Je()}return!1}function Me(e){return e.charCodeAt(0)}function Re(){let e=new _e,t=0;if(he.length>0)for(;t<he.length;)e.update(he[t++].pos);else for(;t<de.length;)e.update(de[t++].cube.pos);p.platform.setMaxZ(t>0?e.z.max:0)}function Le(e){if(ze())return!1;let t,n=!0;switch(e.charCode){case Me("h"):Re(),p.view.home();break;case Me("t"):Re(),p.view.top();break;case Me("a"):Ne(T.ADD);break;case Me("s"):Ne(T.SELECT,!1,!0);break;case Me("d"):Ne(T.DELETE);break;case Me("e"):Ce(L.EMIT);break;case Me("w"):Ce(L.SLIDE);break;case Me("q"):Ce(L.CLEAR);break;case Me("c"):0===he.length?Ne(T.CLONE):$e(!1);break;case Me("m"):Ue();break;case Me("n"):window.n=[];for(let e=0;e<he.length;e++)window.n.push(he[e]);break;case Me("p"):W=!W,rt(),at();break;case Me("l"):et();break;case Me("x"):tt();break;case Me("X"):Ve(Ze(re));break;case Me("1"):e.ctrlKey?(t=ctrlLeft.style).display="none"===t.display?"block":"none":n=!1;break;case Me("2"):e.ctrlKey?(t=ctrlRight.style).display="none"===t.display?"block":"none":n=!1;break;default:n=!1}return n&&e.preventDefault(),!1}function De(e,t){let n=parseInt(t);for(let t in e){let o=e[t].classList;parseInt(t)===n?o.add("buton"):o.remove("buton")}}function Ne(e,t,o){if(n.activeElement&&n.activeElement.blur(),n.body.focus(),De(oe,e),null===e)return;let i=e==Z;if(Z=parseInt(e),t)return;let s=16777215,r=null,a=null;switch(Z){case T.ADD:s=N.ADD;break;case T.DELETE:s=N.DELETE;break;case T.SELECT:r=o&&i?R[V]:V,s=N.SELECT;break;case T.CLONE:s=N.CLONE;break;case T.MARK:a=o&&i?D[X]:X}Ae(r,!0),Ce(a,!0),st(),j.color.setHex(s),p.update()}function Ae(e,t){De(ie,e),null!=e&&(V=parseInt(e),y[k.smode]=V,t||(Ne(T.SELECT,t),st()))}function Ce(e,t){if(De(se,e),null===e)return;if(X=parseInt(e),y[k.mmode]=X,te=null,t)return;Ne(T.MARK,t),st();let n=N.SELECT;switch(X){case L.EMIT:n=N.EMIT;break;case L.SLIDE:n=N.SLIDE;break;case L.CLEAR:n=N.CLEAR}j.color.setHex(n),p.update()}function Oe(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",G.libdrop.style.backgroundColor="#8f8"}function Ie(){G.libdrop.style.backgroundColor="#ccc"}function Be(e){e.stopPropagation(),e.preventDefault(),G.libdrop.style.backgroundColor="#ccc";let t,n=e.dataTransfer.files,o=n.length<=1||confirm("add "+n.length+" objects to library?");for(t=0;o&&t<n.length;t++){if(n[t].name.toLowerCase().indexOf(".stl")<0)continue;let e=new FileReader;e.file=n[t],e.onloadend=function(e){let t=(new moto.STL).parse(e.target.result);w.putFile(e.target.file.name,t)},e.readAsBinaryString(e.file)}}function He(t){let n,o,i=G.library,s=[],r=function(e){let t=[];for(let n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort(),t}(t),a=0;r.forEach(function(e){n=(n=e.split(".")[0])>15?n.substring(0,13)+"...":n,s.push('<div><button id="slib_'+a+'" class="load">'+n+'</button><button id="dlib_'+a+'" class="del">x</button></div>'),a++}),s.push(),i.innerHTML=s.join(""),a=0,r.forEach(function(n){(o=e("slib_"+a)).onclick=function(){!function(e){if(0===he.length)return alert("no selection for mesh");Ye(e,function(e){for(let t=0;t<he.length;t++)he[t].setMesh(Xe(e));at()})}(this.filename)},o.title=n+"\rvertices: "+t[n].vertices,o.filename=n,(o=e("dlib_"+a)).onclick=function(){confirm("delete "+this.filename+"?")&&w.deleteFile(this.filename)},o.filename=n,o.title="delete",a++})}function Fe(){this.min=1/0,this.max=-1/0}function _e(){this.x=new Fe,this.y=new Fe,this.z=new Fe,this.dx=0,this.dy=0,this.dz=0,this.count=0}function je(e,t){for(let n=0;n<t.length;n+=3)e.push(new THREE.Vector3(t[n],t[n+1],t[n+2]))}function Ge(e,t,n,o){this.id=++pe,this.pos={x:e,y:t,z:n},this.key=[e,t,n].join(","),this.synth=o,this.selected=!1,this.faces={rl:this.makeFace("rl"),lr:this.makeFace("lr"),bf:this.makeFace("bf"),fb:this.makeFace("fb"),tb:this.makeFace("tb"),bt:this.makeFace("bt")},this.sides=[this.side(0,this.faces.rl),this.side(1,this.faces.lr),this.side(2,this.faces.bf),this.side(3,this.faces.fb),this.side(4,this.faces.tb),this.side(5,this.faces.bt)],this.boxy=new THREE.Object3D,this.boxy.add(this.sides[0]),this.boxy.add(this.sides[1]),this.boxy.add(this.sides[2]),this.boxy.add(this.sides[3]),this.boxy.add(this.sides[4]),this.boxy.add(this.sides[5]),this.boxy.position.set(e,t,n),this.boxy.cube=this,this.mesh=null,this.meshRotate=null,this.group=new THREE.Object3D,this.group.cube=this,this.group.add(this.boxy)}function Pe(e,t){let n=e.key;fe[n]&&(delete fe[n],p.platform.remove(e.group),he.remove(e),de.remove(e.boxy)),t||rt(),st()}function Ke(){let e=0,t=he.slice();for(;e<t.length;)Pe(t[e++]);st()}function Je(){for(let e=0;e<he.length;e++)he[e].setSelected(!1);te=null,he=[],it()}function Ue(){$e(!0)}function $e(e){if(!te)return;let t,n,o,i,s,r,a,l,c,u=[],f=0,h=te.key,d=v[te.key];for(;f<he.length;)(t=he[f++]).isSynthetic()||(n=t.pos.x,o=t.pos.y,i=t.pos.z,e&&(d.ox&&(n=me.x.min+me.x.max-n),d.oy&&(o=me.y.min+me.y.max-o),d.oz&&(i=me.z.min+me.z.max-i)),s=n+d.ox*me.dx,r=o+d.oy*me.dy,a=i+d.oz*me.dz,l||te.cube!==t||(l=t),(t=t.cloneTo(s,r,a))&&(u.push(t),!c&&l&&(c=t.faces[h]),e&&(h=h.reverse(),d.ox&&t.mirrorSwapFace("lr"),d.oy&&t.mirrorSwapFace("fb"),d.oz&&t.mirrorSwapFace("tb"))));!function(e){Je(),he=e;for(let t=0;t<e.length;t++)e[t].setSelected(!0);it()}(u),c&&(te=c),Q=!0,st()}function qe(){let e=0;for(;e<he.length;)he[e++].synth=!1;st()}function Ve(e){let t=[],n=[],o={},i={};he.forEach(e=>{e.mesh||(i[e.key]=e)}),Ee&&(be.clear(),we||p.platform.add(we=ye),ye.children.slice().forEach(e=>ye.remove(e))),he.forEach(e=>{if(!e.mesh)return;let t=0,o=e.pos,i=e.mesh.geometry.attributes.position.array;for(;t<i.length;)n.push(i[t++]+o.x),n.push(i[t++]+o.y),n.push(i[t++]+o.z)}),he.forEach(e=>{i[e.key]&&g.forEach(n=>{!function e(n,s){let r=n.cube,a=`${r.key}-${n.key}`,l=r.adjacentCube(n);if(l&&i[l.key])return!0;if(o[a])return!1;o[a]=n;let u=[],f=!s;f&&(s=[]),s.push({pos:r.pos,key:n.key,sides:u});let h=[n.key,n.key.reverse()];if(g.forEach(t=>{if(h.indexOf(t)>=0)return;let o=r.faces[t],a=r.adjacentCube(o);a&&i[a.key]?e(a.faces[n.key],s)&&u.push(t):u.push(t)}),f){let e="line"===Ee,n=[],o={};t.push({map:o,points:n}),s.forEach(t=>{let i=t.pos,s=v[t.key],r=e?.9:1,a=i.x+s.x*r,l=i.y+s.y*r,u=i.z+s.z*r;t.sides.forEach(e=>{let t=v[e],i={x:s.x==t.x?c:0,y:s.y==t.y?c:0,z:s.z==t.z?c:0};i.x*=r,i.y*=r,i.z*=r;let f=a+t.x*r,h=l+t.y*r,m=u+t.z*r,y={x:f-i.x,y:h-i.y,z:m-i.z},w={x:f+i.x,y:h+i.y,z:m+i.z};y.k=`${y.x},${y.y},${y.z}`,w.k=`${w.x},${w.y},${w.z}`;let b=o[y.k],E=o[w.k];b||(b=o[y.k]=y),E||(E=o[w.k]=w),b.p?b.p.push(E):b.p=[E],E.p?E.p.push(b):E.p=[b],n.push(b),n.push(E),"line"===Ee&&(be.poly((new d).add(y.x,y.y,y.z).add(w.x,w.y,w.z),255,!0),be.render(),p.refresh())})})}return!1}(e.faces[n],null)})});let s=[];t.forEach((e,t)=>{let{map:n,points:o}=e,i={},r=[];e:for(let e=0;e<o.length;e++){let t=o[e];if(i[t.k])continue e;let n=t,s=[n],a=[];i[n.k]=n;t:for(;;){let e=n.p;for(let t=0;t<e.length;t++){let o=e[t];if(!i[o.k]){let e=[o.x-n.x,o.y-n.y,o.z-n.z];e.equals(a)&&s.pop(),s.push(n=o),a=e,i[n.k]=n;continue t}}break}[n.x-t.x,n.y-t.y,n.z-t.z].equals([t.x-o[1].x,t.y-o[1].y,t.z-o[1].z])&&s.shift(),a.equals([t.x-n.x,t.y-n.y,t.z-n.z])&&s.pop();let l=new d;s.forEach(e=>l.add(e.x,e.y,e.z)),"poly"===Ee&&(be.poly(l.clone(),255,!0),be.render(),p.refresh()),r.push(l.ensureXY())}s.push(f.nest(r))});let r=s.flat().map(e=>e.earcut()).flat().map(e=>e.restoreXY());if("cut"===Ee&&(r.forEach(e=>be.poly(e,16711680,!0)),be.render(),p.refresh()),r.forEach(e=>{e.forEachPoint(e=>{n.push(e.x,e.y,e.z)})}),e)for(let t=0;t<n.length;t++)n[t]*=e;return{vertices:n,normals:null}}function Ze(e){let t=parseFloat(e),n=10;return(e=e.toString()).indexOf("mm")>0?n=1:e.indexOf("cm")>0?n=10:e.indexOf("in")>0?n=25.4:e.indexOf("ft")>0?n=25.4*12:e.indexOf("feet")>0?n=25.4*12:e.indexOf("yard")>0?n=25.4*12*3:e.indexOf("meter")>0?n=100:e.indexOf("m")>0&&(n=10),t*n}function Xe(e){let t=e.clone(),n=new THREE.Mesh(t,A);return t.filename=e.filename,n.filename=e.filename,n}function Ye(e,t){e&&(J[e]&&t(J[e]),w.getFile(e,function(n){if(!n)return t();let o=THREE.Geometry.fromVertices(n.slice()).unitScale().center().fixNormals();o.filename=e,t(J[e]=o)}))}function Qe(){he.forEach(function(e){e.setMesh(null)}),at()}function We(){if(0===he.length)return alert("make a selection to send");let e=Ve(Ze(re)),t=prompt("Name of Selection","");t&&t.length>0&&b.putFile(t,e.vertices.toFloat32(),function(e){e&&alert("selection sent to kiri")})}function et(){if(0===he.length)return alert("make a selection to add");let e=Ve(Ze(re)),t=prompt("Name of Selection","");t&&t.length>0&&w.putFile(t,e.vertices.toFloat32())}function tt(){if(0===he.length)return alert("make a selection to export");let e=prompt("Download Name",ae);if(!e)return;let t=Ve(Ze(re)),n=(new moto.STL).encode(t.vertices,t.normals),o=new Blob([n],{type:"application/octet-binary"});saveAs(o,e+".stl")}function nt(){he=[];for(let e=0;e<de.length;e++){let t=de[e].cube;t.setSelected(!0),he.push(t)}it()}function ot(e,t,n){let o,i,s={},r=e.cube,a=[r],l=!r.isSelected(),c=e.key,f=c.reverse(),h=[c,f],d=[],m=n||V;for(;a.length>0;)for(o in r=a.pop(),t&&r.setSelected(l),s[r.key]=r,r.faces)if(u(r.faces,o)){if(e=r.faces[o],m===M.CUBE)break;if(!(m===M.DRILL&&o!=f||m===M.PLANE&&h.contains(o))){if(m===M.REGION){if(e.mark!=L.NONE)continue;let t=r.adjacentCubeFace(e,o);if(t&&t.mark!==L.NONE)continue}if((i=r.adjacentCube(e))&&!s[i.key]){if(i.isSynthetic()&&!r.isSynthetic()&&(m===M.REGION||!t))continue;a.push(i)}}}if(t)for(o in fe)u(fe,o)&&(r=fe[o]).isSelected()&&d.push(r);else for(o in s)u(s,o)&&((r=s[o]).isSynthetic()||d.push(r));return t&&(he=d,st(),it()),d}function it(){let e=new _e;if(G.sel_b.value=he.length||"",0===he.length)G.sel_x.value="",G.sel_y.value="",G.sel_z.value="";else{let t=0;for(;t<he.length;)e.update(he[t++].pos);G.sel_x.value=e.dx,G.sel_y.value=e.dy,G.sel_z.value=e.dz}me=e}function st(){Y||(Y=setTimeout(at,10))}function rt(){let e,t,n,o=[];for(t in fe)u(fe,t)&&(n=fe[t]).isSynthetic()&&o.push(n);for(e=0;e<o.length;e++)Pe(o[e],!0);Q=!0}function at(){let e,t=0;if(Q&&W)for(;t<de.length;)de[t++].cube.addSynthetic();for(e in fe)u(fe,e)&&fe[e].updateFaces();Y=!1,Q=!1,p.update()}function lt(e){let t=0,n=e[t++],o=[n];for(;t<e.length;)o.push(n-(n=e[t++]));return o}function ct(e){let t=0,n=e[t++],o=[n];for(;t<e.length;)o.push(n-=e[t++]);return o}function ut(e){let t=[],n=null,o=e[0],i=1,s=1;for(;i<e.length;)(n=e[i++])!==o?(t.push(s),t.push(o),o=n,s=1):s++;return t.push(s),t.push(o),t}function ft(e){let t,n,o=[],i=0;for(;i<e.length;)for(t=e[i++],n=e[i++];t-- >0;)o.push(n);return o}function ht(e){re=e||"1 cm",G.units.value=re}function dt(e){ae=e||"untitled",K[le]=ae,G.name.value=ae}function mt(e){ce=Math.max(e||1,1),G.version.value=ce}function pt(e){ue=r(e),G.grid.value=e,p.platform.setGrid(ue,1),p.update()}function yt(e,t){(new moto.STL).load(e,function(e){e&&e.length>0&&w.putFile(t,e)})}function wt(){confirm("start a new workspace?")&&(le=Rt(),nt(),Ke(),pt(5),dt("newspace"),mt(1),ht("1 cm"),Mt())}function bt(){P.contains(le)||(P.push(le),K[le]=ae),y[k.workid]=le,y[k.workvr]=ce,y[k.spaces]=JSON.stringify(P),y[k.snames]=JSON.stringify(K),xt()}function Et(){let e,t,n,o=de,i=[],s=[],r=[],a=[],l=[],c=[],u=[],f=[],h=[],d=[],m=0,w=0;for(de.sort(function(e,t){return e.cube.key>t.cube.key?1:-1});w<o.length;)if(!(e=o[w++].cube).isSynthetic()){if(e.mesh){let t=e.meshRotate,n=e.mesh.filename,o=l.indexOf(n);o<0&&(o=l.length,l.push(n)),c.push(o),u.append(t.f),f.append(t.r),h.append(t.mx|t.my<<1|t.mz<<2),d.append(t.ax+1|t.ay+1<<2|t.az+1<<4)}else c.push("-");for(n=0;n<g.length;n++)t=e.faces[g[n]],a.push(t.mark||1);i.push(e.pos.x),s.push(e.pos.y),r.push(e.pos.z),m++}let b=JSON.stringify({files:l,cubes:m,px:ut(lt(i)),py:ut(lt(s)),pz:ut(lt(r)),mark:ut(a),mesh:ut(c),mfac:ut(u),mfro:ut(f),mmir:ut(h),manc:ut(d),cam:p.view.save(),grid:ue,name:ae,units:re});y[k.wspace]=b,new moto.Ajax(function(e){if(e){let t=JSON.parse(e);t&&t.ver&&(t.space!=le&&dt(ae+" new"),y[k.workid]=le=t.space,y[k.workvr]=t.ver,mt(t.ver),Mt(),bt())}else bt()}).request($+le+"/"+ce,b)}function xt(){let t,n,o,i=G.models,s=P.length-1,r=[];for(;s>=0;)t=P[s--],n=K[t]||t,r.push('<div><button id="smod_'+t+'" class="load">'+n+'</button><button id="dmod_'+t+'" class="del">x</button></div>');for(i.innerHTML=r.join(""),s=P.length-1;s>=0;)t=P[s--],n=K[t]||t,(o=e("smod_"+t)).title=n,o.model=t,o.onclick=function(){gt(this.model)},(o=e("dmod_"+t)).title=n,o.model=t,o.onclick=function(){kt(this.model)}}function kt(e){let t=P.indexOf(e);if(t>=0){if(!confirm("delete workspace "+(K[e]||e)))return;P.splice(t,1),delete K[e],y[k.spaces]=JSON.stringify(P),y[k.snames]=JSON.stringify(K)}xt()}function zt(e){gt(le,Math.max(e,1))}function gt(e,t){e?(o.hash=t?e+"/"+t:e,le=e,ce=t||ce,nt(),Ke()):p.view.load({scale:.1});let n=o.hash,i=!1;if(n.length>1){let e=n.substring(1).split("/"),t=e[0]||"",o=e[1]||"";t&&t.length>=4&&t.length<=8&&(i=!0,new moto.Ajax(function(e){if(e&&"{"===e.charAt(0)){let t=JSON.parse(e);Tt(t.rec),le=t.space,mt(t.ver),y[k.wspace]=t.rec,y[k.workid]=le,y[k.workvr]=ce,Mt(),at()}else vt()}).request($+t+"/"+o))}i||vt()}function vt(){le=y[k.workid]||Rt(),mt(y[k.workvr]||1),Tt(y[k.wspace]),Mt()}function St(){le=Rt(),mt(1),dt(ae+"_fork"),Mt(),alert("workspace forked\nsave to start a new timeline")}function Tt(e){if(Q=!0,e&&e.length>0){let t=de.slice(),n=JSON.parse(e),o=n.pos,i=n.px?ct(ft(n.px)):null,s=n.py?ct(ft(n.py)):null,r=n.pz?ct(ft(n.pz)):null,a=ft(n.mark),l=n.mesh?ft(n.mesh):null,c=n.mfac?ft(n.mfac):null,u=n.mfro?ft(n.mfro):null,f=n.mmir?ft(n.mmir):[],h=n.manc?ft(n.manc):[],d=n.files,m=n.cubes,y=n.cam,w=0,b=0,E=0,x=0,k=0;for(;k<t.length;)Pe(t[k++]);for(;m-- >0;){let e=i?new Ge(i[w],s[w],r[w++]):new Ge(o[w++],o[w++],o[w++]),t=l?l[x++]:null;for(k=0;k<g.length;k++)e.faces[g[k]].mark=a[b++];null!==t&&"-"!==t&&c&&u&&function(){let o={c:e,f:c[E],r:u[E],m:f[E],a:h[E++]};Ye(d[t],function(e){e&&(o.c.setMesh(Xe(e)),o.c.setMeshRotation(o.f,o.r),o.c.setMeshMirror(1&o.m,2&o.m?1:0,4&o.m?1:0),n.manc&&o.c.setMeshAnchor((3&o.a)-1,(o.a>>2&3)-1,(o.a>>4&3)-1),st())})}(),"number"==typeof(e.pos.x+e.pos.y+e.pos.z)&&e.add()}dt(n.name||"untitled"),ht(n.units||"1 cm"),pt(n.grid||5),p.view.reset(),y?p.view.load(y):p.view.top()}else new Ge(-1,1,0).add(),new Ge(-1,-1,0).add(),new Ge(1,-1,0).add(),new Ge(1,1,0).add(),new Ge(1,0,0).add(),new Ge(-1,0,0).add(),new Ge(0,1,0).add(),new Ge(0,-1,0).add();let t=y[k.spaces],n=y[k.snames];n&&(K=JSON.parse(n)),t&&(P=JSON.parse(t),xt())}function Mt(){U="#"+le+"/"+ce,o.hash=U,function e(){clearTimeout(q),q=setTimeout(function(){o.hash!=U&&gt(),q=null,e()},100)}()}function Rt(){for(;;){let e=Math.round(9999999999*Math.random()).toString(36);if(e.length>=4&&e.length<=8)return e}}Object.keys(z).forEach(e=>{y[e]&&(y[z[e]]=y[e],delete y[e])}),Fe.prototype.update=function(e){e<this.min&&(this.min=e),e>this.max&&(this.max=e)},x.update=function(e){this.x.update(e.x),this.y.update(e.y),this.z.update(e.z),this.count++,this.dx=this.x.max-this.x.min+1,this.dy=this.y.max-this.y.min+1,this.dz=this.z.max-this.z.min+1},x.center=function(){return{x:this.x.min+this.dx/2,y:this.y.min+this.dy/2,z:this.z.min+this.dz/2}},E.side=function(e,t){let n=.5,o=-.5,i=new THREE.Geometry;switch(e){case 0:je(i.vertices,[n,n,o,n,n,n,n,o,n,n,n,o,n,o,o,n,o,n]);break;case 1:je(i.vertices,[o,n,o,o,n,n,o,o,n,o,n,o,o,o,o,o,o,n]);break;case 2:je(i.vertices,[n,n,o,n,n,n,o,n,n,n,n,o,o,n,o,o,n,n]);break;case 3:je(i.vertices,[n,o,o,n,o,n,o,o,n,n,o,o,o,o,o,o,o,n]);break;case 4:je(i.vertices,[n,o,n,n,n,n,o,n,n,n,o,n,o,o,n,o,n,n]);break;case 5:je(i.vertices,[n,o,o,n,n,o,o,n,o,n,o,o,o,o,o,o,n,o])}let s=new THREE.Face3(0,1,2),r=new THREE.Face3(3,4,5);return s.onface=t,r.onface=t,i.faces.push(s),i.faces.push(r),i.computeFaceNormals(),i.computeVertexNormals(),new THREE.Mesh(i,A)},E.copyMesh=function(e){if(e.mesh){this.setMesh(Xe(e.mesh.geometry));let t=this.meshRotate,n=e.meshRotate;t.f=n.f,t.r=n.r,t.mx=n.mx,t.my=n.my,t.mz=n.mz,t.ax=n.ax,t.ay=n.ay,t.az=n.az}},E.setMesh=function(e){this.mesh&&this.group.remove(this.mesh),e&&(this.group.add(e),e.position.copy(this.boxy.position)),this.mesh=e,this.meshRotate={f:2,r:3,mx:0,my:0,mz:0,ax:0,ay:0,az:0}},E.updateMeshAnchor=function(e){let t=this.meshRotate;t&&(e||t.ax||t.ay||t.az)&&this.mesh.geometry.center(t.ax,t.ay,t.az)},E.alterMeshAnchor=function(e,t,n){let o=this.meshRotate;o&&this.setMeshAnchor(o.ax+e,o.ay+t,o.az+n)},E.setMeshAnchor=function(e,t,n){let o=this.meshRotate;!o||o.ax==e&&o.ay==t&&o.az==n||(o.ax=s(e,-1,1),o.ay=s(t,-1,1),o.az=s(n,-1,1),this.updateMeshAnchor(!0))},E.setMeshRotation=function(e,t){let n=S[[e,t].join("")],o=this.meshRotate;n&&(this.rotateMesh(n.x,n.y,n.z,!0),o.f=e,o.r=t)},E.setMeshMirror=function(e,t,n){let o=this.meshRotate;e!=o.mx&&(this.mesh.mirrorX(),o.mx=e),t!=o.my&&(this.mesh.mirrorY(),o.my=t),n!=o.mz&&(this.mesh.mirrorZ(),o.mz=n)},E.mirrorMesh=function(e,t,n){if(!(e||t||n))return;let o=this.meshRotate;e&&(this.mesh.mirrorX(),o.mx=1-o.mx),t&&(this.mesh.mirrorY(),o.my=1-o.my),n&&(this.mesh.mirrorZ(),o.mz=1-o.mz),this.updateMeshAnchor()},E.rotateMesh=function(e,t,n,o){if(this.mesh){if(this.mesh.geometry.applyMatrix4((new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler((-e||0)*a,(t||0)*a,(-n||0)*a))),o)return;let i=this.meshRotate,s=null,r=0;e>0?(s=[0,2,4,3,5,1],r=[1,-1,0,1,-1,0]):e<0?(s=[0,5,1,3,2,4],r=[-1,0,1,-1,0,1]):t>0?(s=[5,1,0,2,4,3],r=[0,1,-1,0,1,-1]):t<0?(s=[2,1,3,5,4,0],r=[1,-1,0,1,-1,0]):n>0?(s=[1,3,2,4,0,5],r=[1,0,1,1,0,-1]):n<0&&(s=[4,0,2,1,3,5],r=[0,1,-1,0,1,1]),0===r[i.f]?i.r=3-i.r:(i.r=i.r+r[i.f],i.r<=0&&(i.r+=4),i.r>=4&&(i.r-=4)),i.f=s[i.f],this.updateMeshAnchor()}},E.setFaceMaterial=function(e,t){this.sides[e].material=t},E.showFace=function(e,t){this.sides[e].material=t?this.sides[e].material.m_show:this.sides[e].material.m_hide},E.canMoveTo=function(e){if(!this.isSelected())return!0;let t=this.offsetCube(e);return t===this||!(this.pos.z+e.z<0)&&(!t||t.isSelected()||t.isSynthetic())},E.moveTo=function(e){this.selected&&this.group.position.set(e.x,e.y,e.z)},E.dropAndUpdate=function(e){let t=this.pos,n=this.group.position,o=(this.faces,{x:t.x+n.x,y:t.y+n.y,z:t.z+n.z});if(e)return this.group.position.set(0,0,0),this.cloneTo(o.x,o.y,o.z);if(this.boxy.position.add(n),this.mesh&&this.mesh.position.add(n),this.group.position.set(0,0,0),!delete fe[this.key])throw"missing cube @ "+this.key;return this.pos=o,this.key=[o.x,o.y,o.z].join(","),this},E.add=function(){return function(e){let t=e.key;if(!fe[t])return fe[t]=e,p.platform.add(e.group),de.push(e.boxy),st(),e;return null}(this)},E.remove=function(){Pe(this)},E.newAdjacent=function(e,t,n){let o=this.pos,i=v[e.key],s=t||1;return o.z+i.oz*s<0?null:new Ge(o.x+i.ox*s,o.y+i.oy*s,o.z+i.oz*s,n)},E.offsetPosition=function(e,t){let n=this.pos,o=t||1;return{x:n.x+e.x*o,y:n.y+e.y*o,z:n.z+e.z*o}},E.offsetCube=function(e,t){let n=this.pos,o=t||1;[n.x+e.ox*o,n.y+e.oy*o,n.z+e.oz*o].join(",");return fe[[n.x+e.ox*o,n.y+e.oy*o,n.z+e.oz*o].join(",")]},E.adjacentCube=function(e){return this.offsetCube(v[e.key])},E.adjacentCubeFace=function(e,t){let n=this.adjacentCube(e);return n?n.faces[t.reverse()]:null},E.makeFace=function(e){return{mark:L.NONE,cube:this,set:v[e],key:e}},E.mirrorSwapFace=function(e){let t=this.faces,n=e.reverse(),o=t[e].mark;if(t[e].mark=t[n].mark,t[n].mark=o,this.mesh){this.meshRotate;switch(e){case"tb":case"bt":this.mirrorMesh(0,0,1);break;case"lr":case"rl":this.mirrorMesh(1,0,0);break;case"fb":case"bf":this.mirrorMesh(0,1,0)}}},E.updateFaces=function(){let e=this.mesh;e&&(e.material=this.selected?C:A);for(let t in this.faces){if(!u(this.faces,t))continue;let n=this.selected,o=this.faces[t],i=o.cube,s=this.isSynthetic(),r=n&&o===te,a=n?C:A,l=i.adjacentCube(o),c=(i.adjacentCubeFace(o,t),l&&l.mesh),f=o.mark!=L.NONE;s&&(a=n?O:_),l&&!c&&(a=F),f&&(o.mark===L.EMIT&&(a=H),o.mark===L.SLIDE&&(a=B)),r&&(a=I),o.inside=l&&!c,i.setFaceMaterial(o.set.mi,a),i.showFace(o.set.mi,!o.inside&&(!e||f||r))}p.update()},E.clearMarks=function(){for(let e in this.faces)u(this.faces,e)&&(this.faces[e].mark=L.NONE);this.updateFaces()},E.addSynthetic=function(){for(let e in this.faces){if(!u(this.faces,e))continue;let t=this.faces[e],n=e.reverse(),o=v[t.key];if(t.mark===L.EMIT){let e,i=!1,s=[],r=1;for(;!(r>50);)if(e=this.offsetCube(o,r++)){if(!e.isSynthetic()){if(e.faces[n].mark===L.EMIT){i=!0;break}return}}else s.push(r-1);if(i)for(let e=0;e<s.length;e++)this.newAdjacent(t,s[e],!0).add()}}},E.isSynthetic=function(){return this.synth},E.isSelected=function(){return this.selected},E.setSelected=function(e){this.selected=e,st()},E.cloneTo=function(e,t,n){let o=new Ge(e,t,n).add();if(o){for(let e=0;e<g.length;e++){let t=g[e];o.faces[t].mark=this.faces[t].mark}o.copyMesh(this)}return o},E.cloneFrom=function(e){for(let t=0;t<g.length;t++){let n=g[t];this.faces[n].mark=e.faces[n].mark}this.copyMesh(e)},m.KV.__mem__&&alert("browser is blocking local storage or\n3rd party cookies required to store\napplication state."),"loading"===n.readyState?p.addEventListener(n,"DOMContentLoaded",xe,!1):xe()}();