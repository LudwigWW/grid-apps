"use strict";self.kiri||(self.kiri={});let loc=self.location,host=loc.hostname,port=loc.port,proto=loc.protocol,time=function(){return(new Date).getTime()},KIRI=self.kiri,BASE=self.base,seqid=1,running={},slicing={},worker=null;function send(e,n,i,t,o){let s=seqid++;running[s]={fn:i,async:t||!1},worker.postMessage({seq:s,task:e,time:time(),data:n},o)}KIRI.work={isSlicing:function(){let e=0;for(let n in slicing)e++;return e>0},restart:function(){worker&&worker.terminate();for(let e in slicing)slicing[e]({error:"cancelled slicing"});slicing={},running={},(worker=new Worker(`/code/worker.js?${exports.VERSION}`)).onmessage=function(e){let n=time(),i=e.data,t=running[i.seq].fn;i.done&&delete running[i.seq],i.time_recv=n-i.time_recv,t(i.data,i)}},decimate:function(e,n){send("decimate",e=e.buffer.slice(0),function(e){n(e)})},clear:function(e){send("clear",e?{id:e.id}:{},function(e){})},snap:function(e){send("snap",e,function(e){})},slice:function(e,n,i){let t,o,s=Math.PI/180*(e.process.sliceRotation||0);if(s){let e=n.getBoundingBox(!0);n._rotate(0,s,0,!0),n.center();let i=n.getBoundingBox(!0);o=(t=(i.max.z-i.min.z)/2)-(e.max.z-e.min.z)/2}let r=n.getGeoVertices().buffer.slice(0),c=KIRI.api.view.snapshot;s&&(n._rotate(0,-s,0,!0),n.center()),slicing[n.id]=i,send("slice",{id:n.id,settings:e,vertices:r,position:n.mesh.position,tracking:n.track,snapshot:c,state:{rotation:s,centerz:t,movez:o}},function(e){(e.done||e.error)&&delete slicing[n.id],i(e)},null,[r])},printSetup:function(e,n){send("printSetup",{settings:e},function(e){n(e)},void 0)},printExport:function(e,n,i){send("printExport",{settings:e},function(e){e.line&&n(e.line),e.done&&i(e.done)})},printGCode:function(e){let n=[];BASE.util.time();send("printGCode",{},function(i){i.line?n.push(i.line):(i.gcode||(i.gcode=n.join("\n")),e(i))})},sliceToGCode:function(e,n,i){n=widget.getGeoVertices().buffer.slice(0);(new Date).toString(36);send("slice",{settings:e,id:wiwd,vertices:n,position:{x:0,y:0,z:0}},function(t){send("printSetup",{settings:e},function(e){send("printGCode",{},function(e){i(e)})},null,[n]),i(t)})}},KIRI.work.restart();