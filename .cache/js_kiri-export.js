"use strict";let gs_kiri_export=exports;!function(){if(self.kiri||(self.kiri={}),self.kiri.export)return;let e=self.kiri,t=self.base.util,i=e.api,n=i.sdb,o=i.ui,r=i.stats,a=i.const.MODES,s=parseInt(n["kiri-print-seq"]||n["print-seq"]||"0")+1;function l(){let e=i.print.get();if(e)switch(i.event.emit("export",i.mode.get()),i.mode.get()){case"LASER":return c(e);case"FDM":case"CAM":return d(e);case"SLA":return p(e)}else i.function.print(l)}function p(t){if(t){if(t.exported)return void e.driver.SLA.printDownload(t);let n,o=[],r={},a=Date.now(),s=1;t.export(!0,function(e){if(e.message){if(n&&n!==e.message){let e=Date.now();r[`${s++}_${n}`]=e-a,a=e}n=e.message}e.progress&&i.show.progress(e.progress,"exporting"),e.data&&o.push(e.data)},function(l){t.exported=!0,r[`${s++}_${n}`]=Date.now()-a,console.log(r),i.show.progress(0),t.sla={lines:o,done:l,API:i},e.driver.SLA.printDownload(t)})}else i.function.print(p)}function d(e){e?e.exportGCode(!0,function(l){!function(e,l){n["kiri-print-seq"]=s++;let p,d,c,u,g,f,h=i.conf.get(),m=i.mode.get_id(),v=(m===a.CAM?"cnc-":"print-")+s.toString().padStart(3,"0"),y=h.device.gcodeFExt||"gcode",k=h.device.gcodeProc,w={};k&&self[k]&&(e=self[k](e));function x(){return new Blob([e],{type:"application/octet-stream"})}function _(){if(!p||!d)return;let e=new FormData,t=new XMLHttpRequest,o=p.value.toLowerCase(),a=d.value;0===o.indexOf("http")?!SECURE||isSecure(o)?(n["octo-host"]=o.trim(),n["octo-apik"]=a.trim(),v=$("print-filename").value,e.append("file",x(),v+"."+y),t.onreadystatechange=function(){if(4===t.readyState){let e=t.status;r.add(`ua_${i.mode.get_lower()}_print_octo_${e}`),e>=200&&e<300?i.modal.hide():i.show.alert("octoprint error\nstatus: "+e+"\nmessage: "+t.responseText)}},t.upload.addEventListener("progress",function(e){setProgress(Math.ceil(e.loaded/e.total),"sending")}),t.open("POST",o+"/api/files/local"),t.setRequestHeader("X-Api-Key",a),t.send(e)):i.show.alert("host must begin with 'https' on a secure site"):i.show.alert("host missing protocol (http:// or https://)")}function M(e,t){if(e&&"Enter"!==e.code)return;if(!t&&i.probe.local(M))return;f=t;let n=[];for(let e in t){let i=t[e];n.push(`<option id="gl-${e}" value="${e}">${i.stat.device.name}</option>`)}$("grid-local").innerHTML=n.join("\n")}function S(){let t=$("grid-local").value,n=f[t];if(n){let n=$("print-filename").value;fetch(`/api/grid_send?uuid=${t}&file=${encodeURIComponent(n+"."+y)}`,{method:"POST",body:e}).then(e=>e.text()).then(e=>{r.add(`ua_${i.mode.get_lower()}_print_local_ok`),console.log({grid_spool_said:e})}).catch(e=>{r.add(`ua_${i.mode.get_lower()}_print_local_err`),console.log({grid_local_spool_error:e})}).finally(()=>{i.modal.hide()})}}function T(){let e=f[$("grid-local").value];if(e&&e.stat&&e.stat.device){let t=e.stat.device;window.open(`http://${t.addr[0]}:${t.port||4080}`,"_grid_admin")}}function L(e,t){if(e&&"Enter"!==e.code)return;if(!c||!u)return;t&&(c.value=t);let o=new XMLHttpRequest,r=c.value,a=u.value;g.value;a||($("gpapik").style.display="none"),!r&&i.probe.grid(L)||r&&(o.onreadystatechange=function(){if(4===o.readyState)if(o.status>=200&&o.status<300){n["grid-host"]=r,n["grid-apik"]=a;let e=JSON.parse(o.responseText),t=!1,i=!1,s=null,l=[];w={};for(let o in e)s=s||o,n["grid-target"]?t=n["grid-target"]===o:(n["grid-target"]=o,t=!0),i=i||t,w[l.length]=o,l.push("<option id='gpo-'"+o+" value='"+o+"'"+(t?" selected":"")+">"+(e[o].comment||o)+"</option>");i||(n["grid-target"]=s),g.innerHTML=l.join("\n")}else 401===o.status?$("gpapik").style.display="":(n.removeItem("grid-host"),n.removeItem("grid-apik"),console.log("invalid grid:host url"))},o.open("GET",r+"/api/active?key="+a),o.send())}function A(){if(!c||!u)return;let t=new XMLHttpRequest,o=c.value,a=u.value,s=n["grid-target"]||"";if(""===s)return void i.show.alert("invalid or missing target");if(0!==o.indexOf("http"))return void i.show.alert("host missing protocol (http:// or https://)");if(o.indexOf("://")<0)return void i.show.alert("host:port malformed");if(SECURE&&!isSecure(o))return void i.show.alert("host must begin with 'https' on a secure site");n["grid-host"]=o.trim(),n["grid-apik"]=a.trim(),t.onreadystatechange=function(){if(4===t.readyState){let e=t.status;if(r.add(`ua_${i.mode.get_lower()}_print_grid_${e}`),e>=200&&e<300){let e=js2o(t.responseText);!function e(t,i){ajax(t+"/api/check?key="+i,function(n){n=js2o(n),DBUG.log(n),n.done||n.error||setTimeout(function(){e(t,i)},1e3)})}(o,e.key),i.ajax(o+"/api/wait?key="+e.key,function(e){e=js2o(e),DBUG.log(e),i.show.alert("print to "+s+": "+e.status,600)})}else i.show.alert("grid:host error\nstatus: "+e+"\nmessage: "+t.responseText,1e4);setProgress(0)}},t.upload.addEventListener("progress",function(e){setProgress(Math.ceil(e.loaded/e.total),"sending")}),v=$("print-filename").value,t.open("POST",o+"/api/print?filename="+v+"&target="+s+"&key="+a+"&time="+Math.round(l.time)+"&length="+Math.round(l.distance)+"&image="+v),t.setRequestHeader("Content-Type","text/plain");let p=i.view.snapshot;t.send(p?[e,p].join("\0"):e),i.modal.hide()}function D(){v=$("print-filename").value,saveAs(x(),v+"."+y)}function E(e){return(e=e.toString()).length<2?"0"+e:e}i.ajax("/kiri/output-gcode.html",function(e){o.print.innerHTML=e,$("print-close").onclick=i.modal.hide,$("print-download").onclick=D,$("print-octoprint").onclick=_,$("print-gridhost").onclick=A,$("print-gridlocal").onclick=S,$("admin-gridlocal").onclick=T,$("print-filament-row").style.display=m===a.FDM?"":"none",$("mill-info").style.display=m===a.CAM?"":"none",$("print-filename").value=v,$("print-filesize").value=t.comma(l.bytes),$("print-filament").value=Math.round(l.distance),$("grid-host").onkeyup=L,$("grid-apik").onkeyup=L,function(){let e=Math.floor,t=e(l.time),i=e(t/3600),n=t-3600*i,o=e(n/60),r=n-60*o;$("mill-time").value=$("print-time").value=[E(i),E(o),E(r)].join(":")}(),m===a.FDM&&function e(){try{let i=$("print-density");$("print-weight").value=(Math.PI*t.sqr(l.settings.device.extruders[0].extFilament/2)*l.distance*(parseFloat(i.value)||1.25)/1e3).toFixed(2),i.onkeyup=(t=>{"Enter"===t.key&&e()})}catch(e){}}(),p=$("octo-host"),d=$("octo-apik"),m===a.CAM?$("send-to-octoprint").style.display="none":$("send-to-octoprint").style.display="",i.const.OCTO&&($("ophost").style.display="none",$("opapik").style.display="none",$("ophint").style.display="none",$("send-to-gridhost").style.display="none"),p.value=n["octo-host"]||"",d.value=n["octo-apik"]||"",c=$("grid-host"),u=$("grid-apik"),(g=$("grid-target")).onchange=function(e){n["grid-target"]=w[g.selectedIndex]},c.value=n["grid-host"]||"",u.value=n["grid-apik"]||"",L(),M(),i.modal.show("print")})}(l,e)}):i.function.print(l)}function c(e){if(!e)return i.function.print(c);let n="laser-"+(new Date).getTime().toString(36);function r(){saveAs(new Blob([e.exportSVG()],{type:"application/octet-stream"}),$("print-filename").value+".svg")}function a(){saveAs(new Blob([e.exportDXF()],{type:"application/octet-stream"}),$("print-filename").value+".dxf")}function s(){saveAs(new Blob([e.exportLaserGCode()],{type:"application/octet-stream"}),$("print-filename").value+".gcode")}i.ajax("/kiri/output-laser.html",function(l){let p=0;e.output.forEach(e=>{p+=e.length}),o.print.innerHTML=l,$("print-filename").value=n,$("print-lines").value=t.comma(p),$("print-close").onclick=i.modal.hide,$("print-svg").onclick=r,$("print-dxf").onclick=a,$("print-lg").onclick=s,i.modal.show("print")})}e.export=l}();